# モールス練習アプリ - プロジェクトコンテキスト

このドキュメントは、Claude Codeがプロジェクトを理解するための情報を記録します。
次回以降のセッションでトークン消費を抑えるため、重要な情報を集約しています。

## プロジェクト概要

モールス符号の学習・練習を支援するWebアプリケーションです。
複数のバージョン(v1-v8)が開発されており、v8が最新版(PWA対応)です。

## ディレクトリ構造

```
morse/
├── v1/                    # 初期実装版
├── v2/                    # TypeScript再実装版
├── v3/                    # v2の改良版
├── v4/                    # 単一HTML版
├── v5/                    # QSO聞き取り練習版
├── v6/                    # コッホ法マルチモード版
├── v7/                    # モールス信号聞き取り練習版
├── v8/                    # PWA版（最新）
│   ├── src/              # TypeScriptソースコード
│   │   ├── core/         # コアモジュール（ルーター、セキュリティなど）
│   │   ├── modes/        # 各練習モード
│   │   │   ├── menu/     # メニューページ
│   │   │   ├── vertical/ # 縦振り電鍵練習
│   │   │   ├── horizontal/ # 横振り電鍵練習
│   │   │   ├── flashcard/ # CW略語・Q符号学習
│   │   │   ├── koch/     # コッホ法訓練
│   │   │   └── listening/ # モールス信号聞き取り練習
│   │   └── shared/       # 共通モジュール（音声、モールス変換など）
│   ├── dist/             # ビルド済みファイル（PWA対応）
│   ├── public/           # 静的リソース（アイコンなど）
│   ├── flashcard.tsv     # CW略語データ
│   ├── manifest.webmanifest # PWAマニフェスト
│   ├── sw.js             # Service Worker
│   └── README.md         # v8の詳細ドキュメント
├── flashcard.tsv         # 元データ
├── index.html            # トップページ（v8へのリダイレクト）
└── .claude/
    └── context.md        # このファイル
```

## v8アーキテクチャ（最新版）

### ビルドシステム
- **技術スタック**: TypeScript + Vite + PWA
- **出力形式**: SPAアプリ（ハッシュルーティング）
- **ビルドコマンド**: `npm run build` (v8/src/ で実行)
- **PWA対応**:
  - vite-plugin-pwa使用
  - Service Workerによるオフライン対応
  - プリキャッシュ戦略で全アセットをキャッシュ
  - インストール可能（manifest.webmanifest）

### コアモジュール (v8/src/core/)
- **router.ts**: ハッシュベースSPAルーティングシステム
  - モード切り替え、エラーハンドリング
  - XSS保護された エラー表示
- **html-sanitizer.ts**: XSS保護ユーティリティ（新規）
  - escapeHtml(), escapeAttribute() などの安全なHTML生成関数

### 共通モジュール (v8/src/shared/)
- **audio-system.ts**: Web Audio APIを使った音声再生システム
  - モールス音の生成（連続音/パターン音）
  - 周波数・音量・WPM設定に対応
- **settings.ts**: LocalStorageベースの設定管理
- **morse-code.ts**: モールス符号変換
  - textToMorse(), morseToText() などの変換関数

### 各ページの概要

#### 1. メニューページ (menu/)
- v4のトップページ
- 各機能へのリンク集
- カードレイアウトで表示

#### 2. 縦振り電鍵練習 (vertical/)
- 縦振り電鍵のシミュレーター
- スペースキーまたはタップで操作
- リアルタイムでモールス音を再生

#### 3. 横振り電鍵練習 (horizontal/)
- 横振り電鍵のシミュレーター
- 左右のキー（A/L）またはタップで操作
- **既知の問題**: v2との動作乖離あり（TODO.md参照）

#### 4. CW略語・Q符号学習 (flashcard/)
**v3と同等の機能を実装完了**:
- flashcard.tsvからデータ読み込み
- タグベースフィルタリング
- 使用頻度フィルタリング（1-5段階）
- 使用頻度の星表示（★☆）
- prosign表示対応（[AR]などをオーバーライン表示）
- 表示モード切り替え:
  - カード表示: グリッドレイアウトで見やすく表示
  - リスト表示: v3互換のテーブル形式
- **学習モード**:
  - カードめくり機能（3Dフリップアニメーション）
  - キーボードショートカット（Space: めくる、矢印: ナビゲーション）
  - 「わかる」「わからない」判定ボタン
  - 復習モード（わからないカードのみ抽出）
  - モールス符号再生機能
- **LocalStorage統合**:
  - 学習進捗の保存（わかる/わからない）
  - フィルタ設定の保存
  - 進捗リセット機能

**将来実装予定** (TODO.md参照):
- 試験モード（ランダム出題、4択問題）
- 統計機能（正答率、学習カレンダー）

**データ構造** (flashcard.tsv):
```
tags	frequency	abbreviation	english	japanese
Q符号	5	QTH	Location	こちらの位置は
...
```

#### 5. コッホ法トレーニング (koch/)
- コッホ法によるモールス符号学習（41文字を段階的に習得）
- **実装内容**:
  - 基本学習モード: レッスンベースで段階的に学習
  - 任意文字列練習モード: 自由に文字を選択して練習
  - 文字選択状態の永続化（LocalStorage）
  - タブ選択状態の永続化

#### 6. モールス信号聞き取り練習 (listening/)
- ラバースタンプQSO、ランダムQSO生成
- 英文聞き取り練習（100/200/300語）
- カスタム文章の聞き取り練習
- カテゴリータブ選択状態の永続化（LocalStorage）

## 最近の変更履歴

### 2025-10-10
1. **v8 PWA化完了**
   - v7をベースにPWA機能を実装
   - Service Workerによるオフライン対応
   - アプリとしてインストール可能
   - プリキャッシュ戦略でパフォーマンス向上

2. **セキュリティ強化**
   - XSS保護機能を実装（html-sanitizer.ts）
   - innerHTML使用箇所のエスケープ処理
   - ルーターエラーメッセージの安全化
   - フラッシュカードTSVデータのエスケープ

3. **状態永続化の実装**
   - 全モードでタブ選択状態をLocalStorageに保存
   - フラッシュカード: viewMode, learnQuestionType, questionType
   - コッホ法: viewMode, selectedChars
   - 聞き取り練習: currentCategory
   - ページリロード後も状態を復元

4. **UI改善**
   - 聞き取り練習の空状態表示を改善（白背景カード追加）
   - コッホ法の文字数表記を修正（40文字→41文字）

### 2025-10-06
1. **トップページデザイン刷新**
   - v4風のカードレイアウトに変更
   - グリッドレイアウトでレスポンシブ対応

## 開発ガイドライン

### コーディング規約
- インデント: タブ使用
- コメント: 日本語で記述、必ず句点(。)をつける
- TypeScript: 関数ごとに分割、型定義を明確に

### Git運用
- コミットメッセージ: Angular Conventional Commit形式、日本語
- ブランチ: 基本的にmasterで開発（現状）
- コミット粒度: 適度な粒度で機能単位

### ビルド・デプロイ
- 開発時: `npm run dev` (v8/src/)
- ビルド: `npm run build` (v8/src/)
- 出力先: v8/dist/（SPAアプリ + Service Worker）

## 重要な設計判断

1. **PWA化（v8）**
   - Service Workerによるオフライン対応
   - アプリとしてインストール可能
   - プリキャッシュ戦略で高速起動
   - ネイティブアプリのような体験

2. **LocalStorage活用**
   - 設定の永続化（音量、周波数、WPMなど）
   - タブ選択状態の保存
   - 学習進捗の保存
   - フィルタ設定の永続化

3. **Web Audio API使用**
   - モールス音の生成
   - 精密なタイミング制御が可能
   - リアルタイム音声処理

4. **セキュリティ対策**
   - XSS保護（HTMLエスケープ）
   - 安全なDOM操作
   - 外部データの検証

## TODO: 優先度が高いタスク

詳細はv8/TODO.mdを参照。主要なものは:

1. PWA機能の拡張（プッシュ通知、バックグラウンド同期など）
2. 統計・可視化機能（学習カレンダー、進捗グラフなど）
3. テストの追加（現在2/10の評価）
4. アクセシビリティ改善（現在3/10の評価）

## トラブルシューティング

### ビルドエラー
- **現象**: npm run buildが失敗
- **原因**: v8/src/でコマンドを実行していない
- **解決**: `cd v8/src && npm run build`

### 音が出ない
- **原因**: AudioContextの初期化タイミング
- **解決**: ユーザーインタラクション後に初期化（実装済み）

## 参考リンク

- Web Audio API: https://developer.mozilla.org/ja/docs/Web/API/Web_Audio_API
- Vite: https://vitejs.dev/
- コッホ法: モールス符号学習の段階的手法

## v8のコード品質評価（2025-10-10時点）

- **総合評価**: 68/100 (B)
- **優れている点**:
  - アーキテクチャ: 9/10（モジュール分割、ルーティング）
  - TypeScript安全性: 9/10（strict mode、型定義）
  - PWA実装: 9/10（オフライン対応、インストール可能）
  - パフォーマンス: 8/10（プリキャッシュ、最適化）
- **改善が必要な点**:
  - テスト: 2/10（ユニットテスト未実装）
  - アクセシビリティ: 3/10（キーボードナビゲーション、ARIA属性不足）
  - セキュリティ: 6/10（基本的なXSS対策は実装済み）
  - ドキュメント: 6/10（READMEあり、コメント充実、API仕様書なし）

---

**更新日**: 2025-10-10
**最終更新者**: Claude Code
