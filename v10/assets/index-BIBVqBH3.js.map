{"version":3,"file":"index-BIBVqBH3.js","sources":["../../src/ui/views/MenuView.ts","../../src/ui/views/VerticalKeyView.ts","../../src/ui/views/HorizontalKeyView.ts","../../src/utils/flashcard-loader.ts","../../src/ui/views/FlashcardView.ts","../../src/ui/views/KochView.ts","../../src/ui/views/ListeningView.ts","../../src/utils/download-helper.ts","../../src/router/index.ts","../../src/main.ts"],"sourcesContent":["/**\n * メニュービュー\n */\n\nimport type { View } from '../../router';\n\n/**\n * メニュー項目の定義\n */\ninterface MenuItem {\n\tid: string;\n\ttitle: string;\n\tdescription: string;\n\troute: string;\n}\n\n/**\n * メニュービュークラス\n */\nexport class MenuView implements View {\n\tprivate menuItems: MenuItem[] = [\n\t\t{\n\t\t\tid: 'vertical',\n\t\t\ttitle: '縦振り電鍵練習',\n\t\t\tdescription: '上下に動かす電鍵（ストレートキー）の練習',\n\t\t\troute: 'vertical'\n\t\t},\n\t\t{\n\t\t\tid: 'horizontal',\n\t\t\ttitle: '横振り電鍵練習',\n\t\t\tdescription: '左右に動かす電鍵（パドル）の練習（Iambic A/B対応）',\n\t\t\troute: 'horizontal'\n\t\t},\n\t\t{\n\t\t\tid: 'flashcard',\n\t\t\ttitle: 'CW略語・Q符号',\n\t\t\tdescription: 'CW通信で使用される略語とQ符号を学習',\n\t\t\troute: 'flashcard'\n\t\t},\n\t\t{\n\t\t\tid: 'koch',\n\t\t\ttitle: 'コッホ法トレーニング',\n\t\t\tdescription: '段階的に文字を増やして学習する方式',\n\t\t\troute: 'koch'\n\t\t},\n\t\t{\n\t\t\tid: 'listening',\n\t\t\ttitle: 'モールス信号聞き取り練習',\n\t\t\tdescription: 'ランダムQSOや英文を聞いて練習',\n\t\t\troute: 'listening'\n\t\t}\n\t];\n\n\t/**\n\t * ビューをレンダリングする\n\t */\n\trender(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"menu-header\">\n\t\t\t\t\t<h1>モールス練習アプリ</h1>\n\t\t\t\t\t<p class=\"version\">v10 - Engine/GUI分離版</p>\n\t\t\t\t</header>\n\n\t\t\t\t<main class=\"menu-main\">\n\t\t\t\t\t<div class=\"menu-grid\">\n\t\t\t\t\t\t${this.menuItems.map(item => this.renderMenuItem(item)).join('')}\n\t\t\t\t\t</div>\n\t\t\t\t</main>\n\n\t\t\t\t<footer class=\"menu-footer\">\n\t\t\t\t\t<p>&copy; 2025 モールス練習アプリ</p>\n\t\t\t\t</footer>\n\t\t\t</div>\n\t\t`;\n\n\t\t//! イベントリスナーを設定。\n\t\tthis.attachEventListeners();\n\t}\n\n\t/**\n\t * メニュー項目を描画する\n\t */\n\tprivate renderMenuItem(item: MenuItem): string {\n\t\treturn `\n\t\t\t<div class=\"menu-item\" data-route=\"${item.route}\">\n\t\t\t\t<h2 class=\"menu-item-title\">${item.title}</h2>\n\t\t\t\t<p class=\"menu-item-description\">${item.description}</p>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t/**\n\t * イベントリスナーを設定する\n\t */\n\tprivate attachEventListeners(): void {\n\t\tconst menuItems = document.querySelectorAll('.menu-item');\n\t\tmenuItems.forEach(item => {\n\t\t\titem.addEventListener('click', () => {\n\t\t\t\tconst route = item.getAttribute('data-route');\n\t\t\t\tif (route) {\n\t\t\t\t\twindow.location.hash = `#${route}`;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * ビューを破棄する\n\t */\n\tdestroy(): void {\n\t\t//! イベントリスナーは新しいHTMLで上書きされるため、特に処理不要。\n\t}\n}\n","/**\n * 縦振り電鍵練習ビュー\n */\n\nimport type { View } from '../../router';\nimport {\n\tVerticalKeyTrainer,\n\tMorseBuffer,\n\tTimerManager,\n\tTimingCalculator,\n\tAudioGenerator\n} from 'morse-engine';\nimport { SettingsModal, ALL_SETTING_ITEMS, type SettingValues } from 'morse-engine';\n\n/**\n * 縦振り電鍵練習ビュークラス\n */\nexport class VerticalKeyView implements View {\n\tprivate trainer: VerticalKeyTrainer;\n\tprivate buffer: MorseBuffer;\n\tprivate timer: TimerManager;\n\tprivate audio: AudioGenerator;\n\tprivate isKeyPressed = false;\n\tprivate keyPressHandler: ((e: KeyboardEvent) => void) | null = null;\n\tprivate keyReleaseHandler: ((e: KeyboardEvent) => void) | null = null;\n\tprivate updateIntervalId: number | null = null;\n\tprivate currentWPM = 20;\n\tprivate keyCode = 'Space';\n\n\tconstructor() {\n\t\t//! 設定を読み込む。\n\t\tconst savedWPM = localStorage.getItem('verticalKeyWPM');\n\t\tif (savedWPM) {\n\t\t\tthis.currentWPM = parseInt(savedWPM, 10);\n\t\t}\n\n\t\tconst savedKeyCode = localStorage.getItem('verticalKeyCode');\n\t\tif (savedKeyCode) {\n\t\t\tthis.keyCode = savedKeyCode;\n\t\t}\n\n\t\t//! コアコンポーネントを初期化。\n\t\tthis.buffer = new MorseBuffer();\n\t\tthis.timer = new TimerManager();\n\t\tthis.audio = new AudioGenerator({\n\t\t\tfrequency: 700,\n\t\t\tvolume: 0.5,\n\t\t\twpm: this.currentWPM\n\t\t});\n\n\t\t//! タイミング計算。\n\t\tconst timings = TimingCalculator.calculate(this.currentWPM);\n\n\t\t//! トレーナーを初期化（コールバックで音声制御）。\n\t\tthis.trainer = new VerticalKeyTrainer(\n\t\t\tthis.buffer,\n\t\t\tthis.timer,\n\t\t\ttimings,\n\t\t\t{\n\t\t\t\tonKeyPress: () => {\n\t\t\t\t\t//! キー押下時に音を鳴らす。\n\t\t\t\t\tthis.audio.startContinuousTone();\n\t\t\t\t},\n\t\t\t\tonKeyRelease: () => {\n\t\t\t\t\t//! キー解放時に音を止める。\n\t\t\t\t\tthis.audio.stopContinuousTone();\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\t/**\n\t * ビューをレンダリングする\n\t */\n\trender(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t<h1>縦振り電鍵練習</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"key-button-container\">\n\t\t\t\t\t<button class=\"key-button\" id=\"morse-key\">\n\t\t\t\t\t\tKEY\n\t\t\t\t\t\t<span class=\"key-label\">(クリック/タップで送信)</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"practice-container\">\n\t\t\t\t\t<div class=\"display-area\">\n\t\t\t\t\t\t<div class=\"display-section\">\n\t\t\t\t\t\t\t<h3>モールス信号</h3>\n\t\t\t\t\t\t\t<div class=\"display-output morse-buffer\" id=\"morse-buffer\">（ここにモールス符号が表示されます）</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"display-section\">\n\t\t\t\t\t\t\t<h3>デコード結果</h3>\n\t\t\t\t\t\t\t<div class=\"display-output\" id=\"decoded-text\">（ここにデコードされた文字が表示されます）</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"action-area\">\n\t\t\t\t\t\t<button class=\"btn btn-large btn-danger\" id=\"clear-btn\">クリア</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"status-area\">\n\t\t\t\t\t\t<div class=\"status-item\">\n\t\t\t\t\t\t\t<span class=\"label\">現在の速度</span>\n\t\t\t\t\t\t\t<span class=\"value\" id=\"current-wpm\">${this.currentWPM}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"status-item\" id=\"key-status\">\n\t\t\t\t\t\t\t<span class=\"label\">キー状態</span>\n\t\t\t\t\t\t\t<span class=\"value\">解放</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"status-item\">\n\t\t\t\t\t\t\t<span class=\"label\">入力文字数</span>\n\t\t\t\t\t\t\t<span class=\"value\" id=\"char-count\">0</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>スペースキーまたは画面のボタンを押している間、モールス信号が送信されます</li>\n\t\t\t\t\t\t\t<li>短く押すと「・」(dit)、長く押すと「ー」(dah)になります</li>\n\t\t\t\t\t\t\t<li>文字間は自動的に判定されます</li>\n\t\t\t\t\t\t\t<li>WPM（Words Per Minute）で速度を調整できます</li>\n\t\t\t\t\t\t\t<li>画面右上の⚙アイコンから音量・周波数・速度を調整できます</li>\n\t\t\t\t\t\t\t<li>音声が鳴らない場合は、一度ボタンをクリックしてください（ブラウザのオーディオポリシー）</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\t//! イベントリスナーを設定。\n\t\tthis.attachEventListeners();\n\t\t//! 定期更新を開始。\n\t\tthis.startUpdate();\n\t}\n\n\t/**\n\t * イベントリスナーを設定する\n\t */\n\tprivate attachEventListeners(): void {\n\t\t//! 戻るボタン。\n\t\tconst backBtn = document.querySelector('.back-btn');\n\t\tbackBtn?.addEventListener('click', () => {\n\t\t\twindow.location.hash = '#menu';\n\t\t});\n\n\t\t//! 設定アイコン。\n\t\tdocument.getElementById('settingsIcon')?.addEventListener('click', () => {\n\t\t\tthis.openSettingsModal();\n\t\t});\n\n\t\t//! クリアボタン。\n\t\tconst clearBtn = document.getElementById('clear-btn');\n\t\tclearBtn?.addEventListener('click', () => {\n\t\t\tthis.trainer.clear();\n\t\t\tthis.updateDisplay();\n\t\t});\n\n\t\t//! キーボードイベント（設定されたキー）。\n\t\tthis.keyPressHandler = (e: KeyboardEvent) => {\n\t\t\tif (e.code === this.keyCode && !e.repeat) {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (!this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyDown();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tthis.keyReleaseHandler = (e: KeyboardEvent) => {\n\t\t\tif (e.code === this.keyCode) {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyUp();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\twindow.addEventListener('keydown', this.keyPressHandler);\n\t\twindow.addEventListener('keyup', this.keyReleaseHandler);\n\n\t\t//! ボタンイベント（マウス/タッチ）。\n\t\tconst keyButton = document.getElementById('morse-key');\n\t\tif (keyButton) {\n\t\t\t//! マウスイベント。\n\t\t\tkeyButton.addEventListener('mousedown', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (!this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyDown();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tkeyButton.addEventListener('mouseup', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyUp();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tkeyButton.addEventListener('mouseleave', () => {\n\t\t\t\tif (this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyUp();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t//! タッチイベント。\n\t\t\tkeyButton.addEventListener('touchstart', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (!this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyDown();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tkeyButton.addEventListener('touchend', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyUp();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tkeyButton.addEventListener('touchcancel', () => {\n\t\t\t\tif (this.isKeyPressed) {\n\t\t\t\t\tthis.handleKeyUp();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * キー押下処理\n\t */\n\tprivate handleKeyDown(): void {\n\t\tthis.isKeyPressed = true;\n\t\tthis.trainer.keyPress();\n\t\tthis.updateKeyStatus(true);\n\n\t\t//! ボタンの見た目を更新。\n\t\tconst keyButton = document.getElementById('morse-key');\n\t\tif (keyButton) {\n\t\t\tkeyButton.classList.add('pressed');\n\t\t}\n\t}\n\n\t/**\n\t * キー解放処理\n\t */\n\tprivate handleKeyUp(): void {\n\t\tthis.isKeyPressed = false;\n\t\tthis.trainer.keyRelease();\n\t\tthis.updateKeyStatus(false);\n\n\t\t//! ボタンの見た目を更新。\n\t\tconst keyButton = document.getElementById('morse-key');\n\t\tif (keyButton) {\n\t\t\tkeyButton.classList.remove('pressed');\n\t\t}\n\t}\n\n\t/**\n\t * 定期更新を開始する\n\t */\n\tprivate startUpdate(): void {\n\t\t//! 100msごとに画面を更新。\n\t\tthis.updateIntervalId = window.setInterval(() => {\n\t\t\tthis.updateDisplay();\n\t\t}, 100);\n\t}\n\n\t/**\n\t * 表示を更新する\n\t */\n\tprivate updateDisplay(): void {\n\t\tconst morseBuffer = document.getElementById('morse-buffer');\n\t\tconst decodedText = document.getElementById('decoded-text');\n\t\tconst charCount = document.getElementById('char-count');\n\n\t\tif (morseBuffer) {\n\t\t\tconst buffer = this.trainer.getBuffer();\n\t\t\tconst sequence = this.trainer.getSequence();\n\t\t\tconst fullDisplay = sequence ? `${buffer} ${sequence}` : buffer;\n\t\t\tmorseBuffer.textContent = fullDisplay || '（ここにモールス符号が表示されます）';\n\t\t}\n\n\t\tif (decodedText) {\n\t\t\tconst text = this.trainer.getDecoded();\n\t\t\tdecodedText.textContent = text || '（ここにデコードされた文字が表示されます）';\n\t\t}\n\n\t\tif (charCount) {\n\t\t\tconst text = this.trainer.getDecoded();\n\t\t\tcharCount.textContent = text.length.toString();\n\t\t}\n\t}\n\n\t/**\n\t * キー状態表示を更新する\n\t */\n\tprivate updateKeyStatus(isPressed: boolean): void {\n\t\tconst keyStatus = document.getElementById('key-status');\n\t\tif (keyStatus) {\n\t\t\tconst valueSpan = keyStatus.querySelector('.value');\n\t\t\tif (valueSpan) {\n\t\t\t\tvalueSpan.textContent = isPressed ? '押下中' : '解放';\n\t\t\t}\n\t\t\tif (isPressed) {\n\t\t\t\tkeyStatus.classList.add('active');\n\t\t\t} else {\n\t\t\t\tkeyStatus.classList.remove('active');\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * 設定モーダルを開く\n\t */\n\tprivate openSettingsModal(): void {\n\t\t//! 現在の設定値を取得。\n\t\tconst currentValues: SettingValues = {\n\t\t\tvolume: Math.round(this.audio.getVolume() * 100),\n\t\t\tfrequency: this.audio.getFrequency(),\n\t\t\twpm: this.currentWPM,\n\t\t\tkeyCode: this.keyCode\n\t\t};\n\n\t\t//! 設定変更前の値を保存（キャンセル時の復元用）。\n\t\tconst savedSettings = {\n\t\t\tvolume: this.audio.getVolume(),\n\t\t\tfrequency: this.audio.getFrequency(),\n\t\t\twpm: this.currentWPM,\n\t\t\tkeyCode: this.keyCode\n\t\t};\n\n\t\t//! SettingsModalを作成。\n\t\tconst modal = new SettingsModal(\n\t\t\t'vertical-key-settings-modal',\n\t\t\tALL_SETTING_ITEMS,\n\t\t\tcurrentValues,\n\t\t\t{\n\t\t\t\tonSave: (values: SettingValues) => {\n\t\t\t\t\t//! 設定を保存。\n\t\t\t\t\tthis.audio.setVolume((values.volume as number) / 100);\n\t\t\t\t\tthis.audio.setFrequency(values.frequency as number);\n\t\t\t\t\tthis.audio.setWPM(values.wpm as number);\n\t\t\t\t\tthis.currentWPM = values.wpm as number;\n\t\t\t\t\tthis.keyCode = values.keyCode as string;\n\n\t\t\t\t\t//! localStorageに保存。\n\t\t\t\t\tlocalStorage.setItem('verticalKeyWPM', this.currentWPM.toString());\n\t\t\t\t\tlocalStorage.setItem('verticalKeyCode', this.keyCode);\n\n\t\t\t\t\t//! タイミングを再計算してトレーナーを再初期化。\n\t\t\t\t\tconst timings = TimingCalculator.calculate(this.currentWPM);\n\t\t\t\t\tthis.trainer = new VerticalKeyTrainer(\n\t\t\t\t\t\tthis.buffer,\n\t\t\t\t\t\tthis.timer,\n\t\t\t\t\t\ttimings,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tonKeyPress: () => {\n\t\t\t\t\t\t\t\tthis.audio.startContinuousTone();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonKeyRelease: () => {\n\t\t\t\t\t\t\t\tthis.audio.stopContinuousTone();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\t//! 現在のWPM表示を更新。\n\t\t\t\t\tconst currentWpmDisplay = document.getElementById('current-wpm');\n\t\t\t\t\tif (currentWpmDisplay) currentWpmDisplay.textContent = this.currentWPM.toString();\n\t\t\t\t},\n\t\t\t\tonCancel: () => {\n\t\t\t\t\t//! 設定を元に戻す。\n\t\t\t\t\tthis.audio.setVolume(savedSettings.volume);\n\t\t\t\t\tthis.audio.setFrequency(savedSettings.frequency);\n\t\t\t\t\tthis.audio.setWPM(savedSettings.wpm);\n\t\t\t\t\tthis.currentWPM = savedSettings.wpm;\n\t\t\t\t\tthis.keyCode = savedSettings.keyCode;\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\t//! モーダルを表示。\n\t\tmodal.show('vertical-key');\n\t}\n\n\t/**\n\t * ビューを破棄する\n\t */\n\tdestroy(): void {\n\t\t//! イベントリスナーを削除。\n\t\tif (this.keyPressHandler) {\n\t\t\twindow.removeEventListener('keydown', this.keyPressHandler);\n\t\t\tthis.keyPressHandler = null;\n\t\t}\n\t\tif (this.keyReleaseHandler) {\n\t\t\twindow.removeEventListener('keyup', this.keyReleaseHandler);\n\t\t\tthis.keyReleaseHandler = null;\n\t\t}\n\n\t\t//! 定期更新を停止。\n\t\tif (this.updateIntervalId !== null) {\n\t\t\tclearInterval(this.updateIntervalId);\n\t\t\tthis.updateIntervalId = null;\n\t\t}\n\n\t\t//! 音声を停止。\n\t\tthis.audio.stopContinuousTone();\n\n\t\t//! トレーナーをクリア。\n\t\tthis.trainer.clear();\n\t}\n}\n","/**\n * 横振り電鍵練習ビュー\n */\n\nimport type { View } from '../../router';\nimport {\n\tHorizontalKeyTrainer,\n\tMorseBuffer,\n\tTimerManager,\n\tTimingCalculator,\n\tAudioGenerator,\n\ttype IambicMode,\n\ttype PaddleLayout\n} from 'morse-engine';\nimport { SettingsModal, ALL_SETTING_ITEMS, type SettingValues } from 'morse-engine';\n\n/**\n * 横振り電鍵練習ビュークラス\n */\nexport class HorizontalKeyView implements View {\n\tprivate trainer!: HorizontalKeyTrainer;\n\tprivate buffer: MorseBuffer;\n\tprivate timer: TimerManager;\n\tprivate audio: AudioGenerator;\n\tprivate leftPressed = false;\n\tprivate rightPressed = false;\n\tprivate updateIntervalId: number | null = null;\n\tprivate currentWPM = 20;\n\tprivate iambicMode: IambicMode = 'B';\n\tprivate paddleLayout: PaddleLayout = 'normal';\n\tprivate leftKeyCode = 'KeyJ';\n\tprivate rightKeyCode = 'KeyK';\n\n\t// イベントハンドラーの参照を保持\n\tprivate keyPressHandler: ((e: KeyboardEvent) => void) | null = null;\n\tprivate keyReleaseHandler: ((e: KeyboardEvent) => void) | null = null;\n\n\tconstructor() {\n\t\t//! 設定を読み込む。\n\t\tconst savedWPM = localStorage.getItem('horizontalKeyWPM');\n\t\tif (savedWPM) {\n\t\t\tthis.currentWPM = parseInt(savedWPM, 10);\n\t\t}\n\n\t\tconst savedIambicMode = localStorage.getItem('horizontalKeyIambicMode');\n\t\tif (savedIambicMode === 'A' || savedIambicMode === 'B') {\n\t\t\tthis.iambicMode = savedIambicMode;\n\t\t}\n\n\t\tconst savedPaddleLayout = localStorage.getItem('horizontalKeyPaddleLayout');\n\t\tif (savedPaddleLayout === 'normal' || savedPaddleLayout === 'reversed') {\n\t\t\tthis.paddleLayout = savedPaddleLayout;\n\t\t}\n\n\t\tconst savedLeftKeyCode = localStorage.getItem('horizontalKeyLeftCode');\n\t\tif (savedLeftKeyCode) {\n\t\t\tthis.leftKeyCode = savedLeftKeyCode;\n\t\t}\n\n\t\tconst savedRightKeyCode = localStorage.getItem('horizontalKeyRightCode');\n\t\tif (savedRightKeyCode) {\n\t\t\tthis.rightKeyCode = savedRightKeyCode;\n\t\t}\n\n\t\t//! コアコンポーネントを初期化。\n\t\tthis.buffer = new MorseBuffer();\n\t\tthis.timer = new TimerManager();\n\t\tthis.audio = new AudioGenerator({\n\t\t\tfrequency: 700,\n\t\t\tvolume: 0.5,\n\t\t\twpm: this.currentWPM\n\t\t});\n\n\t\t//! トレーナーを初期化。\n\t\tthis.initializeTrainer();\n\t}\n\n\t/**\n\t * トレーナーを初期化する\n\t */\n\tprivate initializeTrainer(): void {\n\t\tconst timings = TimingCalculator.calculate(this.currentWPM);\n\n\t\tthis.trainer = new HorizontalKeyTrainer(\n\t\t\tthis.buffer,\n\t\t\tthis.timer,\n\t\t\ttimings,\n\t\t\t{\n\t\t\t\tonElementStart: (_element: '.' | '-', duration: number) => {\n\t\t\t\t\t//! 要素送信開始時に指定時間だけ音を鳴らす。\n\t\t\t\t\t// scheduleToneに0を渡すと現在時刻から再生される\n\t\t\t\t\tthis.audio.scheduleTone(0, duration);\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tiambicMode: this.iambicMode,\n\t\t\t\tpaddleLayout: this.paddleLayout\n\t\t\t}\n\t\t);\n\t}\n\n\t/**\n\t * ビューをレンダリングする\n\t */\n\trender(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t<h1>横振り電鍵練習</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"paddle-container\">\n\t\t\t\t\t<button class=\"paddle-button dit\" id=\"left-paddle\">\n\t\t\t\t\t\tDIT\n\t\t\t\t\t\t<span class=\"paddle-label\">(短点)</span>\n\t\t\t\t\t\t<span class=\"paddle-key\">J キー</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"paddle-button dah\" id=\"right-paddle\">\n\t\t\t\t\t\tDAH\n\t\t\t\t\t\t<span class=\"paddle-label\">(長点)</span>\n\t\t\t\t\t\t<span class=\"paddle-key\">K キー</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"practice-container\">\n\t\t\t\t\t<div class=\"display-area\">\n\t\t\t\t\t\t<div class=\"display-section\">\n\t\t\t\t\t\t\t<h3>モールス信号</h3>\n\t\t\t\t\t\t\t<div class=\"display-output morse-buffer\" id=\"morse-buffer\">（ここにモールス符号が表示されます）</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"display-section\">\n\t\t\t\t\t\t\t<h3>デコード結果</h3>\n\t\t\t\t\t\t\t<div class=\"display-output\" id=\"decoded-text\">（ここにデコードされた文字が表示されます）</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"action-area\">\n\t\t\t\t\t\t<button class=\"btn btn-large btn-danger\" id=\"clear-btn\">クリア</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"status-area\">\n\t\t\t\t\t\t<div class=\"status-item\">\n\t\t\t\t\t\t\t<span class=\"label\">現在の速度</span>\n\t\t\t\t\t\t\t<span class=\"value\" id=\"current-wpm\">${this.currentWPM}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"status-item\">\n\t\t\t\t\t\t\t<span class=\"label\">Iambicモード</span>\n\t\t\t\t\t\t\t<span class=\"value\" id=\"current-iambic-mode\">${this.iambicMode}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"status-item\">\n\t\t\t\t\t\t\t<span class=\"label\">入力文字数</span>\n\t\t\t\t\t\t\t<span class=\"value\" id=\"char-count\">0</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>左パドル（J）: 短点（・）/ 右パドル（K）: 長点（ー）</li>\n\t\t\t\t\t\t\t<li>両方同時押しで自動交互送信（Iambic）</li>\n\t\t\t\t\t\t\t<li>Iambic Bモード: スクイーズ後1要素追加送信</li>\n\t\t\t\t\t\t\t<li>画面右上の⚙アイコンから設定（WPM、Iambicモード、パドルレイアウト、音量・周波数）を変更できます</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\t//! イベントリスナーを設定。\n\t\tthis.attachEventListeners();\n\t\t//! 定期更新を開始。\n\t\tthis.startUpdate();\n\t}\n\n\t/**\n\t * イベントリスナーを設定する\n\t */\n\tprivate attachEventListeners(): void {\n\t\t//! 戻るボタン。\n\t\tconst backBtn = document.querySelector('.back-btn');\n\t\tbackBtn?.addEventListener('click', () => {\n\t\t\twindow.location.hash = '#menu';\n\t\t});\n\n\t\t//! 設定アイコン。\n\t\tdocument.getElementById('settingsIcon')?.addEventListener('click', () => {\n\t\t\tthis.openSettingsModal();\n\t\t});\n\n\t\t//! クリアボタン。\n\t\tconst clearBtn = document.getElementById('clear-btn');\n\t\tclearBtn?.addEventListener('click', () => {\n\t\t\tthis.trainer.clear();\n\t\t\tthis.updateDisplay();\n\t\t});\n\n\t\t//! キーボードイベント（設定されたキー）。\n\t\tthis.keyPressHandler = (e: KeyboardEvent) => {\n\t\t\tif (e.repeat) return;\n\n\t\t\tif (e.code === this.leftKeyCode) {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleLeftPaddlePress();\n\t\t\t} else if (e.code === this.rightKeyCode) {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleRightPaddlePress();\n\t\t\t}\n\t\t};\n\n\t\tthis.keyReleaseHandler = (e: KeyboardEvent) => {\n\t\t\tif (e.code === this.leftKeyCode) {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleLeftPaddleRelease();\n\t\t\t} else if (e.code === this.rightKeyCode) {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleRightPaddleRelease();\n\t\t\t}\n\t\t};\n\n\t\twindow.addEventListener('keydown', this.keyPressHandler);\n\t\twindow.addEventListener('keyup', this.keyReleaseHandler);\n\n\t\t//! ボタンイベント（左パドル）。\n\t\tconst leftPaddle = document.getElementById('left-paddle');\n\t\tif (leftPaddle) {\n\t\t\tleftPaddle.addEventListener('mousedown', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleLeftPaddlePress();\n\t\t\t});\n\t\t\tleftPaddle.addEventListener('mouseup', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleLeftPaddleRelease();\n\t\t\t});\n\t\t\tleftPaddle.addEventListener('mouseleave', () => {\n\t\t\t\tif (this.leftPressed) this.handleLeftPaddleRelease();\n\t\t\t});\n\t\t\tleftPaddle.addEventListener('touchstart', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleLeftPaddlePress();\n\t\t\t});\n\t\t\tleftPaddle.addEventListener('touchend', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleLeftPaddleRelease();\n\t\t\t});\n\t\t\tleftPaddle.addEventListener('touchcancel', () => {\n\t\t\t\tif (this.leftPressed) this.handleLeftPaddleRelease();\n\t\t\t});\n\t\t}\n\n\t\t//! ボタンイベント（右パドル）。\n\t\tconst rightPaddle = document.getElementById('right-paddle');\n\t\tif (rightPaddle) {\n\t\t\trightPaddle.addEventListener('mousedown', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleRightPaddlePress();\n\t\t\t});\n\t\t\trightPaddle.addEventListener('mouseup', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleRightPaddleRelease();\n\t\t\t});\n\t\t\trightPaddle.addEventListener('mouseleave', () => {\n\t\t\t\tif (this.rightPressed) this.handleRightPaddleRelease();\n\t\t\t});\n\t\t\trightPaddle.addEventListener('touchstart', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleRightPaddlePress();\n\t\t\t});\n\t\t\trightPaddle.addEventListener('touchend', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.handleRightPaddleRelease();\n\t\t\t});\n\t\t\trightPaddle.addEventListener('touchcancel', () => {\n\t\t\t\tif (this.rightPressed) this.handleRightPaddleRelease();\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * 左パドル押下処理\n\t */\n\tprivate handleLeftPaddlePress(): void {\n\t\tif (this.leftPressed) return;\n\t\tthis.leftPressed = true;\n\t\tthis.trainer.leftPaddlePress();\n\n\t\tconst leftPaddle = document.getElementById('left-paddle');\n\t\tif (leftPaddle) leftPaddle.classList.add('pressed');\n\t}\n\n\t/**\n\t * 左パドル解放処理\n\t */\n\tprivate handleLeftPaddleRelease(): void {\n\t\tif (!this.leftPressed) return;\n\t\tthis.leftPressed = false;\n\t\tthis.trainer.leftPaddleRelease();\n\n\t\tconst leftPaddle = document.getElementById('left-paddle');\n\t\tif (leftPaddle) leftPaddle.classList.remove('pressed');\n\t}\n\n\t/**\n\t * 右パドル押下処理\n\t */\n\tprivate handleRightPaddlePress(): void {\n\t\tif (this.rightPressed) return;\n\t\tthis.rightPressed = true;\n\t\tthis.trainer.rightPaddlePress();\n\n\t\tconst rightPaddle = document.getElementById('right-paddle');\n\t\tif (rightPaddle) rightPaddle.classList.add('pressed');\n\t}\n\n\t/**\n\t * 右パドル解放処理\n\t */\n\tprivate handleRightPaddleRelease(): void {\n\t\tif (!this.rightPressed) return;\n\t\tthis.rightPressed = false;\n\t\tthis.trainer.rightPaddleRelease();\n\n\t\tconst rightPaddle = document.getElementById('right-paddle');\n\t\tif (rightPaddle) rightPaddle.classList.remove('pressed');\n\t}\n\n\t/**\n\t * パドルラベルを更新する\n\t */\n\tprivate updatePaddleLabels(): void {\n\t\tconst leftPaddle = document.getElementById('left-paddle');\n\t\tconst rightPaddle = document.getElementById('right-paddle');\n\n\t\tif (this.paddleLayout === 'normal') {\n\t\t\tif (leftPaddle) {\n\t\t\t\tleftPaddle.className = 'paddle-button dit';\n\t\t\t\tleftPaddle.innerHTML = `\n\t\t\t\t\tDIT\n\t\t\t\t\t<span class=\"paddle-label\">(短点)</span>\n\t\t\t\t\t<span class=\"paddle-key\">J キー</span>\n\t\t\t\t`;\n\t\t\t}\n\t\t\tif (rightPaddle) {\n\t\t\t\trightPaddle.className = 'paddle-button dah';\n\t\t\t\trightPaddle.innerHTML = `\n\t\t\t\t\tDAH\n\t\t\t\t\t<span class=\"paddle-label\">(長点)</span>\n\t\t\t\t\t<span class=\"paddle-key\">K キー</span>\n\t\t\t\t`;\n\t\t\t}\n\t\t} else {\n\t\t\tif (leftPaddle) {\n\t\t\t\tleftPaddle.className = 'paddle-button dah';\n\t\t\t\tleftPaddle.innerHTML = `\n\t\t\t\t\tDAH\n\t\t\t\t\t<span class=\"paddle-label\">(長点)</span>\n\t\t\t\t\t<span class=\"paddle-key\">J キー</span>\n\t\t\t\t`;\n\t\t\t}\n\t\t\tif (rightPaddle) {\n\t\t\t\trightPaddle.className = 'paddle-button dit';\n\t\t\t\trightPaddle.innerHTML = `\n\t\t\t\t\tDIT\n\t\t\t\t\t<span class=\"paddle-label\">(短点)</span>\n\t\t\t\t\t<span class=\"paddle-key\">K キー</span>\n\t\t\t\t`;\n\t\t\t}\n\t\t}\n\n\t\t//! イベントリスナーを再設定。\n\t\tthis.attachEventListeners();\n\t}\n\n\t/**\n\t * 定期更新を開始する\n\t */\n\tprivate startUpdate(): void {\n\t\t//! 100msごとに画面を更新。\n\t\tthis.updateIntervalId = window.setInterval(() => {\n\t\t\tthis.updateDisplay();\n\t\t}, 100);\n\t}\n\n\t/**\n\t * 表示を更新する\n\t */\n\tprivate updateDisplay(): void {\n\t\tconst morseBuffer = document.getElementById('morse-buffer');\n\t\tconst decodedText = document.getElementById('decoded-text');\n\t\tconst charCount = document.getElementById('char-count');\n\n\t\tif (morseBuffer) {\n\t\t\tconst buffer = this.trainer.getBuffer();\n\t\t\tconst sequence = this.trainer.getSequence();\n\t\t\tconst fullDisplay = sequence ? `${buffer} ${sequence}` : buffer;\n\t\t\tmorseBuffer.textContent = fullDisplay || '（ここにモールス符号が表示されます）';\n\t\t}\n\n\t\tif (decodedText) {\n\t\t\tconst text = this.trainer.getDecoded();\n\t\t\tdecodedText.textContent = text || '（ここにデコードされた文字が表示されます）';\n\t\t}\n\n\t\tif (charCount) {\n\t\t\tconst text = this.trainer.getDecoded();\n\t\t\tcharCount.textContent = text.length.toString();\n\t\t}\n\t}\n\n\t/**\n\t * 設定モーダルを開く\n\t */\n\tprivate openSettingsModal(): void {\n\t\t//! 現在の設定値を取得。\n\t\tconst currentValues: SettingValues = {\n\t\t\tvolume: Math.round(this.audio.getVolume() * 100),\n\t\t\tfrequency: this.audio.getFrequency(),\n\t\t\twpm: this.currentWPM,\n\t\t\tiambicMode: this.iambicMode,\n\t\t\tpaddleLayout: this.paddleLayout,\n\t\t\tleftKeyCode: this.leftKeyCode,\n\t\t\trightKeyCode: this.rightKeyCode\n\t\t};\n\n\t\t//! 設定変更前の値を保存（キャンセル時の復元用）。\n\t\tconst savedSettings = {\n\t\t\tvolume: this.audio.getVolume(),\n\t\t\tfrequency: this.audio.getFrequency(),\n\t\t\twpm: this.currentWPM,\n\t\t\tiambicMode: this.iambicMode,\n\t\t\tpaddleLayout: this.paddleLayout,\n\t\t\tleftKeyCode: this.leftKeyCode,\n\t\t\trightKeyCode: this.rightKeyCode\n\t\t};\n\n\t\t//! SettingsModalを作成。\n\t\tconst modal = new SettingsModal(\n\t\t\t'horizontal-key-settings-modal',\n\t\t\tALL_SETTING_ITEMS,\n\t\t\tcurrentValues,\n\t\t\t{\n\t\t\t\tonSave: (values: SettingValues) => {\n\t\t\t\t\t//! 設定を保存。\n\t\t\t\t\tthis.audio.setVolume((values.volume as number) / 100);\n\t\t\t\t\tthis.audio.setFrequency(values.frequency as number);\n\t\t\t\t\tthis.audio.setWPM(values.wpm as number);\n\t\t\t\t\tthis.currentWPM = values.wpm as number;\n\t\t\t\t\tthis.iambicMode = values.iambicMode as IambicMode;\n\t\t\t\t\tthis.paddleLayout = values.paddleLayout as PaddleLayout;\n\t\t\t\t\tthis.leftKeyCode = values.leftKeyCode as string;\n\t\t\t\t\tthis.rightKeyCode = values.rightKeyCode as string;\n\n\t\t\t\t\t//! localStorageに保存。\n\t\t\t\t\tlocalStorage.setItem('horizontalKeyWPM', this.currentWPM.toString());\n\t\t\t\t\tlocalStorage.setItem('horizontalKeyIambicMode', this.iambicMode);\n\t\t\t\t\tlocalStorage.setItem('horizontalKeyPaddleLayout', this.paddleLayout);\n\t\t\t\t\tlocalStorage.setItem('horizontalKeyLeftCode', this.leftKeyCode);\n\t\t\t\t\tlocalStorage.setItem('horizontalKeyRightCode', this.rightKeyCode);\n\n\t\t\t\t\t//! 現在のWPM表示を更新。\n\t\t\t\t\tconst currentWpmDisplay = document.getElementById('current-wpm');\n\t\t\t\t\tif (currentWpmDisplay) currentWpmDisplay.textContent = this.currentWPM.toString();\n\n\t\t\t\t\t//! 現在のIambicモード表示を更新。\n\t\t\t\t\tconst currentIambicModeDisplay = document.getElementById('current-iambic-mode');\n\t\t\t\t\tif (currentIambicModeDisplay) currentIambicModeDisplay.textContent = this.iambicMode;\n\n\t\t\t\t\t//! パドルレイアウトに応じてラベルを更新。\n\t\t\t\t\tthis.updatePaddleLabels();\n\n\t\t\t\t\t//! トレーナーを再初期化。\n\t\t\t\t\tthis.initializeTrainer();\n\t\t\t\t},\n\t\t\t\tonCancel: () => {\n\t\t\t\t\t//! 設定を元に戻す。\n\t\t\t\t\tthis.audio.setVolume(savedSettings.volume);\n\t\t\t\t\tthis.audio.setFrequency(savedSettings.frequency);\n\t\t\t\t\tthis.audio.setWPM(savedSettings.wpm);\n\t\t\t\t\tthis.currentWPM = savedSettings.wpm;\n\t\t\t\t\tthis.iambicMode = savedSettings.iambicMode;\n\t\t\t\t\tthis.paddleLayout = savedSettings.paddleLayout;\n\t\t\t\t\tthis.leftKeyCode = savedSettings.leftKeyCode;\n\t\t\t\t\tthis.rightKeyCode = savedSettings.rightKeyCode;\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\t//! モーダルを表示。\n\t\tmodal.show('horizontal-key');\n\t}\n\n\t/**\n\t * ビューを破棄する\n\t */\n\tdestroy(): void {\n\t\t//! イベントリスナーを削除。\n\t\tif (this.keyPressHandler) {\n\t\t\twindow.removeEventListener('keydown', this.keyPressHandler);\n\t\t\tthis.keyPressHandler = null;\n\t\t}\n\t\tif (this.keyReleaseHandler) {\n\t\t\twindow.removeEventListener('keyup', this.keyReleaseHandler);\n\t\t\tthis.keyReleaseHandler = null;\n\t\t}\n\n\t\t//! 定期更新を停止。\n\t\tif (this.updateIntervalId !== null) {\n\t\t\tclearInterval(this.updateIntervalId);\n\t\t\tthis.updateIntervalId = null;\n\t\t}\n\n\t\t//! トレーナーをクリア。\n\t\tthis.trainer.clear();\n\t}\n}\n","/**\n * フラッシュカードTSVローダー\n */\n\nimport type { FlashcardEntry } from 'morse-engine';\n\n/**\n * TSVファイルからフラッシュカードデータをロードする\n * @param url - TSVファイルのURL\n * @returns FlashcardEntryの配列\n */\nexport async function loadFlashcardData(url: string): Promise<FlashcardEntry[]> {\n\t//! TSVファイルを取得。\n\tconst response = await fetch(url);\n\tif (!response.ok) {\n\t\tthrow new Error(`Failed to load flashcard data: ${response.statusText}`);\n\t}\n\n\tconst text = await response.text();\n\treturn parseTSV(text);\n}\n\n/**\n * TSVテキストをパースしてFlashcardEntry配列に変換する\n * @param text - TSVテキスト\n * @returns FlashcardEntryの配列\n */\nfunction parseTSV(text: string): FlashcardEntry[] {\n\t//! 行に分割。\n\tconst lines = text.split('\\n').filter(line => line.trim());\n\tif (lines.length === 0) return [];\n\n\t//! 先頭行はヘッダーなのでスキップ。\n\tconst dataLines = lines.slice(1);\n\n\treturn dataLines.map((line, index) => {\n\t\t//! タブで分割。\n\t\tconst columns = line.split('\\t');\n\n\t\t//! 最低限6列（タグ、頻度、略語、英文、和訳、説明）必要。\n\t\tif (columns.length < 6) {\n\t\t\t//! 開発環境でのみ警告を出力。\n\t\t\tif (import.meta.env.DEV) {\n\t\t\t\tconsole.warn(`Line ${index + 2} has insufficient columns, skipping`);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tconst entry: FlashcardEntry = {\n\t\t\ttags: columns[0].trim(),\n\t\t\tfrequency: parseInt(columns[1].trim(), 10) || 1,\n\t\t\tabbreviation: columns[2].trim(),\n\t\t\tenglish: columns[3].trim(),\n\t\t\tjapanese: columns[4].trim(),\n\t\t\tdescription: columns[5]?.trim(),\n\t\t\texample: columns[6]?.trim()\n\t\t};\n\n\t\treturn entry;\n\t}).filter((entry): entry is FlashcardEntry => entry !== null);\n}\n","/**\n * フラッシュカードビュー\n * CW略語・Q符号学習\n */\n\nimport type { View } from '../../router';\nimport {\n\tFlashcardTrainer,\n\tFlashcardState,\n\tAudioGenerator,\n\tMorseCodec,\n\ttype FlashcardEntry,\n\ttype ExamQuestion,\n\ttype ExamResult,\n\ttype QuestionType,\n\ttype LearnQuestionType,\n\ttype Progress,\n\ttype SortColumn,\n\ttype SortDirection,\n\ttype DisplayMode\n} from 'morse-engine';\nimport { loadFlashcardData } from '../../utils/flashcard-loader';\nimport { SettingsModal, ALL_SETTING_ITEMS, type SettingValues } from 'morse-engine';\n\n/**\n * 画面状態（ローディングと結果表示用）\n */\ntype ViewState = 'loading' | 'browse' | 'learn' | 'exam' | 'exam-result';\n\n/**\n * フラッシュカードビュークラス\n */\nexport class FlashcardView implements View {\n\tprivate allEntries: FlashcardEntry[] = [];\n\tprivate filteredEntries: FlashcardEntry[] = [];\n\tprivate currentState: ViewState = 'loading';\n\n\t// フィルター関連\n\tprivate selectedTags: Set<string> = new Set();\n\tprivate selectedFrequencies: Set<number> = new Set([5]);\n\tprivate searchQuery = '';\n\n\t// 一覧表示関連\n\tprivate displayMode: DisplayMode = 'card';\n\tprivate sortColumn: SortColumn = 'abbreviation';\n\tprivate sortDirection: SortDirection = 'asc';\n\n\t// 学習モード関連\n\tprivate learnQuestionType: LearnQuestionType = 'abbr-to-meaning';\n\tprivate learnCards: FlashcardEntry[] = [];\n\tprivate currentLearnIndex = 0;\n\tprivate isFlipped = false;\n\tprivate reviewMode = false;\n\tprivate progress: Progress = {\n\t\tknown: new Set(),\n\t\tunknown: new Set()\n\t};\n\n\t// 試験関連\n\tprivate questionType: QuestionType = 'abbr-to-meaning';\n\tprivate questionCount: number | 'all' = 10;\n\tprivate questions: ExamQuestion[] = [];\n\tprivate currentQuestionIndex = 0;\n\tprivate results: ExamResult[] = [];\n\n\t// 音声関連\n\tprivate audio: AudioGenerator;\n\tprivate currentlyPlaying: string | null = null;\n\n\tconstructor() {\n\t\tthis.audio = new AudioGenerator({\n\t\t\tfrequency: 700,\n\t\t\tvolume: 0.5,\n\t\t\twpm: 20\n\t\t});\n\t\t//! ライブラリから状態を読み込む。\n\t\tthis.progress = FlashcardState.loadProgress();\n\t\tconst filters = FlashcardState.loadFilters();\n\t\tthis.selectedTags = filters.selectedTags;\n\t\tthis.selectedFrequencies = filters.selectedFrequencies;\n\t\tthis.searchQuery = filters.searchQuery;\n\n\t\tconst viewState = FlashcardState.loadViewState();\n\t\tthis.displayMode = viewState.displayMode;\n\t\tthis.sortColumn = viewState.sortColumn;\n\t\tthis.sortDirection = viewState.sortDirection;\n\t\tthis.learnQuestionType = viewState.learnQuestionType;\n\t\tthis.questionType = viewState.examQuestionType as QuestionType;\n\t}\n\n\t/**\n\t * 進捗データを保存する\n\t */\n\tprivate saveProgress(): void {\n\t\tFlashcardState.saveProgress(this.progress);\n\t}\n\n\t/**\n\t * 進捗データをクリアする\n\t */\n\tprivate clearProgress(): void {\n\t\tthis.progress = { known: new Set(), unknown: new Set() };\n\t\tFlashcardState.clearProgress();\n\t}\n\n\t/**\n\t * フィルター状態を保存する\n\t */\n\tprivate saveFilters(): void {\n\t\tFlashcardState.saveFilters({\n\t\t\tselectedTags: this.selectedTags,\n\t\t\tselectedFrequencies: this.selectedFrequencies,\n\t\t\tsearchQuery: this.searchQuery\n\t\t});\n\t}\n\n\tasync render(): Promise<void> {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tif (this.currentState === 'loading') {\n\t\t\t//! ローディング画面を表示。\n\t\t\tapp.innerHTML = `\n\t\t\t\t<div class=\"container\">\n\t\t\t\t\t<header class=\"header\">\n\t\t\t\t\t\t<h1>CW略語・Q符号学習</h1>\n\t\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t</header>\n\t\t\t\t\t<div class=\"loading-container\">\n\t\t\t\t\t\t<p>フラッシュカードデータを読み込み中...</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t\tconst backBtn = document.querySelector('.back-btn');\n\t\t\tbackBtn?.addEventListener('click', () => {\n\t\t\t\twindow.location.hash = '#menu';\n\t\t\t});\n\n\t\t\t//! データをロード。\n\t\t\ttry {\n\t\t\t\tthis.allEntries = await loadFlashcardData('/flashcard.tsv');\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\t//! データロード完了後、保存されていたviewModeを復元。\n\t\t\t\tconst viewState = FlashcardState.loadViewState();\n\t\t\t\tthis.currentState = viewState.viewMode;\n\t\t\t\tthis.render();\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('Failed to load flashcard data:', error);\n\t\t\t\tapp.innerHTML = `\n\t\t\t\t\t<div class=\"container\">\n\t\t\t\t\t\t<header class=\"header\">\n\t\t\t\t\t\t\t<h1>CW略語・Q符号学習</h1>\n\t\t\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t\t</header>\n\t\t\t\t\t\t<div class=\"error-container\">\n\t\t\t\t\t\t\t<p>データの読み込みに失敗しました。</p>\n\t\t\t\t\t\t\t<p>エラー: ${error}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`;\n\t\t\t}\n\t\t} else if (this.currentState === 'browse') {\n\t\t\tthis.renderBrowseMode();\n\t\t} else if (this.currentState === 'learn') {\n\t\t\tthis.renderLearnMode();\n\t\t} else if (this.currentState === 'exam') {\n\t\t\tthis.renderExamMode();\n\t\t} else if (this.currentState === 'exam-result') {\n\t\t\tthis.renderExamResultMode();\n\t\t}\n\t}\n\n\t/**\n\t * 共通のフィルターセクションHTMLを生成\n\t */\n\tprivate renderFilterSection(): string {\n\t\tconst allTags = FlashcardTrainer.getAllTags(this.allEntries);\n\n\t\treturn `\n\t\t\t<div class=\"filter-section\">\n\t\t\t\t<h3>フィルター設定</h3>\n\n\t\t\t\t<div class=\"filter-group\">\n\t\t\t\t\t<label>タグで絞り込み</label>\n\t\t\t\t\t<div class=\"tag-filter\" id=\"tag-filter\">\n\t\t\t\t\t\t${allTags.map(tag => `\n\t\t\t\t\t\t\t<label class=\"tag-checkbox\">\n\t\t\t\t\t\t\t\t<input type=\"checkbox\" value=\"${tag}\" ${this.selectedTags.has(tag) ? 'checked' : ''}>\n\t\t\t\t\t\t\t\t<span>${tag}</span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t`).join('')}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"filter-group\">\n\t\t\t\t\t<label>使用頻度で絞り込み（1=低頻度、5=高頻度）</label>\n\t\t\t\t\t<div class=\"frequency-filter\" id=\"frequency-filter\">\n\t\t\t\t\t\t${[5, 4, 3, 2, 1].map(freq => `\n\t\t\t\t\t\t\t<label class=\"frequency-checkbox\">\n\t\t\t\t\t\t\t\t<input type=\"checkbox\" value=\"${freq}\" ${this.selectedFrequencies.has(freq) ? 'checked' : ''}>\n\t\t\t\t\t\t\t\t<span>★${freq}</span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t`).join('')}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"filter-group\">\n\t\t\t\t\t<label for=\"search-input\">検索（略語・意味・タグ）</label>\n\t\t\t\t\t<input type=\"text\" id=\"search-input\" class=\"search-input\" placeholder=\"例: QTH, location, Q符号\" value=\"${this.searchQuery}\">\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"filter-stats\">\n\t\t\t\t\t<span>該当: <strong id=\"filtered-count\">${this.filteredEntries.length}</strong> 件</span>\n\t\t\t\t\t<span>全体: <strong>${this.allEntries.length}</strong> 件</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t/**\n\t * 一覧モード（browse）をレンダリング\n\t */\n\tprivate renderBrowseMode(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t<h1>CW略語・Q符号学習</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"tabs\">\n\t\t\t\t\t<button class=\"tab-button active\" data-tab=\"browse\">一覧</button>\n\t\t\t\t\t<button class=\"tab-button\" data-tab=\"learn\">学習モード</button>\n\t\t\t\t\t<button class=\"tab-button\" data-tab=\"exam\">試験モード</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"flashcard-container\">\n\t\t\t\t\t${this.renderFilterSection()}\n\n\t\t\t\t\t<div class=\"entries-section\" id=\"entries-section\">\n\t\t\t\t\t\t<!-- ここに一覧が表示される -->\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>タグ、使用頻度、検索で略語を絞り込めます</li>\n\t\t\t\t\t\t\t<li>略語カードをクリックするとモールス信号を再生できます</li>\n\t\t\t\t\t\t\t<li>カード表示とリスト表示を切り替えられます</li>\n\t\t\t\t\t\t\t<li>「学習モード」タブでフラッシュカード学習ができます</li>\n\t\t\t\t\t\t\t<li>「試験モード」タブで理解度テストができます</li>\n\t\t\t\t\t\t\t<li>画面右上の⚙アイコンから音量・周波数・速度を調整できます</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.renderEntries();\n\t\tthis.attachBrowseModeListeners();\n\t}\n\n\t/**\n\t * エントリー一覧を表示\n\t */\n\tprivate renderEntries(): void {\n\t\tconst container = document.getElementById('entries-section');\n\t\tif (!container) return;\n\n\t\tif (this.displayMode === 'card') {\n\t\t\tthis.renderCardView(container);\n\t\t} else {\n\t\t\tthis.renderListView(container);\n\t\t}\n\t}\n\n\t/**\n\t * カード表示\n\t */\n\tprivate renderCardView(container: HTMLElement): void {\n\t\tcontainer.innerHTML = `\n\t\t\t<div class=\"entries-header\">\n\t\t\t\t<h3>略語一覧 (${this.filteredEntries.length}件)</h3>\n\t\t\t\t<button id=\"toggle-display-btn\" class=\"toggle-display-btn\">📋 リスト表示</button>\n\t\t\t</div>\n\t\t\t<div class=\"entries-grid\">\n\t\t\t\t${this.filteredEntries.map(entry => `\n\t\t\t\t\t<div class=\"entry-card ${this.currentlyPlaying === entry.abbreviation ? 'playing' : ''}\" data-abbr=\"${entry.abbreviation}\">\n\t\t\t\t\t\t<div class=\"entry-header\">\n\t\t\t\t\t\t\t<div class=\"entry-abbr\">${this.formatAbbreviation(entry.abbreviation)}</div>\n\t\t\t\t\t\t\t<div class=\"entry-frequency\" title=\"使用頻度: ${entry.frequency}/5\">${'★'.repeat(entry.frequency)}${'☆'.repeat(5 - entry.frequency)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"entry-english\">${entry.english}</div>\n\t\t\t\t\t\t<div class=\"entry-japanese\">${entry.japanese}</div>\n\t\t\t\t\t\t${entry.description ? `<div class=\"entry-description\">${entry.description}</div>` : ''}\n\t\t\t\t\t\t${entry.example ? `<div class=\"entry-example\">例: ${entry.example}</div>` : ''}\n\t\t\t\t\t\t<div class=\"entry-tags\">${entry.tags}</div>\n\t\t\t\t\t</div>\n\t\t\t\t`).join('')}\n\t\t\t</div>\n\t\t`;\n\n\t\t//! カードクリックでモールス再生。\n\t\tcontainer.querySelectorAll('.entry-card').forEach(card => {\n\t\t\tcard.addEventListener('click', () => {\n\t\t\t\tconst abbr = card.getAttribute('data-abbr');\n\t\t\t\tif (abbr) this.playMorse(abbr);\n\t\t\t});\n\t\t});\n\n\t\t//! 表示モード切り替えボタン。\n\t\tconst toggleBtn = document.getElementById('toggle-display-btn');\n\t\tif (toggleBtn) {\n\t\t\ttoggleBtn.addEventListener('click', () => {\n\t\t\t\tthis.displayMode = 'list';\n\t\t\t\tFlashcardState.saveDisplayMode(this.displayMode);\n\t\t\t\tthis.renderEntries();\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * リスト表示\n\t */\n\tprivate renderListView(container: HTMLElement): void {\n\t\tcontainer.innerHTML = `\n\t\t\t<div class=\"entries-header\">\n\t\t\t\t<h3>略語一覧 (${this.filteredEntries.length}件)</h3>\n\t\t\t\t<button id=\"toggle-display-btn\" class=\"toggle-display-btn\">🃏 カード表示</button>\n\t\t\t</div>\n\t\t\t<div class=\"list-table-container\">\n\t\t\t\t<table class=\"list-table\">\n\t\t\t\t\t<thead>\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th class=\"sortable\" data-column=\"abbreviation\">略語${this.getSortIndicator('abbreviation')}</th>\n\t\t\t\t\t\t\t<th class=\"sortable\" data-column=\"english\">英文${this.getSortIndicator('english')}</th>\n\t\t\t\t\t\t\t<th class=\"sortable\" data-column=\"japanese\">和訳${this.getSortIndicator('japanese')}</th>\n\t\t\t\t\t\t\t<th class=\"sortable\" data-column=\"frequency\">頻度${this.getSortIndicator('frequency')}</th>\n\t\t\t\t\t\t\t<th class=\"sortable\" data-column=\"tags\">タグ${this.getSortIndicator('tags')}</th>\n\t\t\t\t\t\t\t<th>説明</th>\n\t\t\t\t\t\t\t<th>具体例</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t${this.filteredEntries.map(entry => `\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td class=\"list-abbr\">\n\t\t\t\t\t\t\t\t\t<button class=\"abbr-play-btn ${this.currentlyPlaying === entry.abbreviation ? 'playing' : ''}\" data-abbr=\"${entry.abbreviation}\">\n\t\t\t\t\t\t\t\t\t\t${this.formatAbbreviation(entry.abbreviation)}\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t<td>${entry.english}</td>\n\t\t\t\t\t\t\t\t<td>${entry.japanese}</td>\n\t\t\t\t\t\t\t\t<td title=\"使用頻度: ${entry.frequency}/5\">${'★'.repeat(entry.frequency)}${'☆'.repeat(5 - entry.frequency)}</td>\n\t\t\t\t\t\t\t\t<td>${entry.tags}</td>\n\t\t\t\t\t\t\t\t<td>${entry.description || ''}</td>\n\t\t\t\t\t\t\t\t<td>${entry.example || ''}</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t`).join('')}\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t`;\n\n\t\t//! ソートヘッダーのイベントリスナー。\n\t\tconst sortHeaders = container.querySelectorAll('th.sortable');\n\t\tsortHeaders.forEach(header => {\n\t\t\theader.addEventListener('click', () => {\n\t\t\t\tconst column = header.getAttribute('data-column') as SortColumn;\n\t\t\t\tif (column) this.toggleSort(column);\n\t\t\t});\n\t\t});\n\n\t\t//! 略語再生ボタンのイベントリスナー。\n\t\tconst playButtons = container.querySelectorAll('.abbr-play-btn');\n\t\tplayButtons.forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst abbr = btn.getAttribute('data-abbr');\n\t\t\t\tif (abbr) this.playMorse(abbr);\n\t\t\t});\n\t\t});\n\n\t\t//! 表示モード切り替えボタン。\n\t\tconst toggleBtn = document.getElementById('toggle-display-btn');\n\t\tif (toggleBtn) {\n\t\t\ttoggleBtn.addEventListener('click', () => {\n\t\t\t\tthis.displayMode = 'card';\n\t\t\t\tFlashcardState.saveDisplayMode(this.displayMode);\n\t\t\t\tthis.renderEntries();\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * 学習モードをレンダリング\n\t */\n\tprivate renderLearnMode(): void {\n\t\tif (this.learnCards.length === 0) {\n\t\t\t//! セットアップ画面を表示。\n\t\t\tthis.renderLearnSetup();\n\t\t} else {\n\t\t\t//! 学習カードを表示。\n\t\t\tthis.renderLearnCard();\n\t\t}\n\t}\n\n\t/**\n\t * 学習モードセットアップ画面\n\t */\n\tprivate renderLearnSetup(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\t//! カード枚数を計算。\n\t\tlet cardCount = this.filteredEntries.length;\n\t\tif (this.reviewMode) {\n\t\t\tcardCount = this.filteredEntries.filter(e =>\n\t\t\t\tthis.progress.unknown.has(e.abbreviation)\n\t\t\t).length;\n\t\t}\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t<h1>CW略語・Q符号学習</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"tabs\">\n\t\t\t\t\t<button class=\"tab-button\" data-tab=\"browse\">一覧</button>\n\t\t\t\t\t<button class=\"tab-button active\" data-tab=\"learn\">学習モード</button>\n\t\t\t\t\t<button class=\"tab-button\" data-tab=\"exam\">試験モード</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"flashcard-container\">\n\t\t\t\t\t${this.renderFilterSection()}\n\n\t\t\t\t\t<div class=\"learn-setup-section\">\n\t\t\t\t\t\t<h3>学習設定</h3>\n\n\t\t\t\t\t\t<div class=\"filter-group\">\n\t\t\t\t\t\t\t<label>モード</label>\n\t\t\t\t\t\t\t<div class=\"mode-buttons\">\n\t\t\t\t\t\t\t\t<button class=\"mode-btn ${this.reviewMode ? 'active' : ''}\" id=\"review-mode-btn\">\n\t\t\t\t\t\t\t\t\t復習モード（わからないカードのみ: ${this.progress.unknown.size}件）\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class=\"filter-group\">\n\t\t\t\t\t\t\t<label>出題形式</label>\n\t\t\t\t\t\t\t<div class=\"question-type-buttons\">\n\t\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.learnQuestionType === 'abbr-to-meaning' ? 'active' : ''}\" data-type=\"abbr-to-meaning\">略語→意味（基本）</button>\n\t\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.learnQuestionType === 'meaning-to-abbr' ? 'active' : ''}\" data-type=\"meaning-to-abbr\">意味→略語（応用）</button>\n\t\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.learnQuestionType === 'morse-to-abbr' ? 'active' : ''}\" data-type=\"morse-to-abbr\">モールス音→略語（実践）</button>\n\t\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.learnQuestionType === 'morse-to-meaning' ? 'active' : ''}\" data-type=\"morse-to-meaning\">モールス音→意味（実践）</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class=\"filter-stats\">\n\t\t\t\t\t\t\t<span>学習可能: <strong>${cardCount}</strong> 枚</span>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class=\"action-area\">\n\t\t\t\t\t\t\t<button class=\"btn btn-large btn-primary\" id=\"start-learn-btn\" ${cardCount === 0 ? 'disabled' : ''}>学習開始</button>\n\t\t\t\t\t\t\t<button class=\"btn btn-large btn-secondary\" id=\"clear-progress-btn\">進捗をリセット</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>フィルターで学習する略語を絞り込みます</li>\n\t\t\t\t\t\t\t<li>出題形式を選択します（略語→意味、意味→略語、モールス音からの解読）</li>\n\t\t\t\t\t\t\t<li>カードをクリックで裏返し、「わかる」「わからない」で進捗を記録</li>\n\t\t\t\t\t\t\t<li>復習モードで「わからない」カードのみを学習できます</li>\n\t\t\t\t\t\t\t<li>学習進捗はブラウザに自動保存されます</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachCommonListeners();\n\t\tthis.attachLearnSetupListeners();\n\t}\n\n\t/**\n\t * 学習セットアップのイベントリスナー\n\t */\n\tprivate attachLearnSetupListeners(): void {\n\t\t//! タグフィルター。\n\t\tconst tagFilter = document.getElementById('tag-filter');\n\t\ttagFilter?.addEventListener('change', (e) => {\n\t\t\tconst target = e.target as HTMLInputElement;\n\t\t\tif (target.type === 'checkbox') {\n\t\t\t\tif (target.checked) {\n\t\t\t\t\tthis.selectedTags.add(target.value);\n\t\t\t\t} else {\n\t\t\t\t\tthis.selectedTags.delete(target.value);\n\t\t\t\t}\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\tthis.renderLearnSetup();\n\t\t\t}\n\t\t});\n\n\t\t//! 使用頻度フィルター。\n\t\tconst frequencyFilter = document.getElementById('frequency-filter');\n\t\tfrequencyFilter?.addEventListener('change', (e) => {\n\t\t\tconst target = e.target as HTMLInputElement;\n\t\t\tif (target.type === 'checkbox') {\n\t\t\t\tconst freq = parseInt(target.value, 10);\n\t\t\t\tif (target.checked) {\n\t\t\t\t\tthis.selectedFrequencies.add(freq);\n\t\t\t\t} else {\n\t\t\t\t\tthis.selectedFrequencies.delete(freq);\n\t\t\t\t}\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\tthis.renderLearnSetup();\n\t\t\t}\n\t\t});\n\n\t\t//! 検索。\n\t\tconst searchInput = document.getElementById('learn-search-input') as HTMLInputElement;\n\t\tsearchInput?.addEventListener('input', () => {\n\t\t\tthis.searchQuery = searchInput.value;\n\t\t\tthis.updateFilteredEntries();\n\t\t\tthis.renderLearnSetup();\n\t\t});\n\n\t\t//! 復習モードボタン。\n\t\tconst reviewModeBtn = document.getElementById('review-mode-btn');\n\t\treviewModeBtn?.addEventListener('click', () => {\n\t\t\tthis.reviewMode = !this.reviewMode;\n\t\t\tthis.renderLearnSetup();\n\t\t});\n\n\t\t//! 出題形式ボタン。\n\t\tconst questionTypeBtns = document.querySelectorAll('.question-type-btn');\n\t\tquestionTypeBtns.forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst type = btn.getAttribute('data-type') as LearnQuestionType;\n\t\t\t\tif (type) {\n\t\t\t\t\tthis.learnQuestionType = type;\n\t\t\t\t\tFlashcardState.saveLearnQuestionType(this.learnQuestionType);\n\t\t\t\t\tthis.renderLearnSetup();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! 学習開始ボタン。\n\t\tconst startLearnBtn = document.getElementById('start-learn-btn');\n\t\tstartLearnBtn?.addEventListener('click', () => {\n\t\t\tthis.startLearn();\n\t\t});\n\n\t\t//! 進捗リセットボタン。\n\t\tconst clearProgressBtn = document.getElementById('clear-progress-btn');\n\t\tclearProgressBtn?.addEventListener('click', () => {\n\t\t\tif (confirm('学習進捗をリセットしますか？')) {\n\t\t\t\tthis.clearProgress();\n\t\t\t\tthis.renderLearnSetup();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * 学習を開始\n\t */\n\tprivate startLearn(): void {\n\t\t//! フィルタリング済みのエントリーから学習カードを作成。\n\t\tlet cards = [...this.filteredEntries];\n\n\t\tif (this.reviewMode) {\n\t\t\t//! 復習モード: わからないカードのみ。\n\t\t\tcards = cards.filter(e => this.progress.unknown.has(e.abbreviation));\n\t\t}\n\n\t\tif (cards.length === 0) {\n\t\t\talert('学習可能なカードがありません。');\n\t\t\treturn;\n\t\t}\n\n\t\t//! シャッフル。\n\t\tcards = cards.sort(() => Math.random() - 0.5);\n\n\t\tthis.learnCards = cards;\n\t\tthis.currentLearnIndex = 0;\n\t\tthis.isFlipped = false;\n\t\tthis.renderLearnCard();\n\t}\n\n\t/**\n\t * 学習カードを表示\n\t */\n\tprivate renderLearnCard(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tconst card = this.learnCards[this.currentLearnIndex];\n\t\tconst currentNum = this.currentLearnIndex + 1;\n\t\tconst totalNum = this.learnCards.length;\n\n\t\t//! 問題と正解のコンテンツを生成。\n\t\tlet frontContent = '';\n\t\tlet backContent = '';\n\n\t\tswitch (this.learnQuestionType) {\n\t\t\tcase 'abbr-to-meaning':\n\t\t\t\tfrontContent = `\n\t\t\t\t\t<div class=\"card-label\">略語</div>\n\t\t\t\t\t<div class=\"card-content-abbr\">${this.formatAbbreviation(card.abbreviation)}</div>\n\t\t\t\t`;\n\t\t\t\tbackContent = `\n\t\t\t\t\t<div class=\"card-label\">意味</div>\n\t\t\t\t\t<div class=\"card-content-text\">${card.english}</div>\n\t\t\t\t\t<div class=\"card-content-text\">${card.japanese}</div>\n\t\t\t\t`;\n\t\t\t\tbreak;\n\t\t\tcase 'meaning-to-abbr':\n\t\t\t\tfrontContent = `\n\t\t\t\t\t<div class=\"card-label\">意味</div>\n\t\t\t\t\t<div class=\"card-content-text\">${card.english}</div>\n\t\t\t\t\t<div class=\"card-content-text\">${card.japanese}</div>\n\t\t\t\t`;\n\t\t\t\tbackContent = `\n\t\t\t\t\t<div class=\"card-label\">略語</div>\n\t\t\t\t\t<div class=\"card-content-abbr\">${this.formatAbbreviation(card.abbreviation)}</div>\n\t\t\t\t`;\n\t\t\t\tbreak;\n\t\t\tcase 'morse-to-abbr':\n\t\t\t\tfrontContent = `\n\t\t\t\t\t<div class=\"card-label\">モールス音を聞いて略語を答えてください</div>\n\t\t\t\t\t<button class=\"play-morse-btn\" id=\"play-morse-btn\">🔊 モールス再生</button>\n\t\t\t\t`;\n\t\t\t\tbackContent = `\n\t\t\t\t\t<div class=\"card-label\">略語</div>\n\t\t\t\t\t<div class=\"card-content-abbr\">${this.formatAbbreviation(card.abbreviation)}</div>\n\t\t\t\t`;\n\t\t\t\tbreak;\n\t\t\tcase 'morse-to-meaning':\n\t\t\t\tfrontContent = `\n\t\t\t\t\t<div class=\"card-label\">モールス音を聞いて意味を答えてください</div>\n\t\t\t\t\t<button class=\"play-morse-btn\" id=\"play-morse-btn\">🔊 モールス再生</button>\n\t\t\t\t`;\n\t\t\t\tbackContent = `\n\t\t\t\t\t<div class=\"card-label\">意味</div>\n\t\t\t\t\t<div class=\"card-content-abbr\">${this.formatAbbreviation(card.abbreviation)}</div>\n\t\t\t\t\t<div class=\"card-content-text\">${card.english}</div>\n\t\t\t\t\t<div class=\"card-content-text\">${card.japanese}</div>\n\t\t\t\t`;\n\t\t\t\tbreak;\n\t\t}\n\n\t\t//! 判定ボタンのHTML。\n\t\tconst isKnown = this.progress.known.has(card.abbreviation);\n\t\tconst isUnknown = this.progress.unknown.has(card.abbreviation);\n\t\tconst judgmentButtons = `\n\t\t\t<div class=\"judgment-controls\">\n\t\t\t\t<button id=\"mark-unknown-btn\" class=\"judgment-button unknown ${isUnknown ? 'active' : ''}\">\n\t\t\t\t\t× わからない\n\t\t\t\t</button>\n\t\t\t\t<button id=\"mark-known-btn\" class=\"judgment-button known ${isKnown ? 'active' : ''}\">\n\t\t\t\t\t○ わかる\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t`;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"container learning-view\">\n\t\t\t\t<div class=\"learning-header\">\n\t\t\t\t\t<button id=\"back-to-setup-btn\" class=\"back-btn\">← 設定に戻る</button>\n\t\t\t\t\t<div class=\"progress-indicator\">${currentNum} / ${totalNum}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"card-container\">\n\t\t\t\t\t<div class=\"flashcard ${this.isFlipped ? 'flipped' : ''}\" id=\"flashcard\">\n\t\t\t\t\t\t<div class=\"card-front\">\n\t\t\t\t\t\t\t${frontContent}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"card-back\">\n\t\t\t\t\t\t\t${backContent}\n\t\t\t\t\t\t\t${card.description ? `<div class=\"card-description\">${card.description}</div>` : ''}\n\t\t\t\t\t\t\t${card.example ? `<div class=\"card-example\">例: ${card.example}</div>` : ''}\n\t\t\t\t\t\t\t<div class=\"card-tags\">${card.tags} / ${'★'.repeat(card.frequency)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"card-controls\">\n\t\t\t\t\t<button id=\"flip-card-btn\" class=\"control-button\">\n\t\t\t\t\t\t${this.isFlipped ? '問題に戻る' : '正解を確認する'} (Space)\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t${this.isFlipped ? judgmentButtons : ''}\n\n\t\t\t\t<div class=\"navigation-controls\">\n\t\t\t\t\t<button id=\"prev-card-btn\" class=\"nav-button\" ${this.currentLearnIndex === 0 ? 'disabled' : ''}>\n\t\t\t\t\t\t← 前のカード\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"next-card-btn\" class=\"nav-button\" ${this.currentLearnIndex >= this.learnCards.length - 1 ? 'disabled' : ''}>\n\t\t\t\t\t\t次のカード →\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachLearnCardListeners();\n\t}\n\n\t/**\n\t * 学習カードのイベントリスナー\n\t */\n\tprivate attachLearnCardListeners(): void {\n\t\t//! 設定に戻るボタン。\n\t\tconst backToSetupBtn = document.getElementById('back-to-setup-btn');\n\t\tbackToSetupBtn?.addEventListener('click', () => {\n\t\t\tthis.learnCards = [];\n\t\t\tthis.currentLearnIndex = 0;\n\t\t\tthis.isFlipped = false;\n\t\t\tthis.renderLearnSetup();\n\t\t});\n\n\t\t//! フリップボタン。\n\t\tconst flipCardBtn = document.getElementById('flip-card-btn');\n\t\tflipCardBtn?.addEventListener('click', () => {\n\t\t\tthis.isFlipped = !this.isFlipped;\n\t\t\tthis.renderLearnCard();\n\t\t});\n\n\t\t//! スペースキーでフリップ。\n\t\tconst spaceHandler = (e: KeyboardEvent) => {\n\t\t\tif (e.code === 'Space' && e.target === document.body) {\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.isFlipped = !this.isFlipped;\n\t\t\t\tthis.renderLearnCard();\n\t\t\t}\n\t\t};\n\t\tdocument.addEventListener('keydown', spaceHandler);\n\n\t\t//! モールス再生ボタン。\n\t\tconst playMorseBtn = document.getElementById('play-morse-btn');\n\t\tif (playMorseBtn) {\n\t\t\tplayMorseBtn.addEventListener('click', () => {\n\t\t\t\tconst card = this.learnCards[this.currentLearnIndex];\n\t\t\t\tthis.playMorse(card.abbreviation);\n\t\t\t});\n\t\t}\n\n\t\t//! 判定ボタン（わからない）。\n\t\tconst markUnknownBtn = document.getElementById('mark-unknown-btn');\n\t\tmarkUnknownBtn?.addEventListener('click', () => {\n\t\t\tconst card = this.learnCards[this.currentLearnIndex];\n\t\t\tthis.progress.unknown.add(card.abbreviation);\n\t\t\tthis.progress.known.delete(card.abbreviation);\n\t\t\tthis.saveProgress();\n\t\t\tthis.moveToNextCard();\n\t\t});\n\n\t\t//! 判定ボタン（わかる）。\n\t\tconst markKnownBtn = document.getElementById('mark-known-btn');\n\t\tmarkKnownBtn?.addEventListener('click', () => {\n\t\t\tconst card = this.learnCards[this.currentLearnIndex];\n\t\t\tthis.progress.known.add(card.abbreviation);\n\t\t\tthis.progress.unknown.delete(card.abbreviation);\n\t\t\tthis.saveProgress();\n\t\t\tthis.moveToNextCard();\n\t\t});\n\n\t\t//! 前のカードボタン。\n\t\tconst prevCardBtn = document.getElementById('prev-card-btn');\n\t\tprevCardBtn?.addEventListener('click', () => {\n\t\t\tif (this.currentLearnIndex > 0) {\n\t\t\t\tthis.currentLearnIndex--;\n\t\t\t\tthis.isFlipped = false;\n\t\t\t\tthis.renderLearnCard();\n\t\t\t}\n\t\t});\n\n\t\t//! 次のカードボタン。\n\t\tconst nextCardBtn = document.getElementById('next-card-btn');\n\t\tnextCardBtn?.addEventListener('click', () => {\n\t\t\tif (this.currentLearnIndex < this.learnCards.length - 1) {\n\t\t\t\tthis.currentLearnIndex++;\n\t\t\t\tthis.isFlipped = false;\n\t\t\t\tthis.renderLearnCard();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * 次のカードに移動する（判定ボタンクリック時の自動遷移用）\n\t */\n\tprivate moveToNextCard(): void {\n\t\tif (this.currentLearnIndex < this.learnCards.length - 1) {\n\t\t\t//! 次のカードがあれば移動。\n\t\t\tthis.currentLearnIndex++;\n\t\t\tthis.isFlipped = false;\n\t\t\tthis.renderLearnCard();\n\t\t} else {\n\t\t\t//! 最後のカードの場合は学習完了。\n\t\t\talert('学習完了しました！');\n\t\t\tthis.learnCards = [];\n\t\t\tthis.currentLearnIndex = 0;\n\t\t\tthis.isFlipped = false;\n\t\t\tthis.renderLearnSetup();\n\t\t}\n\t}\n\n\t/**\n\t * 試験モードをレンダリング\n\t */\n\tprivate renderExamMode(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tif (this.questions.length === 0) {\n\t\t\t// 試験設定画面\n\t\t\tthis.renderExamSetup();\n\t\t} else {\n\t\t\t// 試験実施画面\n\t\t\tthis.renderExamQuestion();\n\t\t}\n\t}\n\n\t/**\n\t * 試験設定画面\n\t */\n\tprivate renderExamSetup(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t<h1>CW略語・Q符号学習</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"tabs\">\n\t\t\t\t\t<button class=\"tab-button\" data-tab=\"browse\">一覧</button>\n\t\t\t\t\t<button class=\"tab-button\" data-tab=\"learn\">学習モード</button>\n\t\t\t\t\t<button class=\"tab-button active\" data-tab=\"exam\">試験モード</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"flashcard-container\">\n\t\t\t\t\t${this.renderFilterSection()}\n\n\t\t\t\t\t<div class=\"exam-setup-section\">\n\t\t\t\t\t\t<h3>出題形式</h3>\n\t\t\t\t\t\t<div class=\"question-type-buttons\">\n\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.questionType === 'abbr-to-meaning' ? 'active' : ''}\" data-type=\"abbr-to-meaning\">略語→意味（基礎）</button>\n\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.questionType === 'meaning-to-abbr' ? 'active' : ''}\" data-type=\"meaning-to-abbr\">意味→略語（応用）</button>\n\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.questionType === 'morse-to-abbr' ? 'active' : ''}\" data-type=\"morse-to-abbr\">モールス音→略語（実践）</button>\n\t\t\t\t\t\t\t<button class=\"question-type-btn ${this.questionType === 'morse-to-meaning' ? 'active' : ''}\" data-type=\"morse-to-meaning\">モールス音→意味（実践）</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<h3>問題数</h3>\n\t\t\t\t\t\t<div class=\"question-count-buttons\">\n\t\t\t\t\t\t\t<button class=\"question-count-btn ${this.questionCount === 5 ? 'active' : ''}\" data-count=\"5\">5問</button>\n\t\t\t\t\t\t\t<button class=\"question-count-btn ${this.questionCount === 10 ? 'active' : ''}\" data-count=\"10\">10問</button>\n\t\t\t\t\t\t\t<button class=\"question-count-btn ${this.questionCount === 20 ? 'active' : ''}\" data-count=\"20\">20問</button>\n\t\t\t\t\t\t\t<button class=\"question-count-btn ${this.questionCount === 50 ? 'active' : ''}\" data-count=\"50\">50問</button>\n\t\t\t\t\t\t\t<button class=\"question-count-btn ${this.questionCount === 'all' ? 'active' : ''}\" data-count=\"all\">全問</button>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class=\"action-area\">\n\t\t\t\t\t\t\t<button class=\"btn btn-large btn-primary\" id=\"start-exam-btn\">試験開始</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>フィルターで出題範囲を絞り込みます</li>\n\t\t\t\t\t\t\t<li>出題形式を選択します（略語→意味、意味→略語、モールス音から）</li>\n\t\t\t\t\t\t\t<li>問題数を選択します（5問〜全問）</li>\n\t\t\t\t\t\t\t<li>4つの選択肢から正解を選びます</li>\n\t\t\t\t\t\t\t<li>80%以上で合格です</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachExamSetupListeners();\n\t}\n\n\t/**\n\t * 試験問題画面\n\t */\n\tprivate renderExamQuestion(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tconst question = this.questions[this.currentQuestionIndex];\n\t\tconst progress = this.currentQuestionIndex + 1;\n\t\tconst total = this.questions.length;\n\n\t\tlet questionText = '';\n\t\tswitch (question.type) {\n\t\t\tcase 'abbr-to-meaning':\n\t\t\t\tquestionText = `次の略語の意味は？<br><strong class=\"question-text\">${question.entry.abbreviation}</strong>`;\n\t\t\t\tbreak;\n\t\t\tcase 'meaning-to-abbr':\n\t\t\t\tquestionText = `次の意味を表す略語は？<br><strong class=\"question-text\">${question.entry.english} / ${question.entry.japanese}</strong>`;\n\t\t\t\tbreak;\n\t\t\tcase 'morse-to-abbr':\n\t\t\t\tquestionText = `モールス音を聞いて、対応する略語は？<br><button id=\"replay-morse-btn\" class=\"btn btn-secondary\">🔊 もう一度再生</button>`;\n\t\t\t\tbreak;\n\t\t\tcase 'morse-to-meaning':\n\t\t\t\tquestionText = `モールス音を聞いて、対応する意味は？<br><button id=\"replay-morse-btn\" class=\"btn btn-secondary\">🔊 もう一度再生</button>`;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<h1>CW略語・Q符号学習 - 試験中</h1>\n\t\t\t\t\t<button class=\"back-btn\">中断</button>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"exam-container\">\n\t\t\t\t\t<div class=\"exam-progress\">\n\t\t\t\t\t\t<span>問題 <strong>${progress}</strong> / ${total}</span>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"question-area\">\n\t\t\t\t\t\t<p class=\"question\">${questionText}</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"choices-area\">\n\t\t\t\t\t\t${question.choices.map((choice, index) => `\n\t\t\t\t\t\t\t<button class=\"choice-btn\" data-choice=\"${choice}\">\n\t\t\t\t\t\t\t\t${index + 1}. ${choice}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t`).join('')}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachExamQuestionListeners();\n\n\t\t//! モールス音が必要な場合は自動再生。\n\t\tif (question.type === 'morse-to-abbr' || question.type === 'morse-to-meaning') {\n\t\t\tsetTimeout(() => this.playMorse(question.entry.abbreviation), 500);\n\t\t}\n\t}\n\n\t/**\n\t * 試験結果画面\n\t */\n\tprivate renderExamResultMode(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tconst score = FlashcardTrainer.calculateScore(this.results);\n\t\tconst isPassed = FlashcardTrainer.isPassed(score.percentage);\n\t\tconst wrongAnswers = FlashcardTrainer.getWrongAnswers(this.results);\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<h1>CW略語・Q符号学習 - 結果</h1>\n\t\t\t\t\t<button class=\"back-btn\">メニューに戻る</button>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"result-container\">\n\t\t\t\t\t<div class=\"score-area ${isPassed ? 'passed' : 'failed'}\">\n\t\t\t\t\t\t<h2>${isPassed ? '合格！' : '不合格'}</h2>\n\t\t\t\t\t\t<div class=\"score-display\">\n\t\t\t\t\t\t\t<span class=\"score-percentage\">${score.percentage}%</span>\n\t\t\t\t\t\t\t<span class=\"score-detail\">${score.correct} / ${score.total} 問正解</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t${wrongAnswers.length > 0 ? `\n\t\t\t\t\t\t<div class=\"wrong-answers-section\">\n\t\t\t\t\t\t\t<h3>間違えた問題（${wrongAnswers.length}件）</h3>\n\t\t\t\t\t\t\t<div class=\"wrong-answers-list\">\n\t\t\t\t\t\t\t\t${this.results.filter(r => !r.isCorrect).map(result => `\n\t\t\t\t\t\t\t\t\t<div class=\"wrong-answer-item\">\n\t\t\t\t\t\t\t\t\t\t<div class=\"wrong-answer-question\">\n\t\t\t\t\t\t\t\t\t\t\t<strong>${result.question.entry.abbreviation}</strong>\n\t\t\t\t\t\t\t\t\t\t\t<span>${result.question.entry.english} / ${result.question.entry.japanese}</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class=\"wrong-answer-detail\">\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"wrong-label\">あなたの回答:</span>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"wrong-user-answer\">${result.userAnswer}</span>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"correct-label\">正解:</span>\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"correct-answer\">${result.question.correctAnswer}</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t${result.question.entry.description ? `\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"wrong-answer-description\">\n\t\t\t\t\t\t\t\t\t\t\t\t${result.question.entry.description}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t` : ''}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t`).join('')}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t` : `\n\t\t\t\t\t\t<div class=\"perfect-score\">\n\t\t\t\t\t\t\t<p>すべて正解しました！</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`}\n\n\t\t\t\t\t<div class=\"action-area\">\n\t\t\t\t\t\t<button class=\"btn btn-primary btn-large\" id=\"retry-btn\">もう一度</button>\n\t\t\t\t\t\t<button class=\"btn btn-secondary btn-large\" id=\"back-to-setup-btn\">設定に戻る</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachResultListeners();\n\t}\n\n\t/**\n\t * browseモードのイベントリスナーを設定\n\t */\n\tprivate attachBrowseModeListeners(): void {\n\t\tthis.attachCommonListeners();\n\n\t\t//! タグフィルター。\n\t\tconst tagFilter = document.getElementById('tag-filter');\n\t\ttagFilter?.addEventListener('change', (e) => {\n\t\t\tconst target = e.target as HTMLInputElement;\n\t\t\tif (target.type === 'checkbox') {\n\t\t\t\tif (target.checked) {\n\t\t\t\t\tthis.selectedTags.add(target.value);\n\t\t\t\t} else {\n\t\t\t\t\tthis.selectedTags.delete(target.value);\n\t\t\t\t}\n\t\t\t\tthis.saveFilters();\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\tthis.updateFilteredCount();\n\t\t\t\tthis.renderEntries();\n\t\t\t}\n\t\t});\n\n\t\t//! 使用頻度フィルター。\n\t\tconst frequencyFilter = document.getElementById('frequency-filter');\n\t\tfrequencyFilter?.addEventListener('change', (e) => {\n\t\t\tconst target = e.target as HTMLInputElement;\n\t\t\tif (target.type === 'checkbox') {\n\t\t\t\tconst freq = parseInt(target.value, 10);\n\t\t\t\tif (target.checked) {\n\t\t\t\t\tthis.selectedFrequencies.add(freq);\n\t\t\t\t} else {\n\t\t\t\t\tthis.selectedFrequencies.delete(freq);\n\t\t\t\t}\n\t\t\t\tthis.saveFilters();\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\tthis.updateFilteredCount();\n\t\t\t\tthis.renderEntries();\n\t\t\t}\n\t\t});\n\n\t\t//! 検索。\n\t\tconst searchInput = document.getElementById('search-input') as HTMLInputElement;\n\t\tsearchInput?.addEventListener('input', () => {\n\t\t\tthis.searchQuery = searchInput.value;\n\t\t\tthis.saveFilters();\n\t\t\tthis.updateFilteredEntries();\n\t\t\tthis.updateFilteredCount();\n\t\t\tthis.renderEntries();\n\t\t});\n\t}\n\n\t/**\n\t * 試験設定のイベントリスナーを設定\n\t */\n\tprivate attachExamSetupListeners(): void {\n\t\tthis.attachCommonListeners();\n\n\t\t//! タグフィルター。\n\t\tconst tagFilter = document.getElementById('tag-filter');\n\t\ttagFilter?.addEventListener('change', (e) => {\n\t\t\tconst target = e.target as HTMLInputElement;\n\t\t\tif (target.type === 'checkbox') {\n\t\t\t\tif (target.checked) {\n\t\t\t\t\tthis.selectedTags.add(target.value);\n\t\t\t\t} else {\n\t\t\t\t\tthis.selectedTags.delete(target.value);\n\t\t\t\t}\n\t\t\t\tthis.saveFilters();\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\tthis.updateFilteredCount();\n\t\t\t}\n\t\t});\n\n\t\t//! 使用頻度フィルター。\n\t\tconst frequencyFilter = document.getElementById('frequency-filter');\n\t\tfrequencyFilter?.addEventListener('change', (e) => {\n\t\t\tconst target = e.target as HTMLInputElement;\n\t\t\tif (target.type === 'checkbox') {\n\t\t\t\tconst freq = parseInt(target.value, 10);\n\t\t\t\tif (target.checked) {\n\t\t\t\t\tthis.selectedFrequencies.add(freq);\n\t\t\t\t} else {\n\t\t\t\t\tthis.selectedFrequencies.delete(freq);\n\t\t\t\t}\n\t\t\t\tthis.saveFilters();\n\t\t\t\tthis.updateFilteredEntries();\n\t\t\t\tthis.updateFilteredCount();\n\t\t\t}\n\t\t});\n\n\t\t//! 検索。\n\t\tconst searchInput = document.getElementById('search-input') as HTMLInputElement;\n\t\tsearchInput?.addEventListener('input', () => {\n\t\t\tthis.searchQuery = searchInput.value;\n\t\t\tthis.saveFilters();\n\t\t\tthis.updateFilteredEntries();\n\t\t\tthis.updateFilteredCount();\n\t\t});\n\n\t\t//! 出題形式ボタン。\n\t\tconst questionTypeBtns = document.querySelectorAll('.question-type-btn');\n\t\tquestionTypeBtns.forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst type = btn.getAttribute('data-type') as QuestionType;\n\t\t\t\tif (type) {\n\t\t\t\t\tthis.questionType = type;\n\t\t\t\t\tFlashcardState.saveExamQuestionType(this.questionType as LearnQuestionType);\n\t\t\t\t\tthis.renderExamSetup();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! 問題数ボタン。\n\t\tconst questionCountBtns = document.querySelectorAll('.question-count-btn');\n\t\tquestionCountBtns.forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst count = btn.getAttribute('data-count');\n\t\t\t\tif (count) {\n\t\t\t\t\tthis.questionCount = count === 'all' ? 'all' : parseInt(count, 10);\n\t\t\t\t\tthis.renderExamSetup();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! 試験開始ボタン。\n\t\tconst startExamBtn = document.getElementById('start-exam-btn');\n\t\tstartExamBtn?.addEventListener('click', () => {\n\t\t\tthis.startExam();\n\t\t});\n\t}\n\n\t/**\n\t * 試験問題のイベントリスナーを設定\n\t */\n\tprivate attachExamQuestionListeners(): void {\n\t\t//! 中断ボタン。\n\t\tconst backBtn = document.querySelector('.back-btn');\n\t\tbackBtn?.addEventListener('click', () => {\n\t\t\tif (confirm('試験を中断してメニューに戻りますか？')) {\n\t\t\t\twindow.location.hash = '#menu';\n\t\t\t}\n\t\t});\n\n\t\t//! モールス再生ボタン。\n\t\tconst replayBtn = document.getElementById('replay-morse-btn');\n\t\tif (replayBtn) {\n\t\t\tconst question = this.questions[this.currentQuestionIndex];\n\t\t\treplayBtn.addEventListener('click', () => {\n\t\t\t\tthis.playMorse(question.entry.abbreviation);\n\t\t\t});\n\t\t}\n\n\t\t//! 選択肢ボタン。\n\t\tconst choiceBtns = document.querySelectorAll('.choice-btn');\n\t\tchoiceBtns.forEach(btn => {\n\t\t\tbtn.addEventListener('click', (e) => {\n\t\t\t\tconst target = e.currentTarget as HTMLButtonElement;\n\t\t\t\tconst userAnswer = target.dataset.choice || '';\n\t\t\t\tthis.handleAnswer(userAnswer);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * 結果画面のイベントリスナーを設定\n\t */\n\tprivate attachResultListeners(): void {\n\t\t//! 戻るボタン。\n\t\tconst backBtn = document.querySelector('.back-btn');\n\t\tbackBtn?.addEventListener('click', () => {\n\t\t\twindow.location.hash = '#menu';\n\t\t});\n\n\t\t//! もう一度ボタン。\n\t\tconst retryBtn = document.getElementById('retry-btn');\n\t\tretryBtn?.addEventListener('click', () => {\n\t\t\tthis.questions = [];\n\t\t\tthis.results = [];\n\t\t\tthis.currentQuestionIndex = 0;\n\t\t\tthis.currentState = 'exam';\n\t\t\tthis.render();\n\t\t});\n\n\t\t//! 設定に戻るボタン。\n\t\tconst backToSetupBtn = document.getElementById('back-to-setup-btn');\n\t\tbackToSetupBtn?.addEventListener('click', () => {\n\t\t\tthis.questions = [];\n\t\t\tthis.results = [];\n\t\t\tthis.currentQuestionIndex = 0;\n\t\t\tthis.currentState = 'exam';\n\t\t\tthis.render();\n\t\t});\n\t}\n\n\t/**\n\t * 共通のイベントリスナーを設定（タブ切り替えなど）\n\t */\n\tprivate attachCommonListeners(): void {\n\t\t//! 戻るボタン。\n\t\tconst backBtn = document.querySelector('.back-btn');\n\t\tbackBtn?.addEventListener('click', () => {\n\t\t\twindow.location.hash = '#menu';\n\t\t});\n\n\t\t//! 設定アイコン。\n\t\tdocument.getElementById('settingsIcon')?.addEventListener('click', () => {\n\t\t\tthis.openSettingsModal();\n\t\t});\n\n\t\t//! タブ切り替え。\n\t\tconst tabButtons = document.querySelectorAll('.tab-button');\n\t\ttabButtons.forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst tab = btn.getAttribute('data-tab');\n\t\t\t\tif (tab === 'browse') {\n\t\t\t\t\tthis.currentState = 'browse';\n\t\t\t\t\tFlashcardState.saveViewMode('browse');\n\t\t\t\t\tthis.render();\n\t\t\t\t} else if (tab === 'learn') {\n\t\t\t\t\tthis.currentState = 'learn';\n\t\t\t\t\tFlashcardState.saveViewMode('learn');\n\t\t\t\t\tthis.render();\n\t\t\t\t} else if (tab === 'exam') {\n\t\t\t\t\tthis.questions = [];\n\t\t\t\t\tthis.results = [];\n\t\t\t\t\tthis.currentQuestionIndex = 0;\n\t\t\t\t\tthis.currentState = 'exam';\n\t\t\t\t\tFlashcardState.saveViewMode('exam');\n\t\t\t\t\tthis.render();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * フィルター適用後のエントリー数を更新\n\t */\n\tprivate updateFilteredCount(): void {\n\t\tconst filteredCountElem = document.getElementById('filtered-count');\n\t\tif (filteredCountElem) {\n\t\t\tfilteredCountElem.textContent = this.filteredEntries.length.toString();\n\t\t}\n\n\t\t//! 問題数の最大値も更新（試験モードの場合）。\n\t\tconst questionCountInput = document.getElementById('question-count') as HTMLInputElement;\n\t\tif (questionCountInput) {\n\t\t\tquestionCountInput.max = this.filteredEntries.length.toString();\n\t\t\tif (parseInt(questionCountInput.value, 10) > this.filteredEntries.length) {\n\t\t\t\tquestionCountInput.value = this.filteredEntries.length.toString();\n\t\t\t\tthis.questionCount = this.filteredEntries.length;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * フィルタリングされたエントリーを更新\n\t */\n\tprivate updateFilteredEntries(): void {\n\t\tlet entries = this.allEntries;\n\n\t\t//! タグでフィルタリング。\n\t\tentries = FlashcardTrainer.filterByTags(entries, this.selectedTags);\n\n\t\t//! 使用頻度でフィルタリング。\n\t\tentries = FlashcardTrainer.filterByFrequencies(entries, this.selectedFrequencies);\n\n\t\t//! 検索クエリでフィルタリング。\n\t\tentries = FlashcardTrainer.filterByQuery(entries, this.searchQuery);\n\n\t\t//! ソート適用。\n\t\tthis.filteredEntries = this.sortEntries(entries);\n\t}\n\n\t/**\n\t * エントリーをソート\n\t */\n\tprivate sortEntries(entries: FlashcardEntry[]): FlashcardEntry[] {\n\t\tconst ascending = this.sortDirection === 'asc';\n\n\t\tswitch (this.sortColumn) {\n\t\t\tcase 'abbreviation':\n\t\t\t\treturn FlashcardTrainer.sortByAbbreviation(entries, ascending);\n\t\t\tcase 'english':\n\t\t\t\treturn FlashcardTrainer.sortByEnglish(entries, ascending);\n\t\t\tcase 'japanese':\n\t\t\t\treturn FlashcardTrainer.sortByJapanese(entries, ascending);\n\t\t\tcase 'frequency':\n\t\t\t\treturn FlashcardTrainer.sortByFrequency(entries, ascending);\n\t\t\tcase 'tags':\n\t\t\t\treturn FlashcardTrainer.sortByTags(entries, ascending);\n\t\t\tdefault:\n\t\t\t\treturn entries;\n\t\t}\n\t}\n\n\t/**\n\t * ソートを切り替え\n\t */\n\tprivate toggleSort(column: SortColumn): void {\n\t\tif (this.sortColumn === column) {\n\t\t\t//! 同じ列なら方向を反転。\n\t\t\tthis.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';\n\t\t} else {\n\t\t\t//! 異なる列なら昇順で開始。\n\t\t\tthis.sortColumn = column;\n\t\t\tthis.sortDirection = 'asc';\n\t\t}\n\t\t//! ソート状態を保存。\n\t\tFlashcardState.saveSortState(this.sortColumn, this.sortDirection);\n\t\tthis.updateFilteredEntries();\n\t\tthis.renderEntries();\n\t}\n\n\t/**\n\t * ソートインジケーターを取得\n\t */\n\tprivate getSortIndicator(column: SortColumn): string {\n\t\tif (this.sortColumn !== column) return '';\n\t\treturn this.sortDirection === 'asc' ? ' ▲' : ' ▼';\n\t}\n\n\t/**\n\t * 略語をフォーマット（プロサインをオーバーラインで表示）\n\t */\n\tprivate formatAbbreviation(abbr: string): string {\n\t\tconst prosignMatch = abbr.match(/^\\[([A-Z]+)\\]$/);\n\t\tif (prosignMatch) {\n\t\t\treturn `<span class=\"prosign\">${prosignMatch[1]}</span>`;\n\t\t}\n\t\treturn abbr;\n\t}\n\n\t/**\n\t * モールス符号を再生\n\t */\n\tprivate async playMorse(text: string): Promise<void> {\n\t\ttry {\n\t\t\t//! 既に再生中の場合は停止。\n\t\t\tif (this.currentlyPlaying === text) {\n\t\t\t\tthis.audio.stopContinuousTone();\n\t\t\t\tthis.currentlyPlaying = null;\n\t\t\t\tthis.renderEntries();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//! 別のものが再生中なら停止。\n\t\t\tif (this.currentlyPlaying) {\n\t\t\t\tthis.audio.stopContinuousTone();\n\t\t\t}\n\n\t\t\tthis.currentlyPlaying = text;\n\t\t\tthis.renderEntries();\n\n\t\t\t//! モールス符号に変換。\n\t\t\tconst morseSequence = MorseCodec.textToMorse(text);\n\t\t\tif (morseSequence) {\n\t\t\t\t//! シンプルな再生実装（scheduleToneを使用）。\n\t\t\t\tfor (const char of morseSequence) {\n\t\t\t\t\tif (char === '.') {\n\t\t\t\t\t\tthis.audio.scheduleTone(0, 60);  // 短点\n\t\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 120));\n\t\t\t\t\t} else if (char === '-') {\n\t\t\t\t\t\tthis.audio.scheduleTone(0, 180);  // 長点\n\t\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 240));\n\t\t\t\t\t} else if (char === ' ') {\n\t\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 60));  // 要素間スペース\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.currentlyPlaying = null;\n\t\t\tthis.renderEntries();\n\t\t} catch (error) {\n\t\t\tconsole.error('モールス再生エラー:', error);\n\t\t\tthis.currentlyPlaying = null;\n\t\t\tthis.renderEntries();\n\t\t}\n\t}\n\n\t/**\n\t * 試験を開始\n\t */\n\tprivate startExam(): void {\n\t\tif (this.filteredEntries.length === 0) {\n\t\t\talert('該当するエントリーがありません。フィルターを調整してください。');\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = this.questionCount === 'all' ? this.filteredEntries.length : this.questionCount;\n\t\tconst actualCount = Math.min(count, this.filteredEntries.length);\n\t\tif (actualCount === 0) {\n\t\t\talert('問題数を1以上に設定してください。');\n\t\t\treturn;\n\t\t}\n\n\t\t//! 問題を生成。\n\t\tthis.questions = FlashcardTrainer.generateExamQuestions(\n\t\t\tthis.filteredEntries,\n\t\t\tthis.questionType,\n\t\t\tactualCount\n\t\t);\n\n\t\tthis.currentQuestionIndex = 0;\n\t\tthis.results = [];\n\t\tthis.render();\n\t}\n\n\t/**\n\t * 回答を処理\n\t */\n\tprivate handleAnswer(userAnswer: string): void {\n\t\tconst question = this.questions[this.currentQuestionIndex];\n\t\tconst isCorrect = FlashcardTrainer.checkAnswer(question, userAnswer);\n\n\t\t//! 結果を記録。\n\t\tthis.results.push({\n\t\t\tquestion,\n\t\t\tuserAnswer,\n\t\t\tisCorrect\n\t\t});\n\n\t\t//! 次の問題に進むか結果表示。\n\t\tthis.currentQuestionIndex++;\n\t\tif (this.currentQuestionIndex < this.questions.length) {\n\t\t\tthis.render();\n\t\t} else {\n\t\t\tthis.currentState = 'exam-result';\n\t\t\tthis.render();\n\t\t}\n\t}\n\n\t/**\n\t * 設定モーダルを開く\n\t */\n\tprivate openSettingsModal(): void {\n\t\t//! 現在の設定値を取得（0-100の範囲に変換）。\n\t\tconst currentValues: SettingValues = {\n\t\t\tvolume: Math.round(this.audio.getVolume() * 100),\n\t\t\tfrequency: this.audio.getFrequency(),\n\t\t\twpm: this.audio.getWPM()\n\t\t};\n\n\t\t//! 設定変更前の値を保存（キャンセル時の復元用）。\n\t\tconst savedSettings = {\n\t\t\tvolume: this.audio.getVolume(),\n\t\t\tfrequency: this.audio.getFrequency(),\n\t\t\twpm: this.audio.getWPM()\n\t\t};\n\n\t\t//! SettingsModalを作成。\n\t\tconst modal = new SettingsModal(\n\t\t\t'flashcard-settings-modal',\n\t\t\tALL_SETTING_ITEMS,\n\t\t\tcurrentValues,\n\t\t\t{\n\t\t\t\tonSave: (values: SettingValues) => {\n\t\t\t\t\t//! 設定を保存。\n\t\t\t\t\tthis.audio.setVolume((values.volume as number) / 100);\n\t\t\t\t\tthis.audio.setFrequency(values.frequency as number);\n\t\t\t\t\tthis.audio.setWPM(values.wpm as number);\n\t\t\t\t},\n\t\t\t\tonCancel: () => {\n\t\t\t\t\t//! 設定を元に戻す。\n\t\t\t\t\tthis.audio.setVolume(savedSettings.volume);\n\t\t\t\t\tthis.audio.setFrequency(savedSettings.frequency);\n\t\t\t\t\tthis.audio.setWPM(savedSettings.wpm);\n\t\t\t\t},\n\t\t\t\tonTestPlay: async () => {\n\t\t\t\t\t//! テスト再生。\n\t\t\t\t\tawait this.playMorse('CQ');\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\t//! モーダルを表示。\n\t\tmodal.show('flashcard');\n\t}\n\n\t/**\n\t * ビューを破棄\n\t */\n\tdestroy(): void {\n\t\t//! 音声を停止。\n\t\tif (this.currentlyPlaying) {\n\t\t\tthis.audio.stopContinuousTone();\n\t\t}\n\t}\n}\n","/**\n * コッホ法トレーニングビュー\n */\n\nimport type { View } from '../../router';\nimport {\n\tKochTrainer,\n\tKOCH_SEQUENCE,\n\tAudioGenerator,\n\tMorseCodec,\n\ttype PracticeSettings\n} from 'morse-engine';\nimport { SettingsModal, ALL_SETTING_ITEMS, type SettingValues } from 'morse-engine';\n\ntype ViewMode = 'learning' | 'custom';\n\ninterface LessonState {\n\tcurrentLesson: number;\n\tisPlaying: boolean;\n\tuserInput: string;\n\tcorrectAnswer: string;\n\tgroups: string[];\n\tcurrentGroupIndex: number;\n}\n\ninterface CustomState {\n\tselectedChars: Set<string>;\n\tisCustomRunning: boolean;\n\tcustomUserInput: string;\n\tcustomCorrectAnswer: string;\n\tcustomGroups: string[];\n\tcustomCurrentGroupIndex: number;\n\tcustomIsPlaying: boolean;\n}\n\ninterface KochSettings {\n\tcharacterSpeed: number;\n\teffectiveSpeed: number;\n\tfrequency: number;\n\tvolume: number;\n\tpracticeDuration: number;\n\tgroupSize: number;\n\tshowInput: boolean;\n}\n\nconst DEFAULT_SETTINGS: KochSettings = {\n\tcharacterSpeed: 20,\n\teffectiveSpeed: 15,\n\tfrequency: 700,\n\tvolume: 0.7,\n\tpracticeDuration: 60,\n\tgroupSize: 5,\n\tshowInput: true\n};\n\n/**\n * コッホ法トレーニングビュークラス\n */\nexport class KochView implements View {\n\tprivate audio: AudioGenerator;\n\tprivate viewMode: ViewMode = 'learning';\n\tprivate settings: KochSettings = { ...DEFAULT_SETTINGS };\n\n\tprivate state: LessonState = {\n\t\tcurrentLesson: 1,\n\t\tisPlaying: false,\n\t\tuserInput: '',\n\t\tcorrectAnswer: '',\n\t\tgroups: [],\n\t\tcurrentGroupIndex: 0,\n\t};\n\n\tprivate customState: CustomState = {\n\t\tselectedChars: new Set(),\n\t\tisCustomRunning: false,\n\t\tcustomUserInput: '',\n\t\tcustomCorrectAnswer: '',\n\t\tcustomGroups: [],\n\t\tcustomCurrentGroupIndex: 0,\n\t\tcustomIsPlaying: false,\n\t};\n\n\tconstructor() {\n\t\t//! 設定を読み込む。\n\t\tthis.loadSettings();\n\t\tthis.loadProgress();\n\t\tthis.loadViewMode();\n\t\tthis.loadSelectedChars();\n\n\t\t//! AudioGeneratorを初期化。\n\t\tthis.audio = new AudioGenerator({\n\t\t\tfrequency: this.settings.frequency,\n\t\t\tvolume: this.settings.volume,\n\t\t\twpm: this.settings.characterSpeed,\n\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t});\n\t}\n\n\t//! ========== 設定管理 ==========\n\n\tprivate loadSettings(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.koch.settings');\n\t\t\tif (saved) {\n\t\t\t\tthis.settings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load settings:', error);\n\t\t}\n\t}\n\n\tprivate saveSettings(): void {\n\t\ttry {\n\t\t\tlocalStorage.setItem('v10.koch.settings', JSON.stringify(this.settings));\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save settings:', error);\n\t\t}\n\t}\n\n\tprivate loadProgress(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.koch.currentLesson');\n\t\t\tif (saved) {\n\t\t\t\tthis.state.currentLesson = parseInt(saved, 10);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load progress:', error);\n\t\t}\n\t}\n\n\tprivate saveProgress(): void {\n\t\ttry {\n\t\t\tlocalStorage.setItem('v10.koch.currentLesson', this.state.currentLesson.toString());\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save progress:', error);\n\t\t}\n\t}\n\n\tprivate loadViewMode(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.koch.viewMode') as ViewMode | null;\n\t\t\tif (saved && ['learning', 'custom'].includes(saved)) {\n\t\t\t\tthis.viewMode = saved;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load view mode:', error);\n\t\t}\n\t}\n\n\tprivate saveViewMode(): void {\n\t\ttry {\n\t\t\tlocalStorage.setItem('v10.koch.viewMode', this.viewMode);\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save view mode:', error);\n\t\t}\n\t}\n\n\tprivate loadSelectedChars(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.koch.selectedChars');\n\t\t\tif (saved) {\n\t\t\t\tconst chars = JSON.parse(saved) as string[];\n\t\t\t\tthis.customState.selectedChars = new Set(chars);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load selected chars:', error);\n\t\t}\n\t}\n\n\tprivate saveSelectedChars(): void {\n\t\ttry {\n\t\t\tconst chars = Array.from(this.customState.selectedChars);\n\t\t\tlocalStorage.setItem('v10.koch.selectedChars', JSON.stringify(chars));\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save selected chars:', error);\n\t\t}\n\t}\n\n\t//! ========== レッスン管理 ==========\n\n\tprivate async startLesson(): Promise<void> {\n\t\tconst chars = KochTrainer.getCharsForLesson(this.state.currentLesson);\n\t\tconst practiceSettings: PracticeSettings = {\n\t\t\tgroupSize: this.settings.groupSize,\n\t\t\tduration: this.settings.practiceDuration,\n\t\t\twpm: this.settings.characterSpeed\n\t\t};\n\t\tthis.state.groups = KochTrainer.generateRandomGroups(chars, practiceSettings);\n\t\tthis.state.currentGroupIndex = 0;\n\t\tthis.state.userInput = '';\n\t\tthis.state.correctAnswer = this.state.groups.join('');\n\t\tthis.state.isPlaying = false;\n\n\t\t//! AudioGeneratorの設定を更新。\n\t\tthis.audio.updateSettings({\n\t\t\tfrequency: this.settings.frequency,\n\t\t\tvolume: this.settings.volume,\n\t\t\twpm: this.settings.characterSpeed,\n\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t});\n\n\t\tthis.renderPractice();\n\t}\n\n\tprivate async playMorse(): Promise<void> {\n\t\tif (this.state.isPlaying) return;\n\n\t\tthis.state.isPlaying = true;\n\t\tthis.state.currentGroupIndex = 0;\n\t\tthis.updateProgress();\n\t\tthis.updatePlaybackButtons();\n\n\t\t//! モールス信号を再生。\n\t\tfor (let i = 0; i < this.state.groups.length && this.state.isPlaying; i++) {\n\t\t\tconst group = this.state.groups[i];\n\t\t\tconst morse = MorseCodec.textToMorse(group);\n\t\t\tawait this.audio.playMorseString(morse + ' /');\n\n\t\t\tthis.state.currentGroupIndex = i + 1;\n\t\t\tthis.updateProgress();\n\t\t}\n\n\t\tthis.state.isPlaying = false;\n\t\tthis.updatePlaybackButtons();\n\t\tif (this.state.currentGroupIndex >= this.state.groups.length) {\n\t\t\tthis.showResult();\n\t\t}\n\t}\n\n\tprivate pauseMorse(): void {\n\t\tthis.state.isPlaying = false;\n\t\tthis.audio.stopPlaying();\n\t\tthis.updatePlaybackButtons();\n\t}\n\n\tprivate stopLesson(): void {\n\t\tthis.state.isPlaying = false;\n\t\tthis.audio.stopPlaying();\n\t\tthis.render();\n\t}\n\n\tprivate showResult(): void {\n\t\tconst accuracy = KochTrainer.calculateAccuracy(this.state.correctAnswer, this.state.userInput);\n\t\tconst passed = accuracy >= 90;\n\n\t\tconst resultContainer = document.getElementById('resultContainer');\n\t\tif (!resultContainer) return;\n\n\t\tresultContainer.innerHTML = `\n\t\t\t<div class=\"result ${passed ? 'passed' : 'failed'}\">\n\t\t\t\t<h2>${passed ? '合格！' : '不合格'}</h2>\n\t\t\t\t<div class=\"accuracy\">正答率: ${accuracy.toFixed(1)}%</div>\n\t\t\t\t<div class=\"comparison\">\n\t\t\t\t\t<div>送信: ${this.state.correctAnswer}</div>\n\t\t\t\t\t<div>入力: ${this.state.userInput || '（未入力）'}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"actions\">\n\t\t\t\t\t${passed ? `<button class=\"btn primary\" id=\"nextLessonBtn\">次のレッスンへ</button>` : ''}\n\t\t\t\t\t<button class=\"btn\" id=\"retryBtn\">もう一度</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tif (passed && this.state.currentLesson < 40) {\n\t\t\tthis.state.currentLesson++;\n\t\t\tthis.saveProgress();\n\n\t\t\tdocument.getElementById('nextLessonBtn')?.addEventListener('click', () => {\n\t\t\t\tthis.render();\n\t\t\t});\n\t\t}\n\n\t\tdocument.getElementById('retryBtn')?.addEventListener('click', () => {\n\t\t\tthis.render();\n\t\t});\n\t}\n\n\tprivate updateProgress(): void {\n\t\tconst progressEl = document.getElementById('lessonProgress');\n\t\tconst progressBar = document.getElementById('progressBar');\n\n\t\tif (progressEl && progressBar) {\n\t\t\tconst percent = (this.state.currentGroupIndex / this.state.groups.length) * 100;\n\t\t\tprogressEl.textContent = `進行: ${this.state.currentGroupIndex}/${this.state.groups.length} (${percent.toFixed(0)}%)`;\n\t\t\tprogressBar.style.width = `${percent}%`;\n\t\t}\n\n\t\tthis.updatePlaybackButtons();\n\t}\n\n\tprivate updatePlaybackButtons(): void {\n\t\tconst playBtn = document.getElementById('playBtn') as HTMLButtonElement;\n\t\tconst pauseBtn = document.getElementById('pauseBtn') as HTMLButtonElement;\n\n\t\tif (playBtn && pauseBtn) {\n\t\t\tif (this.state.isPlaying) {\n\t\t\t\tplayBtn.disabled = true;\n\t\t\t\tpauseBtn.disabled = false;\n\t\t\t} else {\n\t\t\t\tplayBtn.disabled = false;\n\t\t\t\tpauseBtn.disabled = true;\n\t\t\t}\n\t\t}\n\t}\n\n\t//! ========== カスタムモード管理 ==========\n\n\tprivate async startCustom(): Promise<void> {\n\t\tconst chars = Array.from(this.customState.selectedChars);\n\t\tconst practiceSettings: PracticeSettings = {\n\t\t\tgroupSize: this.settings.groupSize,\n\t\t\tduration: this.settings.practiceDuration,\n\t\t\twpm: this.settings.characterSpeed\n\t\t};\n\t\tthis.customState.customGroups = KochTrainer.generateRandomGroups(chars, practiceSettings);\n\t\tthis.customState.customCurrentGroupIndex = 0;\n\t\tthis.customState.customUserInput = '';\n\t\tthis.customState.customCorrectAnswer = this.customState.customGroups.join('');\n\t\tthis.customState.customIsPlaying = false;\n\t\tthis.customState.isCustomRunning = true;\n\n\t\t//! AudioGeneratorの設定を更新。\n\t\tthis.audio.updateSettings({\n\t\t\tfrequency: this.settings.frequency,\n\t\t\tvolume: this.settings.volume,\n\t\t\twpm: this.settings.characterSpeed,\n\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t});\n\n\t\tthis.render();\n\t\tthis.renderCustomPractice();\n\t}\n\n\tprivate async playCustomMorse(): Promise<void> {\n\t\tif (this.customState.customIsPlaying) return;\n\n\t\tthis.customState.customIsPlaying = true;\n\t\tthis.customState.customCurrentGroupIndex = 0;\n\t\tthis.updateCustomProgress();\n\t\tthis.updateCustomPlaybackButtons();\n\n\t\t//! モールス信号を再生。\n\t\tfor (let i = 0; i < this.customState.customGroups.length && this.customState.customIsPlaying; i++) {\n\t\t\tconst group = this.customState.customGroups[i];\n\t\t\tconst morse = MorseCodec.textToMorse(group);\n\t\t\tawait this.audio.playMorseString(morse + ' /');\n\n\t\t\tthis.customState.customCurrentGroupIndex = i + 1;\n\t\t\tthis.updateCustomProgress();\n\t\t}\n\n\t\tthis.customState.customIsPlaying = false;\n\t\tthis.updateCustomPlaybackButtons();\n\t}\n\n\tprivate pauseCustomMorse(): void {\n\t\tthis.customState.customIsPlaying = false;\n\t\tthis.audio.stopPlaying();\n\t\tthis.updateCustomPlaybackButtons();\n\t}\n\n\tprivate stopCustom(): void {\n\t\tthis.customState.customIsPlaying = false;\n\t\tthis.audio.stopPlaying();\n\t\tthis.customState.isCustomRunning = false;\n\t\tthis.render();\n\t}\n\n\tprivate updateCustomProgress(): void {\n\t\tconst progressEl = document.getElementById('customProgress');\n\t\tconst progressBar = document.getElementById('customProgressBar');\n\n\t\tif (progressEl && progressBar) {\n\t\t\tconst percent = (this.customState.customCurrentGroupIndex / this.customState.customGroups.length) * 100;\n\t\t\tprogressEl.textContent = `進行: ${this.customState.customCurrentGroupIndex}/${this.customState.customGroups.length} (${percent.toFixed(0)}%)`;\n\t\t\tprogressBar.style.width = `${percent}%`;\n\t\t}\n\n\t\tthis.updateCustomPlaybackButtons();\n\t}\n\n\tprivate updateCustomPlaybackButtons(): void {\n\t\tconst playBtn = document.getElementById('customPlayBtn') as HTMLButtonElement;\n\t\tconst pauseBtn = document.getElementById('customPauseBtn') as HTMLButtonElement;\n\n\t\tif (playBtn && pauseBtn) {\n\t\t\tif (this.customState.customIsPlaying) {\n\t\t\t\tplayBtn.disabled = true;\n\t\t\t\tpauseBtn.disabled = false;\n\t\t\t} else {\n\t\t\t\tplayBtn.disabled = false;\n\t\t\t\tpauseBtn.disabled = true;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate showCustomResult(): void {\n\t\tconst resultContainer = document.getElementById('customResultContainer');\n\t\tif (!resultContainer) return;\n\n\t\t//! lib側の関数を使用して正答率を計算。\n\t\tconst accuracy = KochTrainer.calculateAccuracy(\n\t\t\tthis.customState.customCorrectAnswer,\n\t\t\tthis.customState.customUserInput\n\t\t);\n\n\t\tconst userAnswer = this.customState.customUserInput.replace(/\\s+/g, '');\n\t\tconst correctAnswer = this.customState.customCorrectAnswer.replace(/\\s+/g, '');\n\n\t\tresultContainer.innerHTML = `\n\t\t\t<div class=\"result\">\n\t\t\t\t<h2>練習結果</h2>\n\t\t\t\t<div class=\"accuracy\">正答率: ${accuracy}%</div>\n\t\t\t\t<div class=\"comparison\">\n\t\t\t\t\t<div>送信: ${correctAnswer}</div>\n\t\t\t\t\t<div>あなたの入力: ${userAnswer}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"actions\">\n\t\t\t\t\t<button id=\"retryCustomBtn\" class=\"btn\">もう一度</button>\n\t\t\t\t\t<button id=\"backToCustomMenuBtn\" class=\"btn primary\">戻る</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tdocument.getElementById('retryCustomBtn')?.addEventListener('click', () => {\n\t\t\tthis.customState.isCustomRunning = false;\n\t\t\tthis.render();\n\t\t\tthis.startCustom();\n\t\t});\n\n\t\tdocument.getElementById('backToCustomMenuBtn')?.addEventListener('click', () => {\n\t\t\tthis.customState.isCustomRunning = false;\n\t\t\tthis.render();\n\t\t});\n\t}\n\n\t//! ========== 設定モーダル ==========\n\n\tprivate showSettings(): void {\n\t\t//! 現在の設定値を取得（volumeを0-100の範囲に変換）。\n\t\tconst currentValues: SettingValues = {\n\t\t\tvolume: Math.round(this.settings.volume * 100),\n\t\t\tfrequency: this.settings.frequency,\n\t\t\twpm: this.settings.characterSpeed,\n\t\t\tcharacterSpeed: this.settings.characterSpeed,\n\t\t\teffectiveSpeed: this.settings.effectiveSpeed,\n\t\t\tpracticeDuration: this.settings.practiceDuration,\n\t\t\tgroupSize: this.settings.groupSize,\n\t\t\tshowInput: this.settings.showInput\n\t\t};\n\n\t\t//! 設定変更前の値を保存（キャンセル時の復元用）。\n\t\tconst savedSettings = { ...this.settings };\n\n\t\t//! SettingsModalを作成。\n\t\tconst modal = new SettingsModal(\n\t\t\t'koch-settings-modal',\n\t\t\tALL_SETTING_ITEMS,\n\t\t\tcurrentValues,\n\t\t\t{\n\t\t\t\tonSave: (values: SettingValues) => {\n\t\t\t\t\t//! 実効速度は文字速度を上限とする。\n\t\t\t\t\tlet effSpeed = values.effectiveSpeed as number;\n\t\t\t\t\tconst charSpeed = values.characterSpeed as number;\n\t\t\t\t\tif (effSpeed > charSpeed) {\n\t\t\t\t\t\teffSpeed = charSpeed;\n\t\t\t\t\t}\n\n\t\t\t\t\t//! 設定を保存。\n\t\t\t\t\tthis.settings.characterSpeed = charSpeed;\n\t\t\t\t\tthis.settings.effectiveSpeed = effSpeed;\n\t\t\t\t\tthis.settings.frequency = values.frequency as number;\n\t\t\t\t\tthis.settings.volume = (values.volume as number) / 100;\n\t\t\t\t\tthis.settings.practiceDuration = values.practiceDuration as number;\n\t\t\t\t\tthis.settings.groupSize = values.groupSize as number;\n\t\t\t\t\tthis.settings.showInput = values.showInput as boolean;\n\n\t\t\t\t\tthis.saveSettings();\n\n\t\t\t\t\t//! AudioGeneratorを更新。\n\t\t\t\t\tthis.audio.updateSettings({\n\t\t\t\t\t\tfrequency: this.settings.frequency,\n\t\t\t\t\t\tvolume: this.settings.volume,\n\t\t\t\t\t\twpm: this.settings.characterSpeed,\n\t\t\t\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t\t\t\t});\n\n\t\t\t\t\t//! 練習中の場合、表示を更新。\n\t\t\t\t\tif (this.state.groups.length > 0) {\n\t\t\t\t\t\tthis.renderPractice();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonCancel: () => {\n\t\t\t\t\t//! 設定を元に戻す。\n\t\t\t\t\tthis.settings = { ...savedSettings };\n\t\t\t\t\tthis.audio.updateSettings({\n\t\t\t\t\t\tfrequency: savedSettings.frequency,\n\t\t\t\t\t\tvolume: savedSettings.volume,\n\t\t\t\t\t\twpm: savedSettings.characterSpeed,\n\t\t\t\t\t\teffectiveWpm: savedSettings.effectiveSpeed\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\t//! モーダルを表示。\n\t\tmodal.show('koch');\n\t}\n\n\t//! ========== レンダリング ==========\n\n\trender(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button class=\"back-btn\" id=\"back-btn\">メニューに戻る</button>\n\t\t\t\t\t<h1>コッホ法トレーニング</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"tabs\">\n\t\t\t\t\t<button class=\"tab-button ${this.viewMode === 'learning' ? 'active' : ''}\" data-tab=\"learning\">基本学習</button>\n\t\t\t\t\t<button class=\"tab-button ${this.viewMode === 'custom' ? 'active' : ''}\" data-tab=\"custom\">任意文字列練習</button>\n\t\t\t\t</div>\n\n\t\t\t\t${this.renderModeContent()}\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachEventListeners();\n\t}\n\n\tprivate renderModeContent(): string {\n\t\tswitch (this.viewMode) {\n\t\t\tcase 'learning':\n\t\t\t\treturn this.renderLearningMode();\n\t\t\tcase 'custom':\n\t\t\t\treturn this.renderCustomMode();\n\t\t\tdefault:\n\t\t\t\treturn this.renderLearningMode();\n\t\t}\n\t}\n\n\tprivate renderLearningMode(): string {\n\t\tconst chars = KochTrainer.getCharsForLesson(this.state.currentLesson);\n\t\tconst lessonList = KOCH_SEQUENCE.slice(0, 40).map((_, index) => {\n\t\t\tconst lessonNum = index + 1;\n\t\t\tconst lessonChars = KochTrainer.getCharsForLesson(lessonNum);\n\t\t\tconst isCurrent = lessonNum === this.state.currentLesson;\n\t\t\tconst isPassed = lessonNum < this.state.currentLesson;\n\t\t\treturn `\n\t\t\t\t<div class=\"lesson-item ${isCurrent ? 'current' : ''} ${isPassed ? 'passed' : ''}\" data-lesson=\"${lessonNum}\">\n\t\t\t\t\t<div class=\"lesson-num\">L${lessonNum}</div>\n\t\t\t\t\t<div class=\"lesson-chars\">${lessonChars.join('')}</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}).join('');\n\n\t\treturn `\n\t\t\t<div class=\"flashcard-container\">\n\t\t\t\t<div class=\"lesson-info\">\n\t\t\t\t\t<h2>レッスン ${this.state.currentLesson} / 40</h2>\n\t\t\t\t\t<div class=\"chars\">学習文字: ${chars.join('')}</div>\n\t\t\t\t\t<button id=\"startBtn\" class=\"btn btn-primary\">練習開始</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div id=\"practiceContainer\"></div>\n\t\t\t\t<div id=\"resultContainer\"></div>\n\n\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t<ul>\n\t\t\t\t\t\t<li>「練習開始」をクリックしてモールス信号を聞く</li>\n\t\t\t\t\t\t<li>聞こえた文字を入力</li>\n\t\t\t\t\t\t<li>90%以上の正答率で次のレッスンへ</li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"lesson-list-section\">\n\t\t\t\t\t<h3>レッスン一覧</h3>\n\t\t\t\t\t<div class=\"lesson-list\">\n\t\t\t\t\t\t${lessonList}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tprivate renderCustomMode(): string {\n\t\tif (!this.customState.isCustomRunning) {\n\t\t\t//! 文字選択画面。\n\t\t\tconst charButtons = KOCH_SEQUENCE.map(char => `\n\t\t\t\t<button class=\"char-select-btn ${this.customState.selectedChars.has(char) ? 'selected' : ''}\" data-char=\"${char}\">\n\t\t\t\t\t${char}\n\t\t\t\t</button>\n\t\t\t`).join('');\n\n\t\t\treturn `\n\t\t\t\t<div class=\"flashcard-container\">\n\t\t\t\t\t<div class=\"lesson-info\">\n\t\t\t\t\t\t<h2>任意文字列練習モード</h2>\n\t\t\t\t\t\t<p>練習したい文字を選択してください（最低2文字）</p>\n\t\t\t\t\t\t<div class=\"char-selection\">\n\t\t\t\t\t\t\t${charButtons}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button id=\"startCustomBtn\" class=\"btn btn-primary\" ${this.customState.selectedChars.size < 2 ? 'disabled' : ''}>練習開始</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"instructions\">\n\t\t\t\t\t\t<h3>使い方</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>練習したい文字をクリックして選択</li>\n\t\t\t\t\t\t\t<li>2文字以上選択すると練習開始可能</li>\n\t\t\t\t\t\t\t<li>選択した文字のみでランダムな練習問題が生成されます</li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t} else {\n\t\t\t//! 練習実行画面。\n\t\t\treturn `\n\t\t\t\t<div class=\"flashcard-container\">\n\t\t\t\t\t<div id=\"customPracticeContainer\"></div>\n\t\t\t\t\t<div id=\"customResultContainer\"></div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}\n\t}\n\n\tprivate renderPractice(): void {\n\t\tconst practiceContainer = document.getElementById('practiceContainer');\n\t\tif (!practiceContainer) return;\n\n\t\tconst chars = KochTrainer.getCharsForLesson(this.state.currentLesson);\n\n\t\tpracticeContainer.innerHTML = `\n\t\t\t<div class=\"practice-area\">\n\t\t\t\t<div class=\"progress-section\">\n\t\t\t\t\t<div class=\"progress-bar-container\">\n\t\t\t\t\t\t<div id=\"progressBar\" class=\"progress-bar\" style=\"width: 0%\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id=\"lessonProgress\" class=\"progress-text\">準備完了 - 再生ボタンを押してください</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"playback-controls\">\n\t\t\t\t\t<button id=\"playBtn\" class=\"control-btn\" title=\"再生\">\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M8 5v14l11-7z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"pauseBtn\" class=\"control-btn\" title=\"一時停止\" disabled>\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M6 4h4v16H6V4zm8 0h4v16h-4V4z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"stopBtn\" class=\"control-btn\" title=\"停止\">\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<rect x=\"6\" y=\"6\" width=\"12\" height=\"12\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<textarea id=\"userInput\" class=\"input-area\" placeholder=\"聞こえた文字を入力...\" ${this.settings.showInput ? '' : 'style=\"opacity: 0.3; pointer-events: none;\"'}></textarea>\n\t\t\t\t${this.renderKeyboard(chars)}\n\t\t\t</div>\n\t\t`;\n\n\t\tconst inputEl = document.getElementById('userInput') as HTMLTextAreaElement;\n\t\tif (inputEl) {\n\t\t\tinputEl.addEventListener('input', (e) => {\n\t\t\t\tthis.state.userInput = (e.target as HTMLTextAreaElement).value.toUpperCase();\n\t\t\t});\n\t\t}\n\n\t\tdocument.getElementById('playBtn')?.addEventListener('click', () => {\n\t\t\tthis.playMorse();\n\t\t});\n\n\t\tdocument.getElementById('pauseBtn')?.addEventListener('click', () => {\n\t\t\tthis.pauseMorse();\n\t\t});\n\n\t\tdocument.getElementById('stopBtn')?.addEventListener('click', () => {\n\t\t\tthis.stopLesson();\n\t\t});\n\n\t\t//! キーボードボタンのイベント設定。\n\t\tthis.setupKeyboardEvents(chars);\n\t\tthis.updatePlaybackButtons();\n\t}\n\n\tprivate renderCustomPractice(): void {\n\t\tconst container = document.getElementById('customPracticeContainer');\n\t\tif (!container) return;\n\n\t\tcontainer.innerHTML = `\n\t\t\t<div class=\"practice-area\">\n\t\t\t\t<div class=\"progress-section\">\n\t\t\t\t\t<div class=\"progress-bar-container\">\n\t\t\t\t\t\t<div id=\"customProgressBar\" class=\"progress-bar\" style=\"width: 0%\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id=\"customProgress\" class=\"progress-text\">準備完了 - 再生ボタンを押してください</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"playback-controls\">\n\t\t\t\t\t<button id=\"customPlayBtn\" class=\"control-btn\" title=\"再生\">\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M8 5v14l11-7z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"customPauseBtn\" class=\"control-btn\" title=\"一時停止\" disabled>\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M6 4h4v16H6V4zm8 0h4v16h-4V4z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"customStopBtn\" class=\"control-btn\" title=\"停止\">\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<rect x=\"6\" y=\"6\" width=\"12\" height=\"12\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t${this.settings.showInput ? `\n\t\t\t\t\t<textarea id=\"customInputArea\" class=\"input-area\" placeholder=\"聞こえた文字を入力してください...\"></textarea>\n\t\t\t\t` : ''}\n\n\t\t\t\t<button id=\"customEndBtn\" class=\"btn btn-primary\">結果を見る</button>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.setupCustomControls();\n\t}\n\n\tprivate renderKeyboard(availableChars: string[]): string {\n\t\tconst groups: string[][] = [];\n\n\t\t//! KOCH_SEQUENCEをgroupSizeごとに分割。\n\t\tfor (let i = 0; i < KOCH_SEQUENCE.length; i += this.settings.groupSize) {\n\t\t\tgroups.push(KOCH_SEQUENCE.slice(i, i + this.settings.groupSize));\n\t\t}\n\n\t\treturn `\n\t\t\t<div class=\"keyboard\">\n\t\t\t\t<div class=\"keyboard-header\">\n\t\t\t\t\t<small>グループベースキーボード（学習済み文字のみ有効）</small>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"keyboard-controls\">\n\t\t\t\t\t<button id=\"spaceBtn\" class=\"key-btn special\">スペース</button>\n\t\t\t\t\t<button id=\"backspaceBtn\" class=\"key-btn special\">1字削除</button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"keyboard-groups-wrapper\">\n\t\t\t\t\t<div class=\"keyboard-groups\">\n\t\t\t\t\t\t${groups.map((group, groupIndex) => `\n\t\t\t\t\t\t\t<div class=\"keyboard-group\">\n\t\t\t\t\t\t\t\t<div class=\"group-label\">G${groupIndex + 1}</div>\n\t\t\t\t\t\t\t\t<div class=\"group-keys\">\n\t\t\t\t\t\t\t\t\t${group.map(char => {\n\t\t\t\t\t\t\t\t\t\tconst isLearned = availableChars.includes(char);\n\t\t\t\t\t\t\t\t\t\treturn `\n\t\t\t\t\t\t\t\t\t\t\t<button class=\"key-btn ${isLearned ? '' : 'disabled'}\"\n\t\t\t\t\t\t\t\t\t\t\t        data-char=\"${char}\"\n\t\t\t\t\t\t\t\t\t\t\t        ${isLearned ? '' : 'disabled'}>\n\t\t\t\t\t\t\t\t\t\t\t\t${char}\n\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t\t\t\t}).join('')}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`).join('')}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tprivate setupKeyboardEvents(availableChars: string[]): void {\n\t\tconst inputEl = document.getElementById('userInput') as HTMLTextAreaElement;\n\t\tif (!inputEl) return;\n\n\t\t//! 文字キー。\n\t\tdocument.querySelectorAll('.key-btn:not(.special)').forEach(btn => {\n\t\t\tbtn.addEventListener('click', (e) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst char = (e.target as HTMLButtonElement).getAttribute('data-char');\n\t\t\t\tif (char && availableChars.includes(char)) {\n\t\t\t\t\tinputEl.value += char;\n\t\t\t\t\tthis.state.userInput = inputEl.value.toUpperCase();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! スペースキー。\n\t\tdocument.getElementById('spaceBtn')?.addEventListener('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tinputEl.value += ' ';\n\t\t\tthis.state.userInput = inputEl.value.toUpperCase();\n\t\t});\n\n\t\t//! バックスペースキー。\n\t\tdocument.getElementById('backspaceBtn')?.addEventListener('click', (e) => {\n\t\t\te.preventDefault();\n\t\t\tinputEl.value = inputEl.value.slice(0, -1);\n\t\t\tthis.state.userInput = inputEl.value.toUpperCase();\n\t\t});\n\t}\n\n\tprivate setupCustomControls(): void {\n\t\t//! 入力欄のイベントリスナー。\n\t\tconst inputEl = document.getElementById('customInputArea') as HTMLTextAreaElement;\n\t\tif (inputEl) {\n\t\t\tinputEl.addEventListener('input', (e) => {\n\t\t\t\tthis.customState.customUserInput = (e.target as HTMLTextAreaElement).value.toUpperCase();\n\t\t\t});\n\t\t}\n\n\t\tdocument.getElementById('customPlayBtn')?.addEventListener('click', () => {\n\t\t\tthis.playCustomMorse();\n\t\t});\n\n\t\tdocument.getElementById('customPauseBtn')?.addEventListener('click', () => {\n\t\t\tthis.pauseCustomMorse();\n\t\t});\n\n\t\tdocument.getElementById('customStopBtn')?.addEventListener('click', () => {\n\t\t\tthis.stopCustom();\n\t\t});\n\n\t\tdocument.getElementById('customEndBtn')?.addEventListener('click', () => {\n\t\t\tthis.showCustomResult();\n\t\t});\n\n\t\tthis.updateCustomPlaybackButtons();\n\t}\n\n\tprivate attachEventListeners(): void {\n\t\t//! 戻るボタン。\n\t\tdocument.getElementById('back-btn')?.addEventListener('click', () => {\n\t\t\twindow.location.hash = '#menu';\n\t\t});\n\n\t\t//! 設定アイコン。\n\t\tdocument.getElementById('settingsIcon')?.addEventListener('click', () => {\n\t\t\tthis.showSettings();\n\t\t});\n\n\t\t//! タブボタン。\n\t\tdocument.querySelectorAll('.tab-button').forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst tab = btn.getAttribute('data-tab') as ViewMode;\n\t\t\t\tif (tab) {\n\t\t\t\t\tthis.viewMode = tab;\n\t\t\t\t\tthis.saveViewMode();\n\t\t\t\t\tthis.render();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! モード別のイベントリスナーを設定。\n\t\tthis.setupModeEventListeners();\n\t}\n\n\tprivate setupModeEventListeners(): void {\n\t\tif (this.viewMode === 'learning') {\n\t\t\tdocument.getElementById('startBtn')?.addEventListener('click', () => {\n\t\t\t\tthis.startLesson();\n\t\t\t});\n\n\t\t\t//! レッスンアイテムのクリックイベント。\n\t\t\tdocument.querySelectorAll('.lesson-item').forEach(item => {\n\t\t\t\titem.addEventListener('click', () => {\n\t\t\t\t\tconst lessonNum = parseInt(item.getAttribute('data-lesson') || '1', 10);\n\t\t\t\t\tthis.state.currentLesson = lessonNum;\n\t\t\t\t\tthis.saveProgress();\n\t\t\t\t\tthis.render();\n\t\t\t\t\twindow.scrollTo({ top: 0, behavior: 'smooth' });\n\t\t\t\t});\n\t\t\t});\n\t\t} else if (this.viewMode === 'custom') {\n\t\t\tif (!this.customState.isCustomRunning) {\n\t\t\t\tdocument.getElementById('startCustomBtn')?.addEventListener('click', () => {\n\t\t\t\t\tthis.startCustom();\n\t\t\t\t});\n\n\t\t\t\t//! 文字選択ボタン。\n\t\t\t\tdocument.querySelectorAll('.char-select-btn').forEach(btn => {\n\t\t\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\t\t\tconst char = btn.getAttribute('data-char');\n\t\t\t\t\t\tif (char) {\n\t\t\t\t\t\t\tif (this.customState.selectedChars.has(char)) {\n\t\t\t\t\t\t\t\tthis.customState.selectedChars.delete(char);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.customState.selectedChars.add(char);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis.saveSelectedChars();\n\t\t\t\t\t\t\tthis.render();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tdestroy(): void {\n\t\t//! 音声を停止。\n\t\tthis.audio.stopPlaying();\n\t}\n}\n","/**\n * 聞き取り練習ビュー\n */\n\nimport type { View } from '../../router';\nimport {\n\tListeningTrainer,\n\tAudioGenerator,\n\tMorseCodec,\n\ttype ListeningTemplate,\n\ttype TemplateCategory\n} from 'morse-engine';\nimport { downloadBlob, sanitizeFilename } from '../../utils/download-helper';\nimport { SettingsModal, ALL_SETTING_ITEMS, type SettingValues } from 'morse-engine';\n\ninterface ListeningSettings {\n\tcharacterSpeed: number;\n\teffectiveSpeed: number;\n\tfrequency: number;\n\tbFrequency: number;  // B側（相手方）の周波数\n\tvolume: number;\n}\n\nconst DEFAULT_SETTINGS: ListeningSettings = {\n\tcharacterSpeed: 20,\n\teffectiveSpeed: 15,\n\tfrequency: 700,\n\tbFrequency: 600,  // B側のデフォルト周波数\n\tvolume: 0.7\n};\n\ninterface State {\n\tcurrentCategory: TemplateCategory | 'custom';\n\tselectedTemplate: ListeningTemplate | null;\n\tisPlaying: boolean;\n\tuserInput: string;\n\tshowResult: boolean;\n\tshowAnswer: boolean;\n\tshowDialogFormat: boolean;\n}\n\n/**\n * 聞き取り練習ビュークラス\n */\nexport class ListeningView implements View {\n\tprivate audio: AudioGenerator;  // A側（自局）のAudioGenerator\n\tprivate audioB: AudioGenerator;  // B側（相手方）のAudioGenerator\n\tprivate settings: ListeningSettings = { ...DEFAULT_SETTINGS };\n\n\tprivate state: State = {\n\t\tcurrentCategory: 'qso',\n\t\tselectedTemplate: null,\n\t\tisPlaying: false,\n\t\tuserInput: '',\n\t\tshowResult: false,\n\t\tshowAnswer: false,\n\t\tshowDialogFormat: false\n\t};\n\n\tprivate customTemplates: ListeningTemplate[] = [];\n\n\tconstructor() {\n\t\t//! 設定を読み込む。\n\t\tthis.loadSettings();\n\t\tthis.loadCategory();\n\t\tthis.loadCustomTemplates();\n\n\t\t//! A側のAudioGeneratorを初期化。\n\t\tthis.audio = new AudioGenerator({\n\t\t\tfrequency: this.settings.frequency,\n\t\t\tvolume: this.settings.volume,\n\t\t\twpm: this.settings.characterSpeed,\n\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t});\n\n\t\t//! B側のAudioGeneratorを初期化。\n\t\tthis.audioB = new AudioGenerator({\n\t\t\tfrequency: this.settings.bFrequency,\n\t\t\tvolume: this.settings.volume,\n\t\t\twpm: this.settings.characterSpeed,\n\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t});\n\t}\n\n\t//! ========== 設定管理 ==========\n\n\tprivate loadSettings(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.listening.settings');\n\t\t\tif (saved) {\n\t\t\t\tthis.settings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load settings:', error);\n\t\t}\n\t}\n\n\tprivate saveSettings(): void {\n\t\ttry {\n\t\t\tlocalStorage.setItem('v10.listening.settings', JSON.stringify(this.settings));\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save settings:', error);\n\t\t}\n\t}\n\n\tprivate loadCategory(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.listening.category') as TemplateCategory | 'custom' | null;\n\t\t\tif (saved && ['qso', 'text100', 'text200', 'text300', 'custom'].includes(saved)) {\n\t\t\t\tthis.state.currentCategory = saved;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load category:', error);\n\t\t}\n\t}\n\n\tprivate saveCategory(): void {\n\t\ttry {\n\t\t\tlocalStorage.setItem('v10.listening.category', this.state.currentCategory);\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save category:', error);\n\t\t}\n\t}\n\n\tprivate loadCustomTemplates(): void {\n\t\ttry {\n\t\t\tconst saved = localStorage.getItem('v10.listening.customTemplates');\n\t\t\tif (saved) {\n\t\t\t\tthis.customTemplates = JSON.parse(saved);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to load custom templates:', error);\n\t\t}\n\t}\n\n\tprivate saveCustomTemplates(): void {\n\t\ttry {\n\t\t\tlocalStorage.setItem('v10.listening.customTemplates', JSON.stringify(this.customTemplates));\n\t\t} catch (error) {\n\t\t\tconsole.error('Failed to save custom templates:', error);\n\t\t}\n\t}\n\n\t//! ========== テンプレート管理 ==========\n\n\tprivate getTemplates(): ListeningTemplate[] {\n\t\tif (this.state.currentCategory === 'custom') {\n\t\t\t//! ランダムQSO生成ボタンを追加。\n\t\t\tconst randomButton: ListeningTemplate = {\n\t\t\t\tid: 'qso-random-generate',\n\t\t\t\tcategory: 'qso',\n\t\t\t\ttitle: 'ランダムQSO生成',\n\t\t\t\tcontent: ''\n\t\t\t};\n\t\t\treturn [randomButton, ...this.customTemplates];\n\t\t} else {\n\t\t\tconst builtin = ListeningTrainer.getBuiltinTemplates(this.state.currentCategory);\n\t\t\t//! QSOカテゴリーにはランダムQSO生成ボタンを追加。\n\t\t\tif (this.state.currentCategory === 'qso') {\n\t\t\t\tconst randomButton: ListeningTemplate = {\n\t\t\t\t\tid: 'qso-random-generate',\n\t\t\t\t\tcategory: 'qso',\n\t\t\t\t\ttitle: 'ランダムQSO生成',\n\t\t\t\t\tcontent: ''\n\t\t\t\t};\n\t\t\t\treturn [randomButton, ...builtin];\n\t\t\t}\n\t\t\treturn builtin;\n\t\t}\n\t}\n\n\t//! ========== 再生制御 ==========\n\n\tprivate async playMorse(): Promise<void> {\n\t\tif (!this.state.selectedTemplate || this.state.isPlaying) return;\n\n\t\tthis.state.isPlaying = true;\n\t\tthis.updatePlaybackButtons();\n\n\t\t//! テンプレートに応じて再生（dialogがあればA/B交互、なければcontentを再生）。\n\t\tif (this.state.showDialogFormat && this.state.selectedTemplate.dialog) {\n\t\t\t//! 対話形式で再生（A側とB側を交互に再生）。\n\t\t\tawait this.playDialogQSO(this.state.selectedTemplate);\n\t\t} else if (this.state.selectedTemplate.content) {\n\t\t\t//! 通常モードで再生（全体をA側で再生）。\n\t\t\tconst morse = MorseCodec.textToMorse(this.state.selectedTemplate.content);\n\t\t\tawait this.audio.playMorseString(morse);\n\t\t}\n\n\t\tthis.state.isPlaying = false;\n\t\tthis.updatePlaybackButtons();\n\t}\n\n\t/**\n\t * テンプレートからテキストを取得する\n\t * @param template - テンプレート\n\t * @returns 表示用テキスト\n\t */\n\tprivate getTemplateText(template: ListeningTemplate): string {\n\t\tif (template.dialog && template.dialog.length > 0) {\n\t\t\treturn template.dialog.map(seg => seg.text).join(' BT ');\n\t\t}\n\t\treturn template.content || '';\n\t}\n\n\t/**\n\t * 対話形式のQSOを再生する\n\t * A側とB側を交互に異なる周波数で再生\n\t * @param template - 再生するテンプレート\n\t */\n\tprivate async playDialogQSO(template: ListeningTemplate): Promise<void> {\n\t\t//! dialogがない場合（テキストカテゴリ）はcontentを再生。\n\t\tif (!template.dialog || template.dialog.length === 0) {\n\t\t\tif (template.content) {\n\t\t\t\tconst morse = MorseCodec.textToMorse(template.content);\n\t\t\t\tawait this.audio.playMorseString(morse);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t//! 各セグメントを交互にA側とB側で再生。\n\t\tfor (let i = 0; i < template.dialog.length; i++) {\n\t\t\tconst segment = template.dialog[i];\n\t\t\tconst morse = MorseCodec.textToMorse(segment.text);\n\n\t\t\t//! A側またはB側のAudioGeneratorを選択。\n\t\t\tconst generator = segment.side === 'A' ? this.audio : this.audioB;\n\t\t\tawait generator.playMorseString(morse);\n\n\t\t\t//! セグメント間に短い間隔を入れる。\n\t\t\tif (i < template.dialog.length - 1) {\n\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 500));\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate pauseMorse(): void {\n\t\tthis.audio.stopPlaying();\n\t\tthis.state.isPlaying = false;\n\t\tthis.updatePlaybackButtons();\n\t}\n\n\tprivate stopMorse(): void {\n\t\tthis.audio.stopPlaying();\n\t\tthis.state.isPlaying = false;\n\t\tthis.state.userInput = '';\n\t\tthis.state.showResult = false;\n\t\tthis.state.showAnswer = false;\n\t\tthis.renderPracticeArea();\n\t}\n\n\n\tprivate updatePlaybackButtons(): void {\n\t\tconst playBtn = document.getElementById('playBtn') as HTMLButtonElement;\n\t\tconst pauseBtn = document.getElementById('pauseBtn') as HTMLButtonElement;\n\n\t\tif (playBtn) playBtn.disabled = this.state.isPlaying;\n\t\tif (pauseBtn) pauseBtn.disabled = !this.state.isPlaying;\n\t}\n\n\t//! ========== 採点と結果表示 ==========\n\n\tprivate checkAnswer(): void {\n\t\tif (!this.state.selectedTemplate) return;\n\n\t\tthis.state.showResult = true;\n\t\tthis.state.showAnswer = true;\n\t\tthis.renderPracticeArea();\n\t}\n\n\tprivate toggleAnswer(): void {\n\t\tthis.state.showAnswer = !this.state.showAnswer;\n\t\tthis.renderPracticeArea();\n\t}\n\n\tprivate toggleDialogFormat(): void {\n\t\tthis.state.showDialogFormat = !this.state.showDialogFormat;\n\t\tthis.renderAnswer();\n\t}\n\n\t//! ========== カスタムテンプレート管理 ==========\n\n\tprivate showCustomTemplateDialog(template?: ListeningTemplate): void {\n\t\tconst isEdit = !!template;\n\t\tconst title = isEdit ? template.title : '';\n\t\tconst content = isEdit ? template.content : '';\n\n\t\tconst modal = document.createElement('div');\n\t\tmodal.className = 'modal-overlay';\n\t\tmodal.innerHTML = `\n\t\t\t<div class=\"modal\">\n\t\t\t\t<h2>${isEdit ? 'テンプレート編集' : 'テンプレート新規作成'}</h2>\n\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t<label for=\"templateTitle\">タイトル:</label>\n\t\t\t\t\t<input type=\"text\" id=\"templateTitle\" value=\"${title}\" placeholder=\"タイトルを入力\">\n\t\t\t\t</div>\n\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t<label for=\"templateContent\">内容:</label>\n\t\t\t\t\t<textarea id=\"templateContent\" placeholder=\"モールス信号に変換するテキストを入力\">${content}</textarea>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"modal-actions\">\n\t\t\t\t\t<button id=\"saveTemplateBtn\" class=\"btn btn-primary\">保存</button>\n\t\t\t\t\t<button id=\"cancelTemplateBtn\" class=\"btn\">キャンセル</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t\tdocument.body.appendChild(modal);\n\n\t\t//! 保存ボタン。\n\t\tdocument.getElementById('saveTemplateBtn')?.addEventListener('click', () => {\n\t\t\tconst titleInput = document.getElementById('templateTitle') as HTMLInputElement;\n\t\t\tconst contentInput = document.getElementById('templateContent') as HTMLTextAreaElement;\n\n\t\t\tif (!titleInput.value.trim() || !contentInput.value.trim()) {\n\t\t\t\talert('タイトルと内容を入力してください');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (isEdit && template) {\n\t\t\t\t//! 既存テンプレートを更新。\n\t\t\t\ttemplate.title = titleInput.value.trim();\n\t\t\t\ttemplate.content = contentInput.value.trim().toUpperCase();\n\t\t\t} else {\n\t\t\t\t//! 新規テンプレートを追加。\n\t\t\t\tconst newTemplate: ListeningTemplate = {\n\t\t\t\t\tid: `custom-${Date.now()}`,\n\t\t\t\t\tcategory: 'qso',\n\t\t\t\t\ttitle: titleInput.value.trim(),\n\t\t\t\t\tcontent: contentInput.value.trim().toUpperCase()\n\t\t\t\t};\n\t\t\t\tthis.customTemplates.push(newTemplate);\n\t\t\t}\n\n\t\t\tthis.saveCustomTemplates();\n\t\t\tmodal.remove();\n\t\t\tthis.render();\n\t\t});\n\n\t\t//! キャンセルボタン。\n\t\tdocument.getElementById('cancelTemplateBtn')?.addEventListener('click', () => {\n\t\t\tmodal.remove();\n\t\t});\n\n\t\t//! モーダル外クリックで閉じる。\n\t\tmodal.addEventListener('click', (e) => {\n\t\t\tif (e.target === modal) {\n\t\t\t\tmodal.remove();\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate deleteCustomTemplate(id: string): void {\n\t\tif (confirm('この定型文を削除しますか?')) {\n\t\t\tthis.customTemplates = this.customTemplates.filter(t => t.id !== id);\n\t\t\tthis.saveCustomTemplates();\n\t\t\tthis.render();\n\t\t}\n\t}\n\n\t//! ========== 設定モーダル ==========\n\n\tprivate showSettings(): void {\n\t\t//! 現在の設定値を取得（volumeを0-100の範囲に変換）。\n\t\tconst currentValues: SettingValues = {\n\t\t\tcharacterSpeed: this.settings.characterSpeed,\n\t\t\teffectiveSpeed: this.settings.effectiveSpeed,\n\t\t\tfrequency: this.settings.frequency,\n\t\t\tbFrequency: this.settings.bFrequency,\n\t\t\tvolume: Math.round(this.settings.volume * 100)\n\t\t};\n\n\t\t//! 設定変更前の値を保存（キャンセル時の復元用）。\n\t\tconst savedSettings = { ...this.settings };\n\n\t\t//! SettingsModalを作成。\n\t\tconst modal = new SettingsModal(\n\t\t\t'listening-settings-modal',\n\t\t\tALL_SETTING_ITEMS,\n\t\t\tcurrentValues,\n\t\t\t{\n\t\t\t\tonSave: (values: SettingValues) => {\n\t\t\t\t\t//! 実効速度は文字速度を上限とする。\n\t\t\t\t\tlet effSpeed = values.effectiveSpeed as number;\n\t\t\t\t\tconst charSpeed = values.characterSpeed as number;\n\t\t\t\t\tif (effSpeed > charSpeed) {\n\t\t\t\t\t\teffSpeed = charSpeed;\n\t\t\t\t\t}\n\n\t\t\t\t\t//! 設定を保存。\n\t\t\t\t\tthis.settings.characterSpeed = charSpeed;\n\t\t\t\t\tthis.settings.effectiveSpeed = effSpeed;\n\t\t\t\t\tthis.settings.frequency = values.frequency as number;\n\t\t\t\t\tthis.settings.bFrequency = values.bFrequency as number;\n\t\t\t\t\tthis.settings.volume = (values.volume as number) / 100;\n\n\t\t\t\t\tthis.saveSettings();\n\n\t\t\t\t\t//! A側のAudioGeneratorを更新。\n\t\t\t\t\tthis.audio.updateSettings({\n\t\t\t\t\t\tfrequency: this.settings.frequency,\n\t\t\t\t\t\tvolume: this.settings.volume,\n\t\t\t\t\t\twpm: this.settings.characterSpeed,\n\t\t\t\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t\t\t\t});\n\n\t\t\t\t\t//! B側のAudioGeneratorを更新。\n\t\t\t\t\tthis.audioB.updateSettings({\n\t\t\t\t\t\tfrequency: this.settings.bFrequency,\n\t\t\t\t\t\tvolume: this.settings.volume,\n\t\t\t\t\t\twpm: this.settings.characterSpeed,\n\t\t\t\t\t\teffectiveWpm: this.settings.effectiveSpeed\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonCancel: () => {\n\t\t\t\t\t//! 設定を元に戻す。\n\t\t\t\t\tthis.settings = { ...savedSettings };\n\t\t\t\t\tthis.audio.updateSettings({\n\t\t\t\t\t\tfrequency: savedSettings.frequency,\n\t\t\t\t\t\tvolume: savedSettings.volume,\n\t\t\t\t\t\twpm: savedSettings.characterSpeed,\n\t\t\t\t\t\teffectiveWpm: savedSettings.effectiveSpeed\n\t\t\t\t\t});\n\t\t\t\t\tthis.audioB.updateSettings({\n\t\t\t\t\t\tfrequency: savedSettings.bFrequency,\n\t\t\t\t\t\tvolume: savedSettings.volume,\n\t\t\t\t\t\twpm: savedSettings.characterSpeed,\n\t\t\t\t\t\teffectiveWpm: savedSettings.effectiveSpeed\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonTestPlay: async () => {\n\t\t\t\t\t//! テスト再生: A側とB側の周波数で順番に再生。\n\t\t\t\t\tconst morse = MorseCodec.textToMorse('CQ');\n\t\t\t\t\tawait this.audio.playMorseString(morse);\n\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 500));\n\t\t\t\t\tawait this.audioB.playMorseString(morse);\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\t//! モーダルを表示。\n\t\tmodal.show('listening');\n\t}\n\n\t//! ========== レンダリング ==========\n\n\trender(): void {\n\t\tconst app = document.getElementById('app');\n\t\tif (!app) return;\n\n\t\tapp.innerHTML = `\n\t\t\t<div class=\"settings-icon\" id=\"settingsIcon\">\n\t\t\t\t<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t\t<path d=\"M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z\"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class=\"container\">\n\t\t\t\t<header class=\"header\">\n\t\t\t\t\t<button id=\"backBtn\" class=\"back-btn\">← 戻る</button>\n\t\t\t\t\t<h1>モールス信号聞き取り練習</h1>\n\t\t\t\t</header>\n\n\t\t\t\t<div class=\"tabs\">\n\t\t\t\t\t${this.renderCategoryTabs()}\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"content-area\">\n\t\t\t\t\t${this.state.selectedTemplate ? this.renderPracticeContent() : this.renderTemplateList()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.attachEventListeners();\n\t}\n\n\tprivate renderCategoryTabs(): string {\n\t\tconst categories: { id: TemplateCategory | 'custom'; label: string }[] = [\n\t\t\t{ id: 'qso', label: 'ラバースタンプQSO' },\n\t\t\t{ id: 'text100', label: '英文100字' },\n\t\t\t{ id: 'text200', label: '英文200字' },\n\t\t\t{ id: 'text300', label: '英文300字' },\n\t\t\t{ id: 'custom', label: 'ユーザー定義' }\n\t\t];\n\n\t\treturn categories\n\t\t\t.map(\n\t\t\t\tcat => `\n\t\t\t<button class=\"tab-button ${this.state.currentCategory === cat.id ? 'active' : ''}\" data-category=\"${cat.id}\">\n\t\t\t\t${cat.label}\n\t\t\t</button>\n\t\t`\n\t\t\t)\n\t\t\t.join('');\n\t}\n\n\tprivate renderTemplateList(): string {\n\t\tconst templates = this.getTemplates();\n\n\t\tif (templates.length === 0 || (templates.length === 1 && templates[0].id === 'qso-random-generate')) {\n\t\t\treturn `\n\t\t\t\t<div class=\"empty-state\">\n\t\t\t\t\t<p>定型文がありません</p>\n\t\t\t\t\t${this.state.currentCategory === 'custom' ? '<button id=\"addCustomBtn\" class=\"btn btn-primary\">新規作成</button>' : ''}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}\n\n\t\treturn `\n\t\t\t<div class=\"template-list\">\n\t\t\t\t${this.state.currentCategory === 'custom' ? '<button id=\"addCustomBtn\" class=\"btn btn-primary\">新規作成</button>' : ''}\n\t\t\t\t${templates\n\t\t\t\t\t.map(template => {\n\t\t\t\t\t\tconst text = this.getTemplateText(template);\n\t\t\t\t\t\tconst preview = template.id === 'qso-random-generate'\n\t\t\t\t\t\t\t? 'コールサイン、地名、名前、RSレポート、リグなどがランダムに生成された完全なQSOが作成されます。毎回異なる内容で練習できます。'\n\t\t\t\t\t\t\t: `${text.substring(0, 100)}${text.length > 100 ? '...' : ''}`;\n\t\t\t\t\t\treturn `\n\t\t\t\t\t<div class=\"template-card\" data-template-id=\"${template.id}\">\n\t\t\t\t\t\t<h3>${template.title}</h3>\n\t\t\t\t\t\t<p class=\"template-preview\">${preview}</p>\n\t\t\t\t\t\t<div class=\"template-actions\">\n\t\t\t\t\t\t\t<button class=\"btn select-btn\" data-template-id=\"${template.id}\">選択</button>\n\t\t\t\t\t\t\t${\n\t\t\t\t\t\t\t\tthis.state.currentCategory === 'custom' && template.id !== 'qso-random-generate'\n\t\t\t\t\t\t\t\t\t? `\n\t\t\t\t\t\t\t\t<button class=\"btn edit-btn\" data-template-id=\"${template.id}\">編集</button>\n\t\t\t\t\t\t\t\t<button class=\"btn delete-btn\" data-template-id=\"${template.id}\">削除</button>\n\t\t\t\t\t\t\t`\n\t\t\t\t\t\t\t\t\t: ''\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`;\n\t\t\t\t\t})\n\t\t\t\t\t.join('')}\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tprivate renderPracticeContent(): string {\n\t\tif (!this.state.selectedTemplate) return '';\n\n\t\treturn `\n\t\t\t<div class=\"practice-area\">\n\t\t\t\t<div class=\"practice-header\">\n\t\t\t\t\t<h2>${this.state.selectedTemplate.title}</h2>\n\t\t\t\t\t<button id=\"backToListBtn\" class=\"btn\">一覧に戻る</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"playback-controls\">\n\t\t\t\t\t<button id=\"playBtn\" class=\"control-btn\" title=\"再生\" ${this.state.isPlaying ? 'disabled' : ''}>\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M8 5v14l11-7z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"pauseBtn\" class=\"control-btn\" title=\"一時停止\" ${!this.state.isPlaying ? 'disabled' : ''}>\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M6 4h4v16H6V4zm8 0h4v16h-4V4z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"stopBtn\" class=\"control-btn\" title=\"停止\">\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<rect x=\"6\" y=\"6\" width=\"12\" height=\"12\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button id=\"downloadBtn\" class=\"control-btn\" title=\"WAVファイルとしてダウンロード\">\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path d=\"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div id=\"practiceInputArea\"></div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tprivate renderPracticeArea(): void {\n\t\tconst practiceInputArea = document.getElementById('practiceInputArea');\n\t\tif (!practiceInputArea) return;\n\n\t\tpracticeInputArea.innerHTML = `\n\t\t\t<div class=\"input-section\">\n\t\t\t\t<label for=\"userInput\">聞き取った内容を入力してください:</label>\n\t\t\t\t<textarea id=\"userInput\" class=\"input-area\" placeholder=\"聞き取った文字を入力...\">${this.state.userInput}</textarea>\n\t\t\t</div>\n\n\t\t\t<div class=\"action-buttons\">\n\t\t\t\t<button id=\"checkBtn\" class=\"btn btn-primary\">採点</button>\n\t\t\t\t<button id=\"showAnswerBtn\" class=\"btn\">${this.state.showAnswer ? '正解を非表示' : '正解を表示'}</button>\n\t\t\t</div>\n\n\t\t\t${this.state.showAnswer ? '<div id=\"answerArea\"></div>' : ''}\n\t\t\t${this.state.showResult ? '<div id=\"resultArea\"></div>' : ''}\n\t\t`;\n\n\t\t//! ユーザー入力の監視。\n\t\tconst userInput = document.getElementById('userInput') as HTMLTextAreaElement;\n\t\tuserInput?.addEventListener('input', () => {\n\t\t\tthis.state.userInput = userInput.value;\n\t\t});\n\n\t\t//! 採点ボタン。\n\t\tdocument.getElementById('checkBtn')?.addEventListener('click', () => {\n\t\t\tthis.checkAnswer();\n\t\t});\n\n\t\t//! 正解表示ボタン。\n\t\tdocument.getElementById('showAnswerBtn')?.addEventListener('click', () => {\n\t\t\tthis.toggleAnswer();\n\t\t});\n\n\t\t//! 正解と結果を描画。\n\t\tif (this.state.showAnswer) {\n\t\t\tthis.renderAnswer();\n\t\t}\n\t\tif (this.state.showResult) {\n\t\t\tthis.renderResult();\n\t\t}\n\t}\n\n\tprivate renderAnswer(): void {\n\t\tconst answerArea = document.getElementById('answerArea');\n\t\tif (!answerArea || !this.state.selectedTemplate) return;\n\n\t\tconst isQSO = this.state.selectedTemplate.category === 'qso';\n\t\tconst content = this.getTemplateText(this.state.selectedTemplate);\n\n\t\t//! 対話形式ボタン（QSOの場合のみ表示）。\n\t\tconst dialogButton = isQSO\n\t\t\t? `<button id=\"toggleDialogBtn\" class=\"btn\" style=\"margin-left: 10px;\">${this.state.showDialogFormat ? '通常表示' : '対話形式で表示'}</button>`\n\t\t\t: '';\n\n\t\t//! 対話形式表示の生成。\n\t\tlet answerContent = '';\n\t\tif (isQSO && this.state.showDialogFormat) {\n\t\t\t//! BTで区切って話者別に表示。\n\t\t\tconst segments = content.split(/\\s+BT\\s+/);\n\t\t\tanswerContent = `\n\t\t\t\t<table class=\"dialog-table\">\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t${segments.map((segment, index) => {\n\t\t\t\t\t\t\tconst speaker = index % 2 === 0 ? 'A' : 'B';\n\t\t\t\t\t\t\treturn `\n\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t<td class=\"speaker-cell\">${speaker}</td>\n\t\t\t\t\t\t\t\t\t<td class=\"content-cell\">${segment.trim()}</td>\n\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t}).join('')}\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\t\t\t`;\n\t\t} else {\n\t\t\tanswerContent = `<div class=\"answer-text\">${content}</div>`;\n\t\t}\n\n\t\tanswerArea.innerHTML = `\n\t\t\t<div class=\"answer-area\">\n\t\t\t\t<h3 style=\"display: inline-block;\">正解</h3>\n\t\t\t\t${dialogButton}\n\t\t\t\t${answerContent}\n\t\t\t</div>\n\t\t`;\n\n\t\t//! 対話形式ボタン。\n\t\tdocument.getElementById('toggleDialogBtn')?.addEventListener('click', () => {\n\t\t\tthis.toggleDialogFormat();\n\t\t});\n\t}\n\n\tprivate renderResult(): void {\n\t\tconst resultArea = document.getElementById('resultArea');\n\t\tif (!resultArea || !this.state.selectedTemplate) return;\n\n\t\tconst correctText = this.getTemplateText(this.state.selectedTemplate);\n\t\tconst accuracy = ListeningTrainer.calculateAccuracy(\n\t\t\tcorrectText,\n\t\t\tthis.state.userInput\n\t\t);\n\n\t\tresultArea.innerHTML = `\n\t\t\t<div class=\"result-area\">\n\t\t\t\t<h3>結果</h3>\n\t\t\t\t<div class=\"accuracy\">正答率: ${accuracy}%</div>\n\t\t\t\t<div class=\"comparison\">\n\t\t\t\t\t<div class=\"comparison-row\">\n\t\t\t\t\t\t<strong>正解:</strong>\n\t\t\t\t\t\t<div class=\"comparison-text\">${correctText}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"comparison-row\">\n\t\t\t\t\t\t<strong>入力:</strong>\n\t\t\t\t\t\t<div class=\"comparison-text\">${this.state.userInput || '（未入力）'}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t//! ========== イベントリスナー ==========\n\n\tprivate attachEventListeners(): void {\n\t\t//! 戻るボタン。\n\t\tdocument.getElementById('backBtn')?.addEventListener('click', () => {\n\t\t\twindow.location.hash = '#menu';\n\t\t});\n\n\t\t//! 設定アイコン。\n\t\tdocument.getElementById('settingsIcon')?.addEventListener('click', () => {\n\t\t\tthis.showSettings();\n\t\t});\n\n\t\t//! カテゴリータブ。\n\t\tdocument.querySelectorAll('.tab-button').forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst category = btn.getAttribute('data-category') as TemplateCategory | 'custom';\n\t\t\t\tif (category) {\n\t\t\t\t\tthis.state.currentCategory = category;\n\t\t\t\t\tthis.state.selectedTemplate = null;\n\t\t\t\t\tthis.state.showResult = false;\n\t\t\t\t\tthis.state.showAnswer = false;\n\t\t\t\t\tthis.state.showDialogFormat = false;\n\t\t\t\t\tthis.state.userInput = '';\n\t\t\t\t\tthis.saveCategory();\n\t\t\t\t\tthis.render();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! 定型文選択ボタン。\n\t\tdocument.querySelectorAll('.select-btn').forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst id = btn.getAttribute('data-template-id');\n\t\t\t\tif (id) {\n\t\t\t\t\t//! ランダムQSO生成ボタンの場合。\n\t\t\t\t\tif (id === 'qso-random-generate') {\n\t\t\t\t\t\tthis.state.selectedTemplate = ListeningTrainer.generateRandomQSO();\n\t\t\t\t\t\tthis.state.showResult = false;\n\t\t\t\t\t\tthis.state.showAnswer = false;\n\t\t\t\t\t\tthis.state.showDialogFormat = false;\n\t\t\t\t\t\tthis.state.userInput = '';\n\t\t\t\t\t\tthis.render();\n\t\t\t\t\t\tthis.renderPracticeArea();\n\t\t\t\t\t} else {\n\t\t\t\t\t\t//! 通常のテンプレート選択。\n\t\t\t\t\t\tconst allTemplates = [...ListeningTrainer.getBuiltinTemplates(), ...this.customTemplates];\n\t\t\t\t\t\tconst template = allTemplates.find(t => t.id === id);\n\t\t\t\t\t\tif (template) {\n\t\t\t\t\t\t\tthis.state.selectedTemplate = template;\n\t\t\t\t\t\t\tthis.state.showResult = false;\n\t\t\t\t\t\t\tthis.state.showAnswer = false;\n\t\t\t\t\t\t\tthis.state.showDialogFormat = false;\n\t\t\t\t\t\t\tthis.state.userInput = '';\n\t\t\t\t\t\t\tthis.render();\n\t\t\t\t\t\t\tthis.renderPracticeArea();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! 一覧に戻るボタン。\n\t\tdocument.getElementById('backToListBtn')?.addEventListener('click', () => {\n\t\t\tthis.state.selectedTemplate = null;\n\t\t\tthis.state.showResult = false;\n\t\t\tthis.state.showAnswer = false;\n\t\t\tthis.state.showDialogFormat = false;\n\t\t\tthis.state.userInput = '';\n\t\t\tthis.audio.stopPlaying();\n\t\t\tthis.render();\n\t\t});\n\n\t\t//! ユーザー定義定型文の新規作成ボタン。\n\t\tdocument.getElementById('addCustomBtn')?.addEventListener('click', () => {\n\t\t\tthis.showCustomTemplateDialog();\n\t\t});\n\n\t\t//! ユーザー定義定型文の編集ボタン。\n\t\tdocument.querySelectorAll('.edit-btn').forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst id = btn.getAttribute('data-template-id');\n\t\t\t\tif (id) {\n\t\t\t\t\tconst template = this.customTemplates.find(t => t.id === id);\n\t\t\t\t\tif (template) {\n\t\t\t\t\t\tthis.showCustomTemplateDialog(template);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! ユーザー定義定型文の削除ボタン。\n\t\tdocument.querySelectorAll('.delete-btn').forEach(btn => {\n\t\t\tbtn.addEventListener('click', () => {\n\t\t\t\tconst id = btn.getAttribute('data-template-id');\n\t\t\t\tif (id) {\n\t\t\t\t\tthis.deleteCustomTemplate(id);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t//! 再生コントロール（練習画面のみ）。\n\t\tif (this.state.selectedTemplate) {\n\t\t\tdocument.getElementById('playBtn')?.addEventListener('click', () => {\n\t\t\t\tthis.playMorse();\n\t\t\t});\n\n\t\t\tdocument.getElementById('pauseBtn')?.addEventListener('click', () => {\n\t\t\t\tthis.pauseMorse();\n\t\t\t});\n\n\t\t\tdocument.getElementById('stopBtn')?.addEventListener('click', () => {\n\t\t\t\tthis.stopMorse();\n\t\t\t});\n\n\t\t\tdocument.getElementById('downloadBtn')?.addEventListener('click', () => {\n\t\t\t\tthis.downloadWav();\n\t\t\t});\n\n\t\t\tthis.renderPracticeArea();\n\t\t}\n\t}\n\n\t/**\n\t * モールス信号をWAVファイルとしてダウンロードする\n\t */\n\tprivate async downloadWav(): Promise<void> {\n\t\tif (!this.state.selectedTemplate) return;\n\n\t\ttry {\n\t\t\t//! テキストをモールス符号に変換。\n\t\t\tconst text = this.getTemplateText(this.state.selectedTemplate);\n\t\t\tconst morse = MorseCodec.textToMorse(text);\n\n\t\t\t//! WAVファイルを生成。\n\t\t\tconst wavBlob = await this.audio.generateWav(morse);\n\n\t\t\t//! ダウンロード。\n\t\t\tconst filename = `${sanitizeFilename(this.state.selectedTemplate.title)}.wav`;\n\t\t\tdownloadBlob(wavBlob, filename);\n\t\t} catch (error) {\n\t\t\tconsole.error('WAVダウンロードエラー:', error);\n\t\t\talert('WAVファイルの生成に失敗しました。');\n\t\t}\n\t}\n\n\tdestroy(): void {\n\t\t//! AudioGeneratorを停止。\n\t\tthis.audio.stopPlaying();\n\t}\n}\n","/**\n * ダウンロードヘルパー関数\n * Blobをファイルとしてダウンロードさせるユーティリティ\n */\n\n/**\n * Blobをファイルとしてダウンロードする\n *\n * @param blob - ダウンロードするBlob\n * @param filename - ファイル名\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n\tconst url = URL.createObjectURL(blob);\n\tconst a = document.createElement('a');\n\ta.href = url;\n\ta.download = filename;\n\tdocument.body.appendChild(a);\n\ta.click();\n\tdocument.body.removeChild(a);\n\tURL.revokeObjectURL(url);\n}\n\n/**\n * ファイル名をサニタイズする（安全なファイル名に変換）\n *\n * @param filename - 元のファイル名\n * @returns サニタイズされたファイル名\n */\nexport function sanitizeFilename(filename: string): string {\n\treturn filename.replace(/[^a-zA-Z0-9_-]/g, '_');\n}\n","/**\n * ルーター\n * ハッシュベースのSPAルーティング\n */\n\nimport { MenuView } from '../ui/views/MenuView';\nimport { VerticalKeyView } from '../ui/views/VerticalKeyView';\nimport { HorizontalKeyView } from '../ui/views/HorizontalKeyView';\nimport { FlashcardView } from '../ui/views/FlashcardView';\nimport { KochView } from '../ui/views/KochView';\nimport { ListeningView } from '../ui/views/ListeningView';\n\n/**\n * ビューインターフェース\n */\nexport interface View {\n\t/**\n\t * ビューをレンダリングする\n\t */\n\trender(): void | Promise<void>;\n\n\t/**\n\t * ビューを破棄する\n\t */\n\tdestroy(): void;\n}\n\n/**\n * ルート定義\n */\ntype Route = {\n\tpath: string;\n\tview: new () => View;\n};\n\n/**\n * ルータークラス\n */\nexport class Router {\n\tprivate currentView: View | null = null;\n\tprivate routes: Route[] = [];\n\n\tconstructor() {\n\t\t//! ルート定義。\n\t\tthis.routes = [\n\t\t\t{ path: '', view: MenuView },\n\t\t\t{ path: 'menu', view: MenuView },\n\t\t\t{ path: 'vertical', view: VerticalKeyView },\n\t\t\t{ path: 'horizontal', view: HorizontalKeyView },\n\t\t\t{ path: 'flashcard', view: FlashcardView },\n\t\t\t{ path: 'koch', view: KochView },\n\t\t\t{ path: 'listening', view: ListeningView },\n\t\t];\n\t}\n\n\t/**\n\t * ルーターを初期化する\n\t */\n\tinit(): void {\n\t\t//! ハッシュ変更時のリスナーを登録。\n\t\twindow.addEventListener('hashchange', () => this.handleRoute());\n\n\t\t//! 初回ルーティング。\n\t\tthis.handleRoute();\n\t}\n\n\t/**\n\t * 現在のハッシュに基づいてルーティングする\n\t */\n\tprivate handleRoute(): void {\n\t\t//! 現在のビューを破棄。\n\t\tif (this.currentView) {\n\t\t\tthis.currentView.destroy();\n\t\t\tthis.currentView = null;\n\t\t}\n\n\t\t//! ハッシュからパスを取得（#を除去）。\n\t\tconst hash = window.location.hash.slice(1);\n\t\tconst route = this.routes.find(r => r.path === hash);\n\n\t\tif (route) {\n\t\t\t//! ビューを作成してレンダリング。\n\t\t\tthis.currentView = new route.view();\n\t\t\tthis.currentView.render();\n\t\t} else {\n\t\t\t//! 該当するルートがない場合はメニューに遷移。\n\t\t\twindow.location.hash = '#menu';\n\t\t}\n\t}\n\n\t/**\n\t * 指定したパスに遷移する\n\t */\n\tnavigate(path: string): void {\n\t\twindow.location.hash = `#${path}`;\n\t}\n}\n","/**\n * アプリケーションエントリポイント\n */\n\nimport { Router } from './router';\nimport './assets/styles.css';\n\n//! アプリケーション起動時の処理。\nfunction init(): void {\n\t//! 開発環境でのみログを出力。\n\tif (import.meta.env.DEV) {\n\t\tconsole.log('モールス練習アプリ v10 起動');\n\t}\n\n\t//! ルーターを初期化。\n\tconst router = new Router();\n\trouter.init();\n}\n\n//! DOMContentLoaded後に初期化。\nif (document.readyState === 'loading') {\n\tdocument.addEventListener('DOMContentLoaded', init);\n} else {\n\tinit();\n}\n"],"names":["MenuView","menuItems","id","title","description","route","render","app","document","getElementById","innerHTML","this","map","item","renderMenuItem","join","attachEventListeners","querySelectorAll","forEach","addEventListener","getAttribute","window","location","hash","destroy","VerticalKeyView","trainer","buffer","timer","audio","isKeyPressed","keyPressHandler","keyReleaseHandler","updateIntervalId","currentWPM","keyCode","constructor","savedWPM","localStorage","getItem","parseInt","savedKeyCode","MorseBuffer","TimerManager","AudioGenerator","frequency","volume","wpm","timings","TimingCalculator","calculate","VerticalKeyTrainer","onKeyPress","startContinuousTone","onKeyRelease","stopContinuousTone","startUpdate","backBtn","querySelector","openSettingsModal","clearBtn","clear","updateDisplay","e","code","repeat","preventDefault","handleKeyDown","handleKeyUp","keyButton","keyPress","updateKeyStatus","classList","add","keyRelease","remove","setInterval","morseBuffer","decodedText","charCount","getBuffer","sequence","getSequence","fullDisplay","textContent","text","getDecoded","length","toString","isPressed","keyStatus","valueSpan","currentValues","Math","round","getVolume","getFrequency","savedSettings","SettingsModal","ALL_SETTING_ITEMS","onSave","values","setVolume","setFrequency","setWPM","setItem","currentWpmDisplay","onCancel","show","removeEventListener","clearInterval","HorizontalKeyView","leftPressed","rightPressed","iambicMode","paddleLayout","leftKeyCode","rightKeyCode","savedIambicMode","savedPaddleLayout","savedLeftKeyCode","savedRightKeyCode","initializeTrainer","HorizontalKeyTrainer","onElementStart","_element","duration","scheduleTone","handleLeftPaddlePress","handleRightPaddlePress","handleLeftPaddleRelease","handleRightPaddleRelease","leftPaddle","rightPaddle","leftPaddlePress","leftPaddleRelease","rightPaddlePress","rightPaddleRelease","updatePaddleLabels","className","currentIambicModeDisplay","async","loadFlashcardData","url","response","fetch","ok","Error","statusText","lines","split","filter","line","trim","slice","index","columns","tags","abbreviation","english","japanese","example","entry","parseTSV","FlashcardView","allEntries","filteredEntries","currentState","selectedTags","Set","selectedFrequencies","searchQuery","displayMode","sortColumn","sortDirection","learnQuestionType","learnCards","currentLearnIndex","isFlipped","reviewMode","progress","known","unknown","questionType","questionCount","questions","currentQuestionIndex","results","currentlyPlaying","FlashcardState","loadProgress","filters","loadFilters","viewState","loadViewState","examQuestionType","saveProgress","clearProgress","saveFilters","updateFilteredEntries","viewMode","error","renderBrowseMode","renderLearnMode","renderExamMode","renderExamResultMode","renderFilterSection","FlashcardTrainer","getAllTags","tag","has","freq","renderEntries","attachBrowseModeListeners","container","renderCardView","renderListView","formatAbbreviation","card","abbr","playMorse","toggleBtn","saveDisplayMode","getSortIndicator","header","column","toggleSort","btn","renderLearnSetup","renderLearnCard","cardCount","size","attachCommonListeners","attachLearnSetupListeners","tagFilter","target","type","checked","value","delete","frequencyFilter","searchInput","reviewModeBtn","saveLearnQuestionType","startLearnBtn","startLearn","clearProgressBtn","confirm","cards","sort","random","alert","currentNum","totalNum","frontContent","backContent","isKnown","judgmentButtons","attachLearnCardListeners","backToSetupBtn","flipCardBtn","body","playMorseBtn","markUnknownBtn","moveToNextCard","markKnownBtn","prevCardBtn","nextCardBtn","renderExamSetup","renderExamQuestion","attachExamSetupListeners","question","total","questionText","choices","choice","attachExamQuestionListeners","setTimeout","score","calculateScore","isPassed","percentage","wrongAnswers","getWrongAnswers","correct","r","isCorrect","result","userAnswer","correctAnswer","attachResultListeners","updateFilteredCount","saveExamQuestionType","count","startExamBtn","startExam","replayBtn","currentTarget","dataset","handleAnswer","retryBtn","tab","saveViewMode","filteredCountElem","questionCountInput","max","entries","filterByTags","filterByFrequencies","filterByQuery","sortEntries","ascending","sortByAbbreviation","sortByEnglish","sortByJapanese","sortByFrequency","sortByTags","saveSortState","prosignMatch","match","morseSequence","MorseCodec","textToMorse","char","Promise","resolve","actualCount","min","generateExamQuestions","checkAnswer","push","getWPM","onTestPlay","DEFAULT_SETTINGS","characterSpeed","effectiveSpeed","practiceDuration","groupSize","showInput","KochView","settings","state","currentLesson","isPlaying","userInput","groups","currentGroupIndex","customState","selectedChars","isCustomRunning","customUserInput","customCorrectAnswer","customGroups","customCurrentGroupIndex","customIsPlaying","loadSettings","loadViewMode","loadSelectedChars","effectiveWpm","saved","JSON","parse","saveSettings","stringify","includes","chars","saveSelectedChars","Array","from","startLesson","KochTrainer","getCharsForLesson","practiceSettings","generateRandomGroups","updateSettings","renderPractice","updateProgress","updatePlaybackButtons","i","group","morse","playMorseString","showResult","pauseMorse","stopPlaying","stopLesson","accuracy","calculateAccuracy","passed","resultContainer","toFixed","progressEl","progressBar","percent","style","width","playBtn","pauseBtn","disabled","startCustom","renderCustomPractice","playCustomMorse","updateCustomProgress","updateCustomPlaybackButtons","pauseCustomMorse","stopCustom","showCustomResult","replace","showSettings","effSpeed","charSpeed","renderModeContent","renderLearningMode","renderCustomMode","lessonList","KOCH_SEQUENCE","_","lessonNum","lessonChars","practiceContainer","renderKeyboard","inputEl","toUpperCase","setupKeyboardEvents","setupCustomControls","availableChars","groupIndex","isLearned","setupModeEventListeners","scrollTo","top","behavior","bFrequency","ListeningView","audioB","currentCategory","selectedTemplate","showAnswer","showDialogFormat","customTemplates","loadCategory","loadCustomTemplates","saveCategory","saveCustomTemplates","getTemplates","category","content","builtin","ListeningTrainer","getBuiltinTemplates","dialog","playDialogQSO","getTemplateText","template","seg","segment","generator","side","stopMorse","renderPracticeArea","toggleAnswer","toggleDialogFormat","renderAnswer","showCustomTemplateDialog","isEdit","modal","createElement","appendChild","titleInput","contentInput","newTemplate","Date","now","deleteCustomTemplate","t","renderCategoryTabs","renderPracticeContent","renderTemplateList","label","cat","templates","preview","substring","practiceInputArea","renderResult","answerArea","isQSO","dialogButton","answerContent","resultArea","correctText","generateRandomQSO","find","downloadWav","wavBlob","generateWav","blob","filename","URL","createObjectURL","a","href","download","click","removeChild","revokeObjectURL","downloadBlob","sanitizeFilename","Router","currentView","routes","path","view","init","handleRoute","navigate","readyState"],"mappings":"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"}