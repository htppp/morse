<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>モールス CW略語・Q符号 学習アプリ</title>
  <meta name="description" content="CW通信で使用される略語とQ符号を効率的に学習するための教材アプリケーション">
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();async function q(){try{const c=await fetch("data/flashcard.tsv");if(!c.ok)throw new Error(`Failed to load flashcard data: ${c.statusText}`);const e=await c.text();return C(e)}catch(c){throw console.error("Error loading flashcard data:",c),c}}function C(c){const t=c.trim().split(`
`).slice(1),i=[];for(const s of t){if(!s.trim())continue;const n=s.split("	");if(n.length<5){console.warn("Invalid line (insufficient fields):",s);continue}const[r,o,a,h,u]=n,v=r.split(",").map(p=>p.trim()).filter(p=>p.length>0),f=parseInt(o,10);if(isNaN(f)){console.warn("Invalid frequency value:",o);continue}i.push({tags:v,frequency:f,abbreviation:a.trim(),english:h.trim(),japanese:u.trim()})}return i}function w(c,e){return e.length===0?c:c.filter(t=>e.every(i=>t.tags.includes(i)))}function k(c,e){if(!e.trim())return c;const t=e.toLowerCase();return c.filter(i=>i.abbreviation.toLowerCase().includes(t)||i.english.toLowerCase().includes(t)||i.japanese.includes(e)||i.tags.some(s=>s.includes(e)))}function T(c,e,t="asc"){const i=[...c];return i.sort((s,n)=>{let r=0;switch(e){case"abbreviation":r=s.abbreviation.localeCompare(n.abbreviation);break;case"frequency":r=s.frequency-n.frequency;break;case"tags":const o=s.tags[0]||"",a=n.tags[0]||"";r=o.localeCompare(a);break;case"english":r=s.english.localeCompare(n.english);break;case"japanese":r=s.japanese.localeCompare(n.japanese);break}return t==="asc"?r:-r}),i}function x(c){const e=new Set;for(const t of c)for(const i of t.tags)e.add(i);return Array.from(e).sort()}class S{constructor(e){this.container=e,this.currentTab="list",this.tabChangeCallbacks=new Map}initialize(){this.renderTabs(),this.attachEventListeners();try{const e=localStorage.getItem("v3.currentTab");e==="list"||e==="flashcard"||e==="exam"?this.switchTab(e):this.switchTab(this.currentTab)}catch{this.switchTab(this.currentTab)}}renderTabs(){const e=`
      <div class="tabs">
        <button class="tab-button ${this.currentTab==="list"?"active":""}" data-tab="list">
          一覧表示
        </button>
        <button class="tab-button ${this.currentTab==="flashcard"?"active":""}" data-tab="flashcard">
          フラッシュカード
        </button>
        <button class="tab-button ${this.currentTab==="exam"?"active":""}" data-tab="exam">
          試験モード
        </button>
      </div>
      <div id="tab-content" class="tab-content"></div>
    `;this.container.innerHTML=e}attachEventListeners(){this.container.querySelectorAll(".tab-button").forEach(t=>{t.addEventListener("click",()=>{const i=t.getAttribute("data-tab");i&&!t.hasAttribute("disabled")&&this.switchTab(i)})})}switchTab(e){if(this.currentTab===e)return;this.currentTab=e,this.container.querySelectorAll(".tab-button").forEach(s=>{s.getAttribute("data-tab")===e?s.classList.add("active"):s.classList.remove("active")});const i=this.tabChangeCallbacks.get(e);i&&i();try{localStorage.setItem("v3.currentTab",e)}catch{}}onTabChange(e,t){this.tabChangeCallbacks.set(e,t)}getContentContainer(){return this.container.querySelector("#tab-content")}getCurrentTab(){return this.currentTab}}const g=class g{static get(e){return this.settings[e]}static set(e,t){this.settings[e]=t,this.notifyListeners()}static getAll(){return{...this.settings}}static load(){try{const e=localStorage.getItem("morseSettings");e?this.settings={...this.defaultSettings,...JSON.parse(e)}:this.settings={...this.defaultSettings},this.notifyListeners()}catch(e){console.error("Failed to load settings:",e),this.settings={...this.defaultSettings}}}static save(){try{localStorage.setItem("morseSettings",JSON.stringify(this.settings))}catch(e){console.error("Failed to save settings:",e)}}static reset(){this.settings={...this.defaultSettings},this.save(),this.notifyListeners()}static addListener(e){this.listeners.add(e)}static removeListener(e){this.listeners.delete(e)}static notifyListeners(){this.listeners.forEach(e=>e())}};g.defaultSettings={volume:.3,frequency:800,wpm:20},g.settings={...g.defaultSettings},g.listeners=new Set;let l=g;l.load();//! 音声システムモジュール。
//! 音声システムクラス。
const b=class b{static ensureAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioContext.state==="suspended"&&this.audioContext.resume()}static ensureSidetone(){if(this.ensureAudioContext(),!this.sidOsc&&this.audioContext){this.sidOsc=this.audioContext.createOscillator(),this.sidGain=this.audioContext.createGain(),this.sidFilter=this.audioContext.createBiquadFilter();const e=this.audioContext.createDynamicsCompressor();this.sidOsc.type="sine",this.sidOsc.frequency.value=l.get("frequency"),this.sidGain.gain.value=0,this.sidFilter.type="bandpass",this.sidFilter.frequency.value=l.get("frequency"),this.sidFilter.Q.value=10,e.threshold.value=-18,e.ratio.value=2,e.attack.value=.001,e.release.value=.08,this.sidOsc.connect(this.sidGain),this.sidGain.connect(this.sidFilter),this.sidFilter.connect(e),e.connect(this.audioContext.destination),this.sidOsc.start()}}static scheduleTone(e,t){if(this.ensureAudioContext(),!!this.audioContext){this.audioContext.state==="suspended"&&this.audioContext.resume();try{const i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.connect(s),s.connect(this.audioContext.destination);const n=l.get("frequency"),r=l.get("volume");i.frequency.value=n,i.type="sine";const o=this.audioContext.currentTime,a=Math.max(o,e);s.gain.setValueAtTime(0,a),s.gain.linearRampToValueAtTime(r,a+.001),s.gain.setValueAtTime(r,a+(t-1)/1e3),s.gain.linearRampToValueAtTime(0,a+t/1e3),i.start(a),i.stop(a+t/1e3);const h={osc:i,gain:s};this.scheduledNodes.push(h),i.onended=()=>{const u=this.scheduledNodes.indexOf(h);u>-1&&this.scheduledNodes.splice(u,1)}}catch(i){console.error("音声エラー:",i)}}}static startContinuousTone(){if(this.ensureAudioContext(),!!this.audioContext){this.audioContext.state==="suspended"&&this.audioContext.resume();try{if(window.currentStraightOsc)try{window.currentStraightOsc.stop()}catch{}const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination);const i=l.get("frequency"),s=l.get("volume");e.frequency.value=i,e.type="sine";const n=this.audioContext.currentTime;t.gain.setValueAtTime(0,n),t.gain.linearRampToValueAtTime(s,n+.001),e.start(n),window.currentStraightOsc=e,window.currentStraightGain=t}catch(e){console.error("連続音開始エラー:",e)}}}static stopContinuousTone(){if(this.audioContext)try{if(window.currentStraightOsc&&window.currentStraightGain){const e=this.audioContext.currentTime;window.currentStraightGain.gain.cancelScheduledValues(e),window.currentStraightGain.gain.setValueAtTime(window.currentStraightGain.gain.value,e),window.currentStraightGain.gain.linearRampToValueAtTime(0,e+.001),window.currentStraightOsc.stop(e+.002),window.currentStraightOsc=null,window.currentStraightGain=null}}catch(e){console.error("連続音停止エラー:",e)}}static async playMorseString(e){if(this.isPlaying||!e||e==="モールス信号が表示されます"||(this.ensureAudioContext(),this.ensureSidetone(),!this.audioContext))return!1;this.isPlaying=!0;const t=l.get("frequency");this.sidOsc&&this.sidFilter&&(this.sidOsc.frequency.setValueAtTime(t,this.audioContext.currentTime),this.sidFilter.frequency.setValueAtTime(t,this.audioContext.currentTime));const s=1200/l.get("wpm"),n=s,r=3*s,o=s,a=3*s,h=7*s;let u=this.audioContext.currentTime+.02;for(let p=0;p<e.length&&this.isPlaying;p++){const m=e[p];m==="."?(this.scheduleTone(u,n),u+=(n+o)/1e3):m==="-"?(this.scheduleTone(u,r),u+=(r+o)/1e3):m===" "?u+=(a-o)/1e3:m==="/"&&(u+=(h-o)/1e3)}const v=(u-this.audioContext.currentTime)*1e3;await new Promise(p=>setTimeout(p,v));const f=this.isPlaying;return this.isPlaying=!1,f}static stopPlaying(){if(this.isPlaying=!1,this.sidGain&&this.audioContext){const e=this.audioContext.currentTime;this.sidGain.gain.cancelScheduledValues(e),this.sidGain.gain.setValueAtTime(0,e)}}static stopAllScheduledTones(){if(!this.audioContext)return;const e=this.audioContext.currentTime;this.scheduledNodes.forEach(({osc:t,gain:i})=>{try{i.gain.cancelScheduledValues(e),i.gain.setValueAtTime(i.gain.value,e),i.gain.linearRampToValueAtTime(0,e+.01),t.stop(e+.01)}catch{}}),this.scheduledNodes=[]}static init(){document.addEventListener("click",()=>{this.ensureAudioContext()},{once:!0}),document.addEventListener("keydown",()=>{this.ensureAudioContext()},{once:!0})}};b.audioContext=null,b.sidOsc=null,b.sidGain=null,b.sidFilter=null,b.isPlaying=!1,b.scheduledNodes=[];let d=b;//! モールス符号マッピングと変換機能。
//! モールス符号のマッピング型定義。
//! 欧文モールス符号マップ。
const E={A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----."," ":"/",".":".-.-.-",",":"--..--",":":"---...","?":"..--..",_:"..--.-","+":".-.-.","-":"-....-","×":"-..-","^":"......","/":"-..-.","@":".--.-.","(":"-.--.",")":"-.--.-",'"':".-..-.","'":".----.",HH:"........","=":"-...-",VA:"...-.-",AS:".-...",VE:"...-."};//! 和文モールス符号マップ。
const $={ア:"--.--",イ:".-",ウ:"..-",エ:"-.---",オ:".-...",カ:".-..",キ:"-.-..",ク:"...-",ケ:"-.--",コ:"----",サ:"-.-.-",シ:"--.-.",ス:"---.-",セ:".---.",ソ:"---.",タ:"-.",チ:"..-.",ツ:".--.",テ:".-.--",ト:"..-..",ナ:".-.",ニ:"-.-.",ヌ:"....",ネ:"--.-",ノ:"..--",ハ:"-...",ヒ:"--..-",フ:"--..",ヘ:".",ホ:"-..",マ:"-..-",ミ:"..-.-",ム:"-",メ:"-...-",モ:"-..-.",ヤ:".--",ユ:"-..--",ヨ:"--",ラ:"...",リ:"--.",ル:"-.--.",レ:"---",ロ:".-.-",ワ:"-.-",ヲ:".---",ン:".-.-.",ヱ:".--..",ヰ:".-..-.","゛":"..","゜":"..--.",ー:".--.-","、":".-.-.-.-","」":".-.-..","（":"-.--.-","）":".-..-.-",ホレ:"-..----",ラタ:"...-.-","(":"-.--.",")":"-.--.-"," ":"/",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----."};//! モールス符号モジュール。
class y{static getCurrentMorseMap(){return document.getElementById("japaneseMode")?.checked?$:E}static getCurrentMorseToCharMap(){const e=this.getCurrentMorseMap();return Object.fromEntries(Object.entries(e).map(([t,i])=>[i,t]))}static textToMorse(e){const t=this.getCurrentMorseMap(),i=e.toUpperCase(),s=/\[([A-Z]+)\]/g,n=[];let r=0,o;for(;(o=s.exec(i))!==null;){if(o.index>r){const u=i.substring(r,o.index),v=Array.from(u).map(f=>t[f]||f);n.push(v.join(" "))}const h=Array.from(o[1]).map(u=>t[u]||u);n.push(h.join("")),r=s.lastIndex}if(r<i.length){const a=i.substring(r),h=Array.from(a).map(u=>t[u]||u);n.push(h.join(" "))}return n.filter(a=>a).join(" ")}static morseSequencesToText(e){const t=this.getCurrentMorseToCharMap();let i="";for(const s of e)s==="/"?i+=" ":s&&s!==""&&(i+=t[s]||"?");return i}static combineDakutenHandakuten(e){return e}}class A{constructor(e){this.container=e,this.allEntries=[],this.filteredEntries=[],this.selectedTags=[],this.selectedFrequencies=new Set,this.searchQuery="",this.sortKey="abbreviation",this.sortOrder="asc",this.playingAbbreviation=null}loadFilters(){try{const e=localStorage.getItem("v3.selectedFilters");if(e){const t=JSON.parse(e);this.selectedTags=Array.isArray(t.tags)?t.tags:[],this.selectedFrequencies=new Set(Array.isArray(t.frequencies)?t.frequencies:[])}}catch(e){console.error("Failed to load filters:",e)}}saveFilters(){try{const e={tags:this.selectedTags,frequencies:Array.from(this.selectedFrequencies)};localStorage.setItem("v3.selectedFilters",JSON.stringify(e))}catch(e){console.error("Failed to save filters:",e)}}setData(e){this.allEntries=e,this.loadFilters(),this.applyFilters(),this.render()}applyFilters(){let e=this.allEntries;e=w(e,this.selectedTags),this.selectedFrequencies.size>0&&(e=e.filter(t=>this.selectedFrequencies.has(t.frequency))),e=k(e,this.searchQuery),e=T(e,this.sortKey,this.sortOrder),this.filteredEntries=e}render(){const t=x(this.allEntries).map(s=>`<button class="tag-filter-btn ${this.selectedTags.includes(s)?"selected":""}" data-tag="${s}">${s}</button>`).join(""),i=[5,4,3,2,1].map(s=>{const n=this.selectedFrequencies.has(s);return`
        <label class="frequency-checkbox">
          <input type="checkbox" value="${s}" ${n?"checked":""}>
          <span>${"⭐".repeat(s)}</span>
        </label>
      `}).join("");this.container.innerHTML=`
      <div class="list-mode">
        <div class="filter-section">
          <h2>一覧表示モード</h2>

          <div class="filter-controls-fc">
            <div class="filter-group-fc">
              <label>タグフィルタ:</label>
              <div class="tag-buttons-container">
                ${t||'<p style="color: #999;">タグがありません</p>'}
              </div>
            </div>

            <div class="filter-group-fc">
              <label>使用頻度:</label>
              <div class="frequency-checkboxes">
                ${i}
              </div>
            </div>

            <div class="filter-group-fc">
              <label>検索:</label>
              <input type="text" id="search-input" placeholder="略語、英文、和訳、タグで検索..." value="${this.searchQuery}" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%; max-width: 500px;">
            </div>
          </div>

          <div class="result-count">
            ${this.filteredEntries.length}件 / ${this.allEntries.length}件
          </div>
        </div>

        <div class="table-container">
          ${this.renderTable()}
        </div>
      </div>
    `,this.attachEventListeners()}renderTable(){if(this.filteredEntries.length===0)return'<p class="no-results">該当する項目がありません</p>';const e=this.filteredEntries.map(i=>{const n=this.playingAbbreviation===i.abbreviation?"abbreviation-button playing":"abbreviation-button";let r=i.abbreviation;const o=i.abbreviation.match(/^\[([A-Z]+)\]$/);return o&&(r=`<span style="text-decoration: overline;">${o[1]}</span>`),`
      <tr>
        <td class="abbreviation-cell">
          <button class="${n}" data-abbreviation="${i.abbreviation}" title="クリックでモールス符号を再生">${r}</button>
        </td>
        <td>${i.english}</td>
        <td>${i.japanese}</td>
        <td class="frequency-cell">${this.renderFrequency(i.frequency)}</td>
        <td class="tags-cell">${i.tags.join(", ")}</td>
      </tr>
    `}).join(""),t=i=>this.sortKey!==i?"":this.sortOrder==="asc"?" ▲":" ▼";return`
      <table class="flashcard-table">
        <thead>
          <tr>
            <th class="sortable-header" data-sort-key="abbreviation">略語${t("abbreviation")}</th>
            <th class="sortable-header" data-sort-key="english">英文${t("english")}</th>
            <th class="sortable-header" data-sort-key="japanese">和訳${t("japanese")}</th>
            <th class="sortable-header" data-sort-key="frequency">使用頻度${t("frequency")}</th>
            <th class="sortable-header" data-sort-key="tags">タグ${t("tags")}</th>
          </tr>
        </thead>
        <tbody>
          ${e}
        </tbody>
      </table>
    `}renderFrequency(e){return"⭐".repeat(e)}attachEventListeners(){this.container.querySelectorAll(".tag-filter-btn").forEach(r=>{r.addEventListener("click",()=>{const o=r.getAttribute("data-tag");if(o){const a=this.selectedTags.indexOf(o);a>=0?this.selectedTags.splice(a,1):this.selectedTags.push(o),this.applyFilters(),this.saveFilters(),this.render()}})}),this.container.querySelectorAll(".frequency-checkbox input").forEach(r=>{r.addEventListener("change",o=>{const a=parseInt(o.target.value,10);o.target.checked?this.selectedFrequencies.add(a):this.selectedFrequencies.delete(a),this.applyFilters(),this.saveFilters(),this.render()})});const i=this.container.querySelector("#search-input");i&&i.addEventListener("input",()=>{this.searchQuery=i.value,this.applyFilters(),this.saveFilters(),this.render()}),this.container.querySelectorAll(".abbreviation-button").forEach(r=>{r.addEventListener("click",o=>{const h=o.currentTarget.getAttribute("data-abbreviation");h&&this.playMorse(h)})}),this.container.querySelectorAll(".sortable-header").forEach(r=>{r.addEventListener("click",()=>{const o=r.getAttribute("data-sort-key");o&&(this.sortKey===o?this.sortOrder=this.sortOrder==="asc"?"desc":"asc":(this.sortKey=o,this.sortOrder="asc"),this.applyFilters(),this.saveFilters(),this.render())})})}async playMorse(e){if(this.playingAbbreviation===e){d.stopAllScheduledTones(),this.playingAbbreviation=null,this.render();return}this.playingAbbreviation!==null&&d.stopAllScheduledTones();try{this.playingAbbreviation=e,this.render(),d.ensureAudioContext();const t=y.textToMorse(e);t&&await this.playMorseSequence(t),this.playingAbbreviation=null,this.render()}catch(t){console.error("Error playing morse:",t),this.playingAbbreviation=null,this.render()}}async playMorseSequence(e){const t=d.audioContext;if(!t)return;const s=1200/l.get("wpm");let n=t.currentTime;const r=n;for(const a of e)a==="."?(d.scheduleTone(n,s),n+=(s+s)/1e3):a==="-"?(d.scheduleTone(n,s*3),n+=(s*3+s)/1e3):a===" "?n+=s*3/1e3:a==="/"&&(n+=s*7/1e3);const o=(n-r)*1e3;await new Promise(a=>{setTimeout(a,o)})}}class L{constructor(e){this.container=e,this.allEntries=[],this.filteredEntries=[],this.selectedTags=[],this.selectedFrequencies=new Set,this.currentCards=[],this.currentIndex=0,this.isFlipped=!1,this.progress={known:new Set,unknown:new Set},this.reviewMode=!1,this.hideAbbreviation=!1,this.loadProgress(),this.loadFilters()}setData(e){this.allEntries=e,this.applyFilters(),this.render()}applyFilters(){let e=this.allEntries;e=w(e,this.selectedTags),e=e.filter(t=>this.selectedFrequencies.has(t.frequency)),this.filteredEntries=e}saveFilters(){try{const e={tags:this.selectedTags,frequencies:Array.from(this.selectedFrequencies)};localStorage.setItem("v3.selectedFilters",JSON.stringify(e))}catch(e){console.error("Failed to save filters:",e)}}loadFilters(){try{const e=localStorage.getItem("v3.selectedFilters");if(e){const t=JSON.parse(e);this.selectedTags=Array.isArray(t.tags)?t.tags:[],this.selectedFrequencies=new Set(Array.isArray(t.frequencies)?t.frequencies:[])}}catch(e){console.error("Failed to load filters:",e)}}shuffleCards(e){const t=[...e];for(let i=t.length-1;i>0;i--){const s=Math.floor(Math.random()*(i+1));[t[i],t[s]]=[t[s],t[i]]}return t}startLearning(){this.reviewMode?this.currentCards=this.filteredEntries.filter(e=>this.progress.unknown.has(e.abbreviation)):this.currentCards=this.shuffleCards(this.filteredEntries),this.currentIndex=0,this.isFlipped=!1,this.renderLearningView()}render(){const t=x(this.allEntries).map(s=>`<button class="tag-filter-btn ${this.selectedTags.includes(s)?"selected":""}" data-tag="${s}">${s}</button>`).join(""),i=[5,4,3,2,1].map(s=>{const n=this.selectedFrequencies.has(s);return`
        <label class="frequency-checkbox">
          <input type="checkbox" value="${s}" ${n?"checked":""}>
          <span>${"⭐".repeat(s)}</span>
        </label>
      `}).join("");this.container.innerHTML=`
      <div class="flashcard-mode">
        <div class="filter-section">
          <h2>フラッシュカードモード</h2>

          <div class="filter-controls-fc">
            <div class="filter-group-fc">
              <label>タグフィルタ:</label>
              <div class="tag-buttons-container">
                ${t||'<p style="color: #999;">タグがありません</p>'}
              </div>
            </div>

            <div class="filter-group-fc">
              <label>使用頻度:</label>
              <div class="frequency-checkboxes">
                ${i}
              </div>
            </div>

            <div class="filter-group-fc">
              <label>モード:</label>
              <div class="mode-checkboxes">
                <label class="mode-checkbox">
                  <input type="checkbox" id="review-mode-checkbox" ${this.reviewMode?"checked":""}>
                  <span>復習モード（わからないカードのみ）</span>
                </label>
                <label class="mode-checkbox">
                  <input type="checkbox" id="hide-abbreviation-checkbox" ${this.hideAbbreviation?"checked":""}>
                  <span>略語を非表示（モールス再生のみ）</span>
                </label>
              </div>
            </div>
          </div>

          <div class="result-count">
            ${this.getCardCountText()}
          </div>

          <div class="action-buttons">
            <button id="start-learning-btn" class="primary-button">学習開始</button>
            <button id="clear-progress-btn" class="secondary-button">進捗をリセット</button>
          </div>
        </div>
      </div>
    `,this.attachEventListeners()}getCardCountText(){const e=this.filteredEntries.length,t=this.filteredEntries.filter(s=>this.progress.unknown.has(s.abbreviation)).length,i=this.filteredEntries.filter(s=>this.progress.known.has(s.abbreviation)).length;return`全${e}件 / わかる:${i}件 / わからない:${t}件`}renderLearningView(){if(this.currentCards.length===0){this.container.innerHTML=`
        <div class="flashcard-mode">
          <div class="no-cards">
            ${this.reviewMode?"復習するカードがありません":"学習するカードがありません"}
          </div>
          <button id="back-to-setup-btn" class="secondary-button">設定に戻る</button>
        </div>
      `,this.attachBackButton();return}const e=this.currentCards[this.currentIndex],t=this.currentIndex+1,i=this.currentCards.length,s=this.currentIndex>0?this.currentIndex:null,n=this.currentIndex<this.currentCards.length-1?this.currentIndex+2:null;let r=e.abbreviation;const o=e.abbreviation.match(/^\[([A-Z]+)\]$/);o&&(r=`<span style="text-decoration: overline;">${o[1]}</span>`),this.container.innerHTML=`
      <div class="flashcard-mode learning-view">
        <div class="learning-header">
          <button id="back-to-setup-btn" class="secondary-button">← 設定に戻る</button>
        </div>

        <div class="card-container">
          <div class="flashcard ${this.isFlipped?"flipped":""}" id="flashcard">
            <div class="card-front">
              ${this.hideAbbreviation?"":`
                <div class="card-label">略語</div>
                <div class="card-content">${r}</div>
              `}
              <button class="play-morse-btn" id="play-morse-btn" title="モールス符号を再生">♪ モールス再生</button>
            </div>
            <div class="card-back">
              <div class="card-label">意味</div>
              <div class="card-content-small">${r}</div>
              <div class="card-content-small">${e.english}</div>
              <div class="card-content-small">${e.japanese}</div>
              <div class="card-tags">${e.tags.join(", ")} / 頻度:${"⭐".repeat(e.frequency)}</div>
            </div>
          </div>
        </div>

        <div class="card-controls">
          <button id="flip-card-btn" class="control-button">
            ${this.isFlipped?"問題に戻る":"正解を確認する"} (Space)
          </button>
        </div>

        ${this.isFlipped?this.renderJudgmentButtons():""}

        <div class="navigation-controls">
          <button id="prev-card-btn" class="nav-button" ${this.currentIndex===0?"disabled":""}>
            ← 前のカード ${s!==null?`(${s})`:""}
          </button>
          <div class="progress-indicator-center">${t} / ${i}</div>
          <button id="next-card-btn" class="nav-button" ${this.currentIndex>=this.currentCards.length-1?"disabled":""}>
            次のカード ${n!==null?`(${n})`:""} →
          </button>
        </div>
      </div>
    `,this.attachLearningEventListeners()}renderJudgmentButtons(){const e=this.currentCards[this.currentIndex],t=this.progress.known.has(e.abbreviation);return`
      <div class="judgment-controls">
        <button id="mark-unknown-btn" class="judgment-button unknown ${this.progress.unknown.has(e.abbreviation)?"active":""}">
          × わからない
        </button>
        <button id="mark-known-btn" class="judgment-button known ${t?"active":""}">
          ○ わかる
        </button>
      </div>
    `}attachEventListeners(){this.container.querySelectorAll(".tag-filter-btn").forEach(o=>{o.addEventListener("click",()=>{const a=o.getAttribute("data-tag");if(a){const h=this.selectedTags.indexOf(a);h>=0?this.selectedTags.splice(h,1):this.selectedTags.push(a),this.applyFilters(),this.saveFilters(),this.render()}})}),this.container.querySelectorAll(".frequency-checkbox input").forEach(o=>{o.addEventListener("change",a=>{const h=parseInt(a.target.value,10);a.target.checked?this.selectedFrequencies.add(h):this.selectedFrequencies.delete(h),this.applyFilters(),this.saveFilters(),this.render()})});const i=this.container.querySelector("#review-mode-checkbox");i&&i.addEventListener("change",()=>{this.reviewMode=i.checked,this.render()});const s=this.container.querySelector("#hide-abbreviation-checkbox");s&&s.addEventListener("change",()=>{this.hideAbbreviation=s.checked,this.render()});const n=this.container.querySelector("#start-learning-btn");n&&n.addEventListener("click",()=>this.startLearning());const r=this.container.querySelector("#clear-progress-btn");r&&r.addEventListener("click",()=>{confirm("学習進捗をすべてリセットしますか？")&&(this.progress={known:new Set,unknown:new Set},this.saveProgress(),this.render())})}attachLearningEventListeners(){this.attachBackButton();const e=this.container.querySelector("#flip-card-btn");e&&e.addEventListener("click",()=>this.flipCard());const t=this.container.querySelector("#play-morse-btn");t&&t.addEventListener("click",()=>{const n=this.currentCards[this.currentIndex];this.playMorse(n.abbreviation)});const i=this.container.querySelector("#prev-card-btn"),s=this.container.querySelector("#next-card-btn");if(i&&i.addEventListener("click",()=>this.previousCard()),s&&s.addEventListener("click",()=>this.nextCard()),this.isFlipped){const n=this.container.querySelector("#mark-known-btn"),r=this.container.querySelector("#mark-unknown-btn");n&&n.addEventListener("click",()=>this.markAsKnown()),r&&r.addEventListener("click",()=>this.markAsUnknown())}this.attachKeyboardListeners()}attachBackButton(){const e=this.container.querySelector("#back-to-setup-btn");e&&e.addEventListener("click",()=>this.render())}attachKeyboardListeners(){const e=t=>{t.key===" "||t.key==="Spacebar"?(t.preventDefault(),this.flipCard()):t.key==="ArrowRight"?(t.preventDefault(),this.nextCard()):t.key==="ArrowLeft"&&(t.preventDefault(),this.previousCard())};document.removeEventListener("keydown",e),document.addEventListener("keydown",e)}flipCard(){this.isFlipped=!this.isFlipped,this.renderLearningView()}nextCard(){this.currentIndex<this.currentCards.length-1&&(this.currentIndex++,this.isFlipped=!1,this.renderLearningView())}previousCard(){this.currentIndex>0&&(this.currentIndex--,this.isFlipped=!1,this.renderLearningView())}markAsKnown(){const e=this.currentCards[this.currentIndex];this.progress.known.add(e.abbreviation),this.progress.unknown.delete(e.abbreviation),this.saveProgress(),this.currentIndex<this.currentCards.length-1&&(this.currentIndex++,this.isFlipped=!1),this.renderLearningView()}markAsUnknown(){const e=this.currentCards[this.currentIndex];this.progress.unknown.add(e.abbreviation),this.progress.known.delete(e.abbreviation),this.saveProgress(),this.currentIndex<this.currentCards.length-1&&(this.currentIndex++,this.isFlipped=!1),this.renderLearningView()}async playMorse(e){try{d.ensureAudioContext();const t=y.textToMorse(e);t&&await this.playMorseSequence(t)}catch(t){console.error("Error playing morse:",t)}}async playMorseSequence(e){const t=d.audioContext;if(!t)return;const s=1200/l.get("wpm");let n=t.currentTime;for(const r of e)r==="."?(d.scheduleTone(n,s),n+=(s+s)/1e3):r==="-"?(d.scheduleTone(n,s*3),n+=(s*3+s)/1e3):r===" "?n+=s*3/1e3:r==="/"&&(n+=s*7/1e3)}saveProgress(){const e={known:Array.from(this.progress.known),unknown:Array.from(this.progress.unknown)};localStorage.setItem("flashcard-progress",JSON.stringify(e))}loadProgress(){try{const e=localStorage.getItem("flashcard-progress");if(e){const t=JSON.parse(e);this.progress={known:new Set(t.known||[]),unknown:new Set(t.unknown||[])}}}catch(e){console.error("Failed to load progress:",e)}}}class M{constructor(e){this.container=e,this.allEntries=[],this.filteredEntries=[],this.selectedTags=[],this.selectedFrequencies=new Set,this.questions=[],this.currentQuestionIndex=0,this.results=[],this.questionCount=10,this.questionType="abbr-to-meaning"}loadFilters(){try{const e=localStorage.getItem("v3.selectedFilters");if(e){const t=JSON.parse(e);this.selectedTags=Array.isArray(t.tags)?t.tags:[],this.selectedFrequencies=new Set(Array.isArray(t.frequencies)?t.frequencies:[])}}catch(e){console.error("Failed to load filters:",e)}}saveFilters(){try{const e={tags:this.selectedTags,frequencies:Array.from(this.selectedFrequencies)};localStorage.setItem("v3.selectedFilters",JSON.stringify(e))}catch(e){console.error("Failed to save filters:",e)}}setData(e){this.allEntries=e,this.loadFilters(),this.applyFilters(),this.render()}applyFilters(){let e=this.allEntries;e=w(e,this.selectedTags),this.selectedFrequencies.size>0&&(e=e.filter(t=>this.selectedFrequencies.has(t.frequency))),this.filteredEntries=e}render(){const t=x(this.allEntries).map(s=>`<button class="tag-filter-btn ${this.selectedTags.includes(s)?"selected":""}" data-tag="${s}">${s}</button>`).join(""),i=[5,4,3,2,1].map(s=>{const n=this.selectedFrequencies.has(s);return`
        <label class="frequency-checkbox">
          <input type="checkbox" value="${s}" ${n?"checked":""}>
          <span>${"⭐".repeat(s)}</span>
        </label>
      `}).join("");this.container.innerHTML=`
      <div class="exam-mode">
        <div class="filter-section">
          <h2>試験モード</h2>

          <div class="filter-controls-fc">
            <div class="filter-group-fc">
              <label>タグフィルタ:</label>
              <div class="tag-buttons-container">
                ${t||'<p style="color: #999;">タグがありません</p>'}
              </div>
            </div>

            <div class="filter-group-fc">
              <label>使用頻度:</label>
              <div class="frequency-checkboxes">
                ${i}
              </div>
            </div>

            <div class="filter-group-fc">
              <label>出題形式:</label>
              <div class="question-type-buttons">
                <button class="question-type-btn ${this.questionType==="abbr-to-meaning"?"selected":""}" data-type="abbr-to-meaning">略語→意味（基礎）</button>
                <button class="question-type-btn ${this.questionType==="meaning-to-abbr"?"selected":""}" data-type="meaning-to-abbr">意味→略語（応用）</button>
                <button class="question-type-btn ${this.questionType==="morse-to-abbr"?"selected":""}" data-type="morse-to-abbr">モールス音→略語（実践）</button>
                <button class="question-type-btn ${this.questionType==="morse-to-meaning"?"selected":""}" data-type="morse-to-meaning">モールス音→意味（実践）</button>
              </div>
            </div>

            <div class="filter-group-fc">
              <label>問題数:</label>
              <div class="question-count-buttons">
                <button class="question-count-btn ${this.questionCount===5?"selected":""}" data-count="5">5問</button>
                <button class="question-count-btn ${this.questionCount===10?"selected":""}" data-count="10">10問</button>
                <button class="question-count-btn ${this.questionCount===20?"selected":""}" data-count="20">20問</button>
                <button class="question-count-btn ${this.questionCount===50?"selected":""}" data-count="50">50問</button>
              </div>
            </div>
          </div>

          <div class="result-count">
            出題可能: ${this.filteredEntries.length}件
          </div>

          <div class="action-buttons">
            <button id="start-exam-btn" class="primary-button">試験開始</button>
          </div>
        </div>
      </div>
    `,this.attachEventListeners()}startExam(){this.questions=this.generateQuestions(),this.currentQuestionIndex=0,this.results=[],this.renderQuestionView()}generateQuestions(){const e=Math.min(this.questionCount,this.filteredEntries.length);return[...this.filteredEntries].sort(()=>Math.random()-.5).slice(0,e).map(s=>this.createQuestion(s))}createQuestion(e){const i=this.filteredEntries.filter(r=>r.abbreviation!==e.abbreviation).sort(()=>Math.random()-.5).slice(0,3);let s,n;switch(this.questionType){case"abbr-to-meaning":s=`${e.english} / ${e.japanese}`,n=[s,...i.map(r=>`${r.english} / ${r.japanese}`)];break;case"meaning-to-abbr":s=e.abbreviation,n=[s,...i.map(r=>r.abbreviation)];break;case"morse-to-abbr":s=e.abbreviation,n=[s,...i.map(r=>r.abbreviation)];break;case"morse-to-meaning":s=`${e.english} / ${e.japanese}`,n=[s,...i.map(r=>`${r.english} / ${r.japanese}`)];break}return n=n.sort(()=>Math.random()-.5),{type:this.questionType,entry:e,choices:n,correctAnswer:s}}renderQuestionView(){if(this.currentQuestionIndex>=this.questions.length){this.renderResultView();return}const e=this.questions[this.currentQuestionIndex],t=`問題 ${this.currentQuestionIndex+1} / ${this.questions.length}`;this.container.innerHTML=`
      <div class="exam-mode question-view">
        <div class="exam-header">
          <button id="quit-exam-btn" class="secondary-button">試験を中止</button>
          <div class="progress-indicator">${t}</div>
        </div>

        <div class="question-container">
          ${this.renderQuestion(e)}
        </div>

        <div class="choices-container">
          ${this.renderChoices(e)}
        </div>

        <div id="feedback-area" class="feedback-area"></div>
      </div>
    `,this.attachQuestionEventListeners(),(e.type==="morse-to-abbr"||e.type==="morse-to-meaning")&&setTimeout(()=>this.playMorse(e.entry.abbreviation),500)}renderQuestion(e){switch(e.type){case"abbr-to-meaning":return`
          <div class="question-text">
            <p>次の略語の意味を選んでください:</p>
            <p class="question-abbr">${e.entry.abbreviation}</p>
          </div>
        `;case"meaning-to-abbr":return`
          <div class="question-text">
            <p>次の意味に対応する略語を選んでください:</p>
            <p class="question-meaning">${e.entry.english}</p>
            <p class="question-meaning">${e.entry.japanese}</p>
          </div>
        `;case"morse-to-abbr":return`
          <div class="question-text">
            <p>モールス音を聞いて、対応する略語を選んでください:</p>
            <button id="replay-morse-btn" class="control-button">♪ もう一度再生</button>
          </div>
        `;case"morse-to-meaning":return`
          <div class="question-text">
            <p>モールス音を聞いて、対応する意味を選んでください:</p>
            <button id="replay-morse-btn" class="control-button">♪ もう一度再生</button>
          </div>
        `}}renderChoices(e){return e.choices.map((t,i)=>`
      <button class="choice-button" data-choice="${t}">
        ${String.fromCharCode(65+i)}. ${t}
      </button>
    `).join("")}renderResultView(){const e=this.results.filter(n=>n.isCorrect).length,t=this.results.length,i=Math.round(e/t*100),s=this.results.filter(n=>!n.isCorrect);this.container.innerHTML=`
      <div class="exam-mode result-view">
        <div class="result-header">
          <h2>試験結果</h2>
        </div>

        <div class="score-display">
          <div class="score-large">${e} / ${t}</div>
          <div class="score-percentage">${i}%</div>
        </div>

        <div class="result-details">
          ${s.length>0?`
            <h3>間違えた問題 (${s.length}問)</h3>
            <div class="wrong-questions">
              ${s.map(n=>this.renderWrongQuestion(n)).join("")}
            </div>
          `:`
            <p class="perfect-score">全問正解です！おめでとうございます！</p>
          `}
        </div>

        <div class="action-buttons">
          <button id="back-to-setup-btn" class="primary-button">設定に戻る</button>
          ${s.length>0?`
            <button id="retry-wrong-btn" class="secondary-button">間違えた問題を復習</button>
          `:""}
        </div>
      </div>
    `,this.attachResultEventListeners()}renderWrongQuestion(e){const{question:t,userAnswer:i}=e;return`
      <div class="wrong-question-item">
        <div class="wrong-q-abbr">${t.entry.abbreviation}</div>
        <div class="wrong-q-correct">正解: ${t.correctAnswer}</div>
        <div class="wrong-q-user">あなたの回答: ${i}</div>
        <div class="wrong-q-meaning">${t.entry.english} / ${t.entry.japanese}</div>
      </div>
    `}attachEventListeners(){this.container.querySelectorAll(".tag-filter-btn").forEach(r=>{r.addEventListener("click",()=>{const o=r.getAttribute("data-tag");if(o){const a=this.selectedTags.indexOf(o);a>=0?this.selectedTags.splice(a,1):this.selectedTags.push(o),this.applyFilters(),this.saveFilters(),this.render()}})}),this.container.querySelectorAll(".frequency-checkbox input").forEach(r=>{r.addEventListener("change",o=>{const a=parseInt(o.target.value,10);o.target.checked?this.selectedFrequencies.add(a):this.selectedFrequencies.delete(a),this.applyFilters(),this.saveFilters(),this.render()})}),this.container.querySelectorAll(".question-type-btn").forEach(r=>{r.addEventListener("click",()=>{const o=r.getAttribute("data-type");o&&(this.questionType=o,this.render())})}),this.container.querySelectorAll(".question-count-btn").forEach(r=>{r.addEventListener("click",()=>{const o=parseInt(r.getAttribute("data-count")||"10",10);this.questionCount=o,this.render()})});const n=this.container.querySelector("#start-exam-btn");n&&n.addEventListener("click",()=>this.startExam())}attachQuestionEventListeners(){const e=this.container.querySelector("#quit-exam-btn");e&&e.addEventListener("click",()=>{confirm("試験を中止しますか？")&&this.render()});const t=this.container.querySelector("#replay-morse-btn");t&&t.addEventListener("click",()=>{const s=this.questions[this.currentQuestionIndex];this.playMorse(s.entry.abbreviation)}),this.container.querySelectorAll(".choice-button").forEach(s=>{s.addEventListener("click",()=>{const n=s.getAttribute("data-choice");n&&this.submitAnswer(n)})})}attachResultEventListeners(){const e=this.container.querySelector("#back-to-setup-btn");e&&e.addEventListener("click",()=>this.render());const t=this.container.querySelector("#retry-wrong-btn");t&&t.addEventListener("click",()=>{const i=this.results.filter(s=>!s.isCorrect).map(s=>s.question.entry);this.filteredEntries=i,this.questionCount=i.length,this.startExam()})}submitAnswer(e){const t=this.questions[this.currentQuestionIndex],i=e===t.correctAnswer;this.results.push({question:t,userAnswer:e,isCorrect:i}),this.showFeedback(i,t.correctAnswer),setTimeout(()=>{this.currentQuestionIndex++,this.renderQuestionView()},1500)}showFeedback(e,t){const i=this.container.querySelector("#feedback-area");i&&(i.className=`feedback-area ${e?"correct":"incorrect"}`,i.innerHTML=e?'<div class="feedback-text">✓ 正解！</div>':`<div class="feedback-text">✗ 不正解<br>正解: ${t}</div>`),this.container.querySelectorAll(".choice-button").forEach(n=>{n.disabled=!0})}async playMorse(e){try{d.ensureAudioContext();const t=y.textToMorse(e);t&&await this.playMorseSequence(t)}catch(t){console.error("Error playing morse:",t)}}async playMorseSequence(e){const t=d.audioContext;if(!t)return;const s=1200/l.get("wpm");let n=t.currentTime;for(const r of e)r==="."?(d.scheduleTone(n,s),n+=(s+s)/1e3):r==="-"?(d.scheduleTone(n,s*3),n+=(s*3+s)/1e3):r===" "?n+=s*3/1e3:r==="/"&&(n+=s*7/1e3)}}class F{constructor(){this.modal=null,this.isOpen=!1,this.isPlaying=!1,this.playbackTimeoutId=null,this.savedSettings=null,this.createModal(),this.attachEventListeners(),l.addListener(()=>this.updateUI())}createModal(){const e=document.createElement("div");e.className="settings-modal",e.id="settingsModal";const t=l.getAll();e.innerHTML=`
      <div class="settings-content">
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-row">
              <label>音量</label>
              <span class="spacer"></span>
              <input type="range" id="volumeRange" min="0" max="100" value="${t.volume*100}" style="width: 50%;">
              <input type="number" id="volumeInput" min="0" max="100" value="${Math.round(t.volume*100)}">
              <span class="input-suffix">%</span>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-row">
              <label>周波数 (Hz)</label>
              <span class="spacer"></span>
              <span class="spacer"></span>
              <input type="number" id="globalFrequency" min="400" max="1200" value="${t.frequency}" step="50">
              <span class="input-suffix"></span>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-row">
              <label>WPM (速度: 5-40)</label>
              <span class="spacer"></span>
              <span class="spacer"></span>
              <input type="number" id="globalWPM" min="5" max="40" value="${t.wpm}">
              <span class="input-suffix"></span>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-row">
              <label>テスト再生</label>
              <span class="spacer"></span>
              <span class="spacer"></span>
              <button id="testMorseBtn" style="min-width: 100px;">再生</button>
              <span class="input-suffix"></span>
            </div>
          </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px;">
          <button id="settingsReset" style="min-width: 120px; padding: 10px 20px; background: linear-gradient(135deg, #888 0%, #666 100%); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all .3s ease;">Cancel</button>
          <button id="settingsOK" style="min-width: 120px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all .3s ease;">OK</button>
        </div>
      </div>
    `,document.body.appendChild(e),this.modal=e}open(){if(this.modal){const e=l.getAll();this.savedSettings={volume:e.volume,frequency:e.frequency,wpm:e.wpm},this.modal.classList.add("active"),this.isOpen=!0,this.updateUI()}}close(e=!1){this.modal&&(this.modal.classList.remove("active"),this.isOpen=!1,e?l.save():this.savedSettings&&(l.set("volume",this.savedSettings.volume),l.set("frequency",this.savedSettings.frequency),l.set("wpm",this.savedSettings.wpm)),this.savedSettings=null,this.isPlaying&&(d.stopAllScheduledTones(),this.playbackTimeoutId!==null&&(clearTimeout(this.playbackTimeoutId),this.playbackTimeoutId=null),this.isPlaying=!1,this.updateTestButton()))}updateUI(){if(!this.modal||!this.isOpen)return;const e=l.getAll(),t=this.modal.querySelector("#volumeRange"),i=this.modal.querySelector("#volumeInput");t&&i&&(t.value=String(e.volume*100),i.value=String(Math.round(e.volume*100)));const s=this.modal.querySelector("#globalFrequency");s&&(s.value=String(e.frequency));const n=this.modal.querySelector("#globalWPM");n&&(n.value=String(e.wpm))}attachEventListeners(){if(!this.modal)return;this.modal.addEventListener("click",a=>{a.target===this.modal&&this.close()});const e=this.modal.querySelector("#volumeRange"),t=this.modal.querySelector("#volumeInput");e&&e.addEventListener("input",()=>{const a=parseInt(e.value,10)/100;l.set("volume",a),t&&(t.value=e.value)}),t&&t.addEventListener("input",()=>{const a=parseInt(t.value,10)/100;l.set("volume",Math.max(0,Math.min(1,a))),e&&(e.value=t.value)});const i=this.modal.querySelector("#globalFrequency");i&&i.addEventListener("input",()=>{const a=parseInt(i.value,10);l.set("frequency",Math.max(400,Math.min(1200,a)))});const s=this.modal.querySelector("#globalWPM");s&&s.addEventListener("input",()=>{const a=parseInt(s.value,10);l.set("wpm",Math.max(5,Math.min(40,a)))});const n=this.modal.querySelector("#testMorseBtn");n&&n.addEventListener("click",()=>{this.playTestMorse()});const r=this.modal.querySelector("#settingsReset");r&&r.addEventListener("click",()=>{this.close()});const o=this.modal.querySelector("#settingsOK");o&&o.addEventListener("click",()=>{this.close(!0)})}async playTestMorse(){if(this.isPlaying){d.stopAllScheduledTones(),this.playbackTimeoutId!==null&&(clearTimeout(this.playbackTimeoutId),this.playbackTimeoutId=null),this.isPlaying=!1,this.updateTestButton();return}try{this.isPlaying=!0,this.updateTestButton(),d.ensureAudioContext();const e=y.textToMorse("CQ");e&&await this.playMorseSequence(e),this.isPlaying&&(this.isPlaying=!1,this.updateTestButton())}catch(e){console.error("Error playing test morse:",e),this.isPlaying=!1,this.updateTestButton()}}updateTestButton(){const e=this.modal?.querySelector("#testMorseBtn");e&&(e.textContent=this.isPlaying?"停止":"再生",this.isPlaying?e.classList.add("playing"):e.classList.remove("playing"))}async playMorseSequence(e){const t=d.audioContext;if(!t)return;const s=1200/l.get("wpm");let n=t.currentTime;const r=n;for(const a of e)a==="."?(d.scheduleTone(n,s),n+=(s+s)/1e3):a==="-"?(d.scheduleTone(n,s*3),n+=(s*3+s)/1e3):a===" "?n+=s*3/1e3:a==="/"&&(n+=s*7/1e3);const o=(n-r)*1e3;await new Promise(a=>{this.playbackTimeoutId=window.setTimeout(()=>{this.playbackTimeoutId=null,a()},o)})}}class I{constructor(){this.uiControls=null,this.listMode=null,this.flashcardMode=null,this.examMode=null,this.settingsModal=null}async initialize(){try{this.showLoading();const e=await q();console.log(`Loaded ${e.length} flashcard entries`);const t=document.getElementById("app");if(!t)throw new Error("App container not found");this.uiControls=new S(t),this.uiControls.initialize();const i=this.uiControls.getContentContainer();if(!i)throw new Error("Content container not found");this.listMode=new A(i),this.listMode.setData(e),this.flashcardMode=new L(i),this.examMode=new M(i),this.settingsModal=new F;const s=document.getElementById("settingsIcon");s&&this.settingsModal&&s.addEventListener("click",()=>{this.settingsModal?.open()}),this.uiControls.onTabChange("list",()=>{i&&this.listMode&&this.listMode.setData(e)}),this.uiControls.onTabChange("flashcard",()=>{i&&this.flashcardMode&&this.flashcardMode.setData(e)}),this.uiControls.onTabChange("exam",()=>{i&&this.examMode&&this.examMode.setData(e)}),this.hideLoading()}catch(e){console.error("Failed to initialize app:",e),this.showError("アプリケーションの初期化に失敗しました。データファイルを確認してください。")}}showLoading(){const e=document.getElementById("app");e&&(e.innerHTML='<div class="loading">読み込み中...</div>')}hideLoading(){const e=document.querySelector(".loading");e&&e.remove()}showError(e){const t=document.getElementById("app");t&&(t.innerHTML=`<div class="error">${e}</div>`)}}document.addEventListener("DOMContentLoaded",()=>{new I().initialize()});</script>
  <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Arial,sans-serif;font-size:16px;line-height:1.6;color:#333;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}.settings-icon{position:fixed;top:20px;right:20px;width:50px;height:50px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 15px #0003;z-index:100;transition:all .3s ease}.settings-icon:hover{transform:rotate(90deg) scale(1.1)}.settings-icon svg{width:28px;height:28px;fill:#667eea}.settings-modal{display:none;position:fixed;inset:0;background:#00000080;z-index:200;align-items:center;justify-content:center;padding:20px}.settings-modal.active{display:flex}.settings-content{background:#fff;border-radius:20px;padding:30px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px #0000004d;scrollbar-width:none;-ms-overflow-style:none}.settings-content::-webkit-scrollbar{display:none}.settings-grid{display:grid;grid-template-columns:1fr;gap:20px}.setting-item{display:flex;flex-direction:column;gap:8px}.setting-item label{font-weight:600;color:#555;font-size:15px}.setting-row{display:grid;grid-template-columns:auto 1fr auto auto auto;gap:10px;align-items:center}.spacer{width:100%}.setting-row input[type=number]{width:80px;text-align:center;padding:8px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px}.setting-row input[type=range]{max-width:300px}.input-suffix{display:inline-block;width:20px;text-align:left;justify-self:start}.setting-row button{padding:10px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;transition:all .3s ease}.setting-row button:hover{transform:translateY(-2px);box-shadow:0 4px 12px #667eea66}.setting-row button.playing{background:linear-gradient(135deg,#f5f5f5,#e0e0e0);color:#333;animation:pulse 1s ease-in-out infinite}#app{max-width:1400px;margin:0 auto;background-color:#fff;border-radius:8px;box-shadow:0 2px 8px #0000001a;padding:20px}.loading,.error{text-align:center;padding:40px;font-size:18px}.error{color:#d32f2f;background-color:#ffebee;border-radius:4px}.tabs{display:flex;gap:8px;border-bottom:2px solid #e0e0e0;margin-bottom:20px}.tab-button{padding:12px 24px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;font-weight:500;color:#666;transition:all .2s}.tab-button:hover:not(:disabled){color:#333;background-color:#f5f5f5}.tab-button.active{color:#1976d2;border-bottom-color:#1976d2}.tab-button:disabled{color:#bbb;cursor:not-allowed}.tab-content{min-height:400px}.list-mode{display:flex;flex-direction:column;gap:20px}.filter-section{background-color:#f9f9f9;padding:20px;border-radius:8px;border:1px solid #e0e0e0}.filter-section h2{font-size:24px;margin-bottom:16px;color:#333}.filter-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:12px}.filter-group{display:flex;flex-direction:column;gap:8px}.filter-group label{font-weight:500;font-size:14px;color:#555}.filter-group select,.filter-group input{padding:8px 12px;border:1px solid #ccc;border-radius:4px;font-size:14px;background-color:#fff}.filter-group select:focus,.filter-group input:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 2px #1976d21a}#tag-filter{min-height:100px}.result-count{text-align:right;font-size:14px;color:#666;margin-top:8px}.table-container{overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px}.flashcard-table{width:100%;border-collapse:collapse;background-color:#fff}.flashcard-table thead{background-color:#f5f5f5;border-bottom:2px solid #e0e0e0}.flashcard-table th{padding:12px 16px;text-align:left;font-weight:600;font-size:14px;color:#555}.sortable-header{cursor:pointer;-webkit-user-select:none;user-select:none;transition:background-color .2s}.sortable-header:hover{background-color:#e8e8e8}.flashcard-table td{padding:12px 16px;border-top:1px solid #e0e0e0;font-size:14px}.flashcard-table tbody tr:hover{background-color:#f9f9f9}.abbreviation-cell{text-align:center}.abbreviation-button{padding:10px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:Courier New,monospace;font-size:15px;transition:all .3s ease}.abbreviation-button:hover{transform:translateY(-2px);box-shadow:0 4px 12px #667eea66}.abbreviation-button:focus{outline:2px solid #1976d2;outline-offset:2px}.abbreviation-button.playing{background:linear-gradient(135deg,#f5f5f5,#e0e0e0)!important;color:#333!important;animation:pulse 1s ease-in-out infinite}@keyframes pulse{0%,to{opacity:1}50%{opacity:.7}}.frequency-cell{font-size:18px;color:#ffa726}.tags-cell{font-size:13px;color:#666}.no-results{text-align:center;padding:40px;color:#999;font-size:16px}@media (max-width: 768px){body{padding:10px}#app{padding:15px}.filter-controls{grid-template-columns:1fr}.flashcard-table{font-size:13px}.flashcard-table th,.flashcard-table td{padding:8px 12px}.tab-button{padding:10px 16px;font-size:14px}}:focus{outline:2px solid #1976d2;outline-offset:2px}button:focus,select:focus,input:focus{outline:2px solid #1976d2;outline-offset:2px}.action-buttons{display:flex;gap:12px;margin-top:16px}.primary-button,.secondary-button,.control-button{padding:12px 24px;border-radius:4px;font-size:16px;font-weight:500;cursor:pointer;transition:all .2s;border:none}.primary-button{background-color:#1976d2;color:#fff}.primary-button:hover{background-color:#1565c0}.secondary-button{background-color:#e0e0e0;color:#333}.secondary-button:hover{background-color:#d0d0d0}.control-button{background-color:#4caf50;color:#fff}.control-button:hover{background-color:#45a049}.flashcard-mode{display:flex;flex-direction:column;gap:20px}.filter-controls-fc{display:flex;flex-direction:column;gap:20px;margin-bottom:12px}.filter-group-fc{display:flex;flex-direction:column;gap:10px}.filter-group-fc>label{font-weight:600;font-size:15px;color:#555}.tag-buttons-container{display:flex;flex-wrap:wrap;gap:8px}.tag-filter-btn{padding:10px 20px;background-color:#e0e0e0;color:#333;border:2px solid transparent;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s}.tag-filter-btn:hover{background-color:#d0d0d0}.tag-filter-btn.selected{background-color:#667eea;color:#fff;border-color:#667eea}.frequency-checkboxes{display:flex;gap:15px;flex-wrap:wrap}.frequency-checkbox{display:flex;align-items:center;gap:8px;padding:10px 15px;background-color:#f5f5f5;border:2px solid #e0e0e0;border-radius:8px;cursor:pointer;transition:all .2s;font-size:16px}.frequency-checkbox:hover{background-color:#e8e8e8;border-color:#d0d0d0}.frequency-checkbox input[type=checkbox]{width:20px;height:20px;cursor:pointer}.frequency-checkbox span{font-size:18px;-webkit-user-select:none;user-select:none}.mode-checkboxes{display:flex;flex-direction:column;gap:10px}.mode-checkbox{display:flex;align-items:center;gap:10px;padding:12px 18px;background-color:#f5f5f5;border:2px solid #e0e0e0;border-radius:8px;cursor:pointer;transition:all .2s;font-size:16px;max-width:450px}.mode-checkbox:hover{background-color:#e8e8e8;border-color:#d0d0d0}.mode-checkbox input[type=checkbox]{width:22px;height:22px;cursor:pointer}.mode-checkbox span{-webkit-user-select:none;user-select:none;font-weight:500}.learning-view{min-height:600px}.learning-header,.exam-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.progress-indicator{font-size:18px;font-weight:600;color:#666}.card-container{display:flex;justify-content:center;align-items:center;min-height:400px;perspective:1000px}.flashcard{width:100%;max-width:600px;height:400px;position:relative;transform-style:preserve-3d;transition:transform .6s}.flashcard.flipped{transform:rotateY(180deg)}.card-front,.card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border:2px solid #1976d2;border-radius:12px;padding:40px;display:flex;flex-direction:column;justify-content:center;align-items:center;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);box-shadow:0 4px 12px #00000026}.card-back{transform:rotateY(180deg);background:linear-gradient(135deg,#e0f7fa,#80deea)}.card-label{font-size:14px;font-weight:500;color:#666;margin-bottom:16px;text-transform:uppercase;letter-spacing:1px}.card-content{font-size:72px;font-weight:700;font-family:Courier New,monospace;color:#1976d2;text-align:center;margin-bottom:20px}.card-content-small{font-size:24px;font-weight:500;color:#333;text-align:center;margin-bottom:12px}.card-tags{font-size:14px;color:#666;margin-top:20px;text-align:center}.play-morse-btn{margin-top:auto;padding:10px 20px;background-color:#1976d2;color:#fff;border:none;border-radius:4px;font-size:14px;cursor:pointer;transition:all .2s}.play-morse-btn:hover{background-color:#1565c0}.card-controls{display:flex;justify-content:center;margin:20px 0}.judgment-controls{display:flex;justify-content:center;gap:20px;margin:20px 0}.judgment-button{padding:16px 32px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;border:2px solid;transition:all .2s}.judgment-button.known{background-color:#e8f5e9;color:#2e7d32;border-color:#4caf50}.judgment-button.known:hover,.judgment-button.known.active{background-color:#4caf50;color:#fff}.judgment-button.unknown{background-color:#ffebee;color:#c62828;border-color:#ef5350}.judgment-button.unknown:hover,.judgment-button.unknown.active{background-color:#ef5350;color:#fff}.navigation-controls{display:flex;justify-content:center;align-items:center;gap:20px;margin-top:20px}.progress-indicator-center{font-size:20px;font-weight:700;color:#667eea;min-width:100px;text-align:center}.nav-button{padding:12px 24px;background-color:#e0e0e0;color:#333;border:none;border-radius:4px;font-size:16px;cursor:pointer;transition:all .2s}.nav-button:hover:not(:disabled){background-color:#d0d0d0}.nav-button:disabled{opacity:.5;cursor:not-allowed}.no-cards{text-align:center;padding:60px 20px;font-size:20px;color:#666}.exam-mode{display:flex;flex-direction:column;gap:20px}.question-type-buttons{display:flex;flex-wrap:wrap;gap:10px}.question-type-btn{padding:12px 20px;background-color:#e0e0e0;color:#333;border:2px solid transparent;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;flex:1;min-width:150px}.question-type-btn:hover{background-color:#d0d0d0}.question-type-btn.selected{background-color:#667eea;color:#fff;border-color:#667eea}.question-count-buttons{display:flex;gap:10px;flex-wrap:wrap}.question-count-btn{padding:10px 20px;background-color:#e0e0e0;color:#333;border:2px solid transparent;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;min-width:70px}.question-count-btn:hover{background-color:#d0d0d0}.question-count-btn.selected{background-color:#667eea;color:#fff;border-color:#667eea}.question-view{min-height:600px}.question-container{background-color:#f9f9f9;padding:40px;border-radius:8px;border:1px solid #e0e0e0;margin-bottom:30px}.question-text{font-size:20px;color:#333;margin-bottom:20px}.question-text p{margin-bottom:12px}.question-abbr{font-size:48px;font-weight:700;font-family:Courier New,monospace;color:#1976d2;text-align:center;margin:20px 0}.question-meaning{font-size:18px;font-weight:500;color:#555;text-align:center;margin:12px 0}.choices-container{display:grid;grid-template-columns:1fr;gap:12px;max-width:800px;margin:0 auto}.choice-button{padding:16px 24px;background-color:#fff;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;text-align:left;cursor:pointer;transition:all .2s}.choice-button:hover:not(:disabled){border-color:#1976d2;background-color:#f0f8ff}.choice-button:disabled{cursor:not-allowed;opacity:.6}.feedback-area{margin-top:30px;text-align:center;min-height:60px;display:flex;align-items:center;justify-content:center}.feedback-text{font-size:24px;font-weight:600;padding:20px 40px;border-radius:8px}.feedback-area.correct .feedback-text{background-color:#e8f5e9;color:#2e7d32;border:2px solid #4caf50}.feedback-area.incorrect .feedback-text{background-color:#ffebee;color:#c62828;border:2px solid #ef5350}.result-view{min-height:600px}.result-header h2{font-size:32px;color:#333;text-align:center;margin-bottom:30px}.score-display{text-align:center;padding:40px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;color:#fff;margin-bottom:40px}.score-large{font-size:64px;font-weight:700;margin-bottom:12px}.score-percentage{font-size:36px;font-weight:500}.result-details{max-width:800px;margin:0 auto}.result-details h3{font-size:24px;color:#333;margin-bottom:20px}.wrong-questions{display:flex;flex-direction:column;gap:16px}.wrong-question-item{background-color:#fff3e0;border:2px solid #ffa726;border-radius:8px;padding:20px}.wrong-q-abbr{font-size:24px;font-weight:700;font-family:Courier New,monospace;color:#1976d2;margin-bottom:12px}.wrong-q-correct{font-size:16px;font-weight:600;color:#2e7d32;margin-bottom:8px}.wrong-q-user{font-size:16px;color:#c62828;margin-bottom:12px}.wrong-q-meaning{font-size:14px;color:#666;font-style:italic}.perfect-score{text-align:center;font-size:24px;font-weight:600;color:#2e7d32;padding:40px;background-color:#e8f5e9;border-radius:8px}@media (max-width: 768px){.card-content{font-size:48px}.card-content-small{font-size:18px}.flashcard{height:300px}.judgment-button{font-size:16px;padding:12px 24px}.score-large{font-size:48px}.score-percentage{font-size:28px}}.settings-panel{max-width:800px;margin:0 auto}.settings-panel h2{font-size:28px;color:#333;margin-bottom:24px}.settings-section{background-color:#f9f9f9;padding:24px;border-radius:8px;border:1px solid #e0e0e0;margin-bottom:20px}.settings-section h3{font-size:20px;color:#555;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #e0e0e0}.setting-item{margin-bottom:24px}.setting-item:last-child{margin-bottom:0}.setting-item label{display:block;font-weight:600;font-size:15px;color:#333;margin-bottom:12px}.setting-control{display:flex;align-items:center;gap:16px}.setting-range{flex:1;height:8px;border-radius:4px;background:#e0e0e0;outline:none;-webkit-appearance:none;appearance:none}.setting-range::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:#1976d2;cursor:pointer;transition:all .2s}.setting-range::-webkit-slider-thumb:hover{background:#1565c0;transform:scale(1.1)}.setting-range::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#1976d2;cursor:pointer;border:none;transition:all .2s}.setting-range::-moz-range-thumb:hover{background:#1565c0;transform:scale(1.1)}.setting-number{width:80px;padding:8px 12px;border:1px solid #ccc;border-radius:4px;font-size:14px;text-align:center}.setting-number:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 2px #1976d21a}.setting-unit{font-size:14px;font-weight:500;color:#666;min-width:40px}.test-section{text-align:center;padding:20px}.test-description{margin-top:12px;font-size:14px;color:#666}.settings-actions{display:flex;justify-content:center;gap:16px;margin:24px 0}.settings-actions button.saved{background-color:#4caf50}.settings-info{background-color:#e3f2fd;border:1px solid #90caf9;border-radius:8px;padding:20px;margin-top:24px}.settings-info h3{font-size:18px;color:#1565c0;margin-bottom:12px}.settings-info ul{list-style:none;padding:0;margin:0 0 16px}.settings-info li{margin-bottom:8px;padding-left:20px;position:relative}.settings-info li:before{content:"•";position:absolute;left:0;color:#1976d2;font-weight:700}.settings-note{font-size:13px;color:#666;font-style:italic;margin-top:12px}@media (max-width: 768px){.settings-panel{padding:0}.setting-control{flex-direction:column;align-items:stretch}.setting-number{width:100%}}</style>
</head>
<body>
  <div class="settings-icon" id="settingsIcon">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
    </svg>
  </div>

  <div id="app"></div>
</body>
</html>
