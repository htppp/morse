<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>縦振り電鍵練習 - モールス練習アプリ v4</title>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class v{constructor(t={frequency:750,volume:.7,wpm:20}){this.audioContext=null,this.currentOscillator=null,this.currentGain=null,this.isPlaying=!1,this.settings=t,this.loadSettings(),this.init()}ensureAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioContext.state==="suspended"&&this.audioContext.resume()}init(){const t=async()=>{this.ensureAudioContext(),await this.playInitializationTone(),document.removeEventListener("click",t),document.removeEventListener("keydown",t),document.removeEventListener("touchstart",t)};document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0})}async playInitializationTone(){const t=this.settings.volume;this.settings.volume=0;try{await this.playMorseString(".")}catch(e){console.error("初期化トーンエラー:",e)}finally{this.settings.volume=t}}updateSettings(t){this.settings={...this.settings,...t}}scheduleTone(t,e){if(this.ensureAudioContext(),!!this.audioContext)try{const i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.connect(s),s.connect(this.audioContext.destination),i.frequency.value=this.settings.frequency,i.type="sine";const n=this.audioContext.currentTime,o=Math.max(n,t);s.gain.setValueAtTime(0,o),s.gain.linearRampToValueAtTime(this.settings.volume,o+.001),s.gain.setValueAtTime(this.settings.volume,o+(e-1)/1e3),s.gain.linearRampToValueAtTime(0,o+e/1e3),i.start(o),i.stop(o+e/1e3)}catch(i){console.error("音声エラー:",i)}}startContinuousTone(){if(this.ensureAudioContext(),!!this.audioContext)try{this.stopContinuousTone();const t=this.audioContext.createOscillator(),e=this.audioContext.createGain();t.connect(e),e.connect(this.audioContext.destination),t.frequency.value=this.settings.frequency,t.type="sine";const i=this.audioContext.currentTime;e.gain.setValueAtTime(0,i),e.gain.linearRampToValueAtTime(this.settings.volume,i+.001),t.start(i),this.currentOscillator=t,this.currentGain=e}catch(t){console.error("連続音開始エラー:",t)}}stopContinuousTone(){if(this.audioContext)try{if(this.currentOscillator&&this.currentGain){const t=this.audioContext.currentTime;this.currentGain.gain.cancelScheduledValues(t),this.currentGain.gain.setValueAtTime(this.currentGain.gain.value,t),this.currentGain.gain.linearRampToValueAtTime(0,t+.001),this.currentOscillator.stop(t+.002),this.currentOscillator=null,this.currentGain=null}}catch(t){console.error("連続音停止エラー:",t)}}async playMorseString(t){if(this.isPlaying||!t||(this.ensureAudioContext(),!this.audioContext))return!1;this.isPlaying=!0;const i=1200/(this.settings.wpm||20),s=i,n=3*i,o=i,c=3*i,u=7*i;let r=this.audioContext.currentTime+.02;for(let m=0;m<t.length&&this.isPlaying;m++){const p=t[m];p==="."?(this.scheduleTone(r,s),r+=(s+o)/1e3):p==="-"?(this.scheduleTone(r,n),r+=(n+o)/1e3):p===" "?r+=(c-o)/1e3:p==="/"&&(r+=(u-o)/1e3)}const f=(r-this.audioContext.currentTime)*1e3;await new Promise(m=>setTimeout(m,f));const g=this.isPlaying;return this.isPlaying=!1,g}stopPlaying(){this.isPlaying=!1}getAudioContext(){return this.audioContext}getVolume(){return this.settings.volume}setVolume(t){this.settings.volume=Math.max(0,Math.min(1,t))}getFrequency(){return this.settings.frequency}setFrequency(t){this.settings.frequency=Math.max(400,Math.min(1200,t))}getWPM(){return this.settings.wpm||20}setWPM(t){this.settings.wpm=Math.max(5,Math.min(40,t))}saveSettings(){try{localStorage.setItem("v4.audio.settings",JSON.stringify(this.settings))}catch(t){console.error("設定保存エラー:",t)}}loadSettings(){try{const t=localStorage.getItem("v4.audio.settings");t&&(this.settings={...this.settings,...JSON.parse(t)})}catch(t){console.error("設定読み込みエラー:",t)}}}const l={A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----."," ":"/",".":".-.-.-",",":"--..--",":":"---...","?":"..--..",_:"..--.-","+":".-.-.","-":"-....-","×":"-..-","^":"......","/":"-..-.","@":".--.-.","(":"-.--.",")":"-.--.-",'"':".-..-.","'":".----.","=":"-...-"},y=Object.fromEntries(Object.entries(l).map(([d,t])=>[t,d]));class w{static textToMorse(t){const e=t.toUpperCase(),i=/\[([A-Z]+)\]/g,s=[];let n=0,o;for(;(o=i.exec(e))!==null;){if(o.index>n){const r=e.substring(n,o.index),f=Array.from(r).map(g=>l[g]||g);s.push(f.join(" "))}const u=Array.from(o[1]).map(r=>l[r]||r);s.push(u.join("")),n=i.lastIndex}if(n<e.length){const c=e.substring(n),u=Array.from(c).map(r=>l[r]||r);s.push(u.join(" "))}return s.filter(c=>c).join(" ")}static morseSequencesToText(t){let e="";for(const i of t)i==="/"?e+=" ":i&&i!==""&&(e+=y[i]||"?");return e}static getMorseMap(){return l}static charToMorse(t){return l[t.toUpperCase()]}}const h=class h{static get(t){return this.settings[t]}static set(t,e){this.settings[t]=e,this.save()}static load(){try{const t=localStorage.getItem("v4.settings");t&&(this.settings={...this.defaultSettings,...JSON.parse(t)})}catch(t){console.error("Failed to load settings:",t)}}static save(){try{localStorage.setItem("v4.settings",JSON.stringify(this.settings))}catch(t){console.error("Failed to save settings:",t)}}static getAll(){return{...this.settings}}};h.defaultSettings={volume:.7,frequency:750,wpm:20,iambicMode:"B",paddleLayout:"normal"},h.settings={...h.defaultSettings};let a=h;class T{constructor(){this.keyDown=!1,this.keyDownTime=0,this.buffer="",this.sequence="",this.charTimer=null,this.wordTimer=null,a.load();const t=a.getAll();this.audioSystem=new v({frequency:t.frequency,volume:t.volume,wpm:t.wpm}),this.render(),this.setupEventListeners(),this.setupSettingsModal()}getTimings(){const t=1200/a.get("wpm");return{dot:t,dash:t*3,charGap:t*4,wordGap:t*7}}clearTimers(){this.charTimer!==null&&(clearTimeout(this.charTimer),this.charTimer=null),this.wordTimer!==null&&(clearTimeout(this.wordTimer),this.wordTimer=null)}setTimers(){this.clearTimers();const t=this.getTimings();this.charTimer=window.setTimeout(()=>{this.sequence&&(this.buffer+=this.sequence+" ",this.sequence="",this.updateDisplay())},t.charGap),this.wordTimer=window.setTimeout(()=>{this.sequence&&(this.buffer+=this.sequence+" ",this.sequence=""),this.buffer.endsWith("/ ")||(this.buffer+="/ "),this.updateDisplay()},t.wordGap)}onKeyDown(){if(this.keyDown)return;this.keyDown=!0,this.keyDownTime=Date.now(),this.clearTimers(),this.audioSystem.startContinuousTone();const t=document.getElementById("morseKey");t&&t.classList.add("pressed")}onKeyUp(){if(!this.keyDown)return;this.keyDown=!1;const t=Date.now()-this.keyDownTime;this.audioSystem.stopContinuousTone();const e=this.getTimings(),i=t<e.dash?".":"-";this.sequence+=i,this.updateDisplay(),this.setTimers();const s=document.getElementById("morseKey");s&&s.classList.remove("pressed")}updateDisplay(){let t="";this.buffer&&(t=this.buffer.trim()),this.sequence&&(t&&(t+=" "),t+=`[${this.sequence}]`);const e=document.getElementById("morseDisplay");e&&(e.textContent=t||"入力されたモールス信号"),this.updateDecoded()}updateDecoded(){const t=this.buffer.trim().split(/\s+/),e=w.morseSequencesToText(t),i=document.getElementById("decodedOutput");i&&(i.textContent=e||"解読された文字")}clear(){this.buffer="",this.sequence="",this.clearTimers(),this.updateDisplay()}setupEventListeners(){const t=document.getElementById("morseKey");t&&(t.addEventListener("mousedown",()=>this.onKeyDown()),t.addEventListener("mouseup",()=>this.onKeyUp()),t.addEventListener("mouseleave",()=>{this.keyDown&&this.onKeyUp()}),t.addEventListener("touchstart",s=>{s.preventDefault(),this.onKeyDown()}),t.addEventListener("touchend",s=>{s.preventDefault(),this.onKeyUp()}));const e=document.getElementById("clearBtn");e&&e.addEventListener("click",()=>this.clear());const i=document.getElementById("backBtn");i&&i.addEventListener("click",()=>{window.location.href="./index.html"}),document.addEventListener("keydown",s=>{s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA"||s.repeat||s.code==="Space"&&(s.preventDefault(),this.onKeyDown())}),document.addEventListener("keyup",s=>{s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA"||s.code==="Space"&&(s.preventDefault(),this.onKeyUp())})}setupSettingsModal(){const t=document.getElementById("settingsIcon"),e=document.getElementById("settingsModal"),i=document.getElementById("settingsCancel"),s=document.getElementById("settingsOK");t&&e&&t.addEventListener("click",()=>{this.openSettingsModal()}),i&&e&&i.addEventListener("click",()=>{e.classList.remove("active")}),s&&e&&s.addEventListener("click",()=>{this.applySettings(),e.classList.remove("active")}),e&&e.addEventListener("click",n=>{n.target===e&&e.classList.remove("active")})}openSettingsModal(){const t=a.getAll(),e=document.getElementById("volumeRange"),i=document.getElementById("volumeInput"),s=document.getElementById("frequencyInput"),n=document.getElementById("wpmInput");e&&(e.value=String(t.volume*100)),i&&(i.value=String(Math.round(t.volume*100))),s&&(s.value=String(t.frequency)),n&&(n.value=String(t.wpm));const o=document.getElementById("settingsModal");o&&o.classList.add("active"),e&&i&&(e.oninput=c=>{const u=c.target.value;i.value=u},i.oninput=c=>{const u=c.target.value;e.value=u})}applySettings(){const t=document.getElementById("volumeInput"),e=document.getElementById("frequencyInput"),i=document.getElementById("wpmInput");t&&a.set("volume",parseInt(t.value)/100),e&&a.set("frequency",parseInt(e.value)),i&&a.set("wpm",parseInt(i.value));const s=a.getAll();this.audioSystem.updateSettings({volume:s.volume,frequency:s.frequency,wpm:s.wpm})}render(){const t=document.getElementById("app");if(!t)return;const e=a.getAll();t.innerHTML=`
      <div class="settings-icon" id="settingsIcon">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
      </div>

      <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
          <div class="settings-header">
            <h2>設定</h2>
          </div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>音量</label>
              <div class="setting-row">
                <input type="range" id="volumeRange" min="0" max="100" value="${e.volume*100}">
                <input type="number" id="volumeInput" min="0" max="100" value="${Math.round(e.volume*100)}">
                <span>%</span>
              </div>
            </div>
            <div class="setting-item">
              <label>周波数 (Hz)</label>
              <div class="setting-row">
                <input type="number" id="frequencyInput" min="100" max="2000" value="${e.frequency}" step="50">
              </div>
            </div>
            <div class="setting-item">
              <label>WPM (速度)</label>
              <div class="setting-row">
                <input type="number" id="wpmInput" min="1" max="999" value="${e.wpm}">
              </div>
            </div>
          </div>
          <div class="settings-buttons">
            <button id="settingsCancel" class="btn btn-secondary">キャンセル</button>
            <button id="settingsOK" class="btn">OK</button>
          </div>
        </div>
      </div>

      <div class="container">
        <header class="header">
          <button id="backBtn" class="back-btn">← 戻る</button>
          <h1>縦振り電鍵練習</h1>
        </header>

        <div class="key-container">
          <div id="morseKey" class="morse-key">
            <div class="key-label">押す</div>
          </div>
        </div>

        <div class="output-container">
          <div class="output-section">
            <h2>モールス信号</h2>
            <div id="morseDisplay" class="output-display">入力されたモールス信号</div>
          </div>

          <div class="output-section">
            <h2>解読された文字</h2>
            <div id="decodedOutput" class="output-display">解読された文字</div>
          </div>
        </div>

        <div class="controls">
          <button id="clearBtn" class="btn">クリア</button>
        </div>

        <div class="instructions">
          <h3>使い方</h3>
          <ul>
            <li>電鍵ボタンをクリック/タッチ、またはスペースキーを押して信号を送信</li>
            <li>短く押すと「・」（短点）、長く押すと「−」（長点）</li>
            <li>文字間は自動的に判定されます</li>
            <li>画面右上の設定アイコンから音量・周波数・速度を調整できます</li>
          </ul>
        </div>
      </div>
    `}}document.addEventListener("DOMContentLoaded",()=>{new T});</script>
  <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}.container{max-width:800px;margin:0 auto}.header{display:flex;align-items:center;gap:20px;margin-bottom:30px;color:#fff}.back-btn{background:#fff3;border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:1rem;transition:background .3s}.back-btn:hover{background:#ffffff4d}.header h1{font-size:2rem}.key-container{display:flex;justify-content:center;margin-bottom:40px}.morse-key{width:200px;height:200px;background:linear-gradient(145deg,#fff,#e6e6e6);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-user-select:none;user-select:none;box-shadow:0 10px 30px #0000004d;transition:transform .1s,box-shadow .1s;touch-action:none}.morse-key:active,.morse-key.pressed{transform:scale(.95);box-shadow:0 5px 15px #0000004d;background:linear-gradient(145deg,#e6e6e6,#ccc)}.key-label{font-size:1.5rem;font-weight:700;color:#667eea}.output-container{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px}.output-section{margin-bottom:20px}.output-section:last-child{margin-bottom:0}.output-section h2{font-size:1.2rem;color:#667eea;margin-bottom:10px}.output-display{background:#f5f5f5;border-radius:8px;padding:15px;min-height:60px;font-family:Courier New,monospace;font-size:1.1rem;color:#333;word-wrap:break-word}.controls{display:flex;justify-content:center;gap:10px;margin-bottom:30px}.btn{background:#fff;border:none;color:#667eea;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;transition:background .3s,transform .1s}.btn:hover{background:#f0f0f0}.btn:active{transform:scale(.98)}.instructions{background:#ffffff1a;border-radius:12px;padding:20px;color:#fff}.instructions h3{margin-bottom:15px;font-size:1.2rem}.instructions ul{list-style:none;padding:0}.instructions li{margin-bottom:10px;padding-left:20px;position:relative}.instructions li:before{content:"•";position:absolute;left:0}.settings-icon{position:fixed;top:20px;right:20px;width:50px;height:50px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 15px #0003;z-index:100;transition:all .3s ease}.settings-icon:hover{transform:rotate(90deg) scale(1.1)}.settings-icon svg{width:28px;height:28px;fill:#667eea}.settings-modal{display:none;position:fixed;inset:0;background:#00000080;z-index:200;align-items:center;justify-content:center;padding:20px}.settings-modal.active{display:flex}.settings-content{background:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px #0000004d}.settings-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e0e0e0}.settings-header h2{font-size:1.5rem;color:#333}.settings-grid{display:grid;gap:20px}.setting-item{display:flex;flex-direction:column;gap:10px}.setting-item label{font-weight:600;color:#555;font-size:1rem}.setting-row{display:flex;align-items:center;gap:10px}.setting-row input[type=range]{flex:1}.setting-row input[type=number]{width:80px;padding:8px;border:2px solid #ddd;border-radius:6px;font-size:1rem;text-align:center}.setting-row input[type=number]:focus{outline:none;border-color:#667eea}.settings-buttons{display:flex;justify-content:center;gap:15px;margin-top:25px}.btn-secondary{background:linear-gradient(135deg,#888,#666);color:#fff}@media (max-width: 768px){.header h1{font-size:1.5rem}.morse-key{width:150px;height:150px}.key-label{font-size:1.2rem}}</style>
</head>
<body>
  <div id="app"></div>
</body>
</html>
