<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>横振り電鍵練習 - モールス練習アプリ v4</title>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class f{constructor(t={frequency:750,volume:.7,wpm:20}){this.audioContext=null,this.currentOscillator=null,this.currentGain=null,this.isPlaying=!1,this.settings=t,this.init()}ensureAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioContext.state==="suspended"&&this.audioContext.resume()}init(){const t=()=>{this.ensureAudioContext()};document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0})}updateSettings(t){this.settings={...this.settings,...t}}scheduleTone(t,e){if(this.ensureAudioContext(),!!this.audioContext)try{const s=this.audioContext.createOscillator(),i=this.audioContext.createGain();s.connect(i),i.connect(this.audioContext.destination),s.frequency.value=this.settings.frequency,s.type="sine";const n=this.audioContext.currentTime,o=Math.max(n,t);i.gain.setValueAtTime(0,o),i.gain.linearRampToValueAtTime(this.settings.volume,o+.001),i.gain.setValueAtTime(this.settings.volume,o+(e-1)/1e3),i.gain.linearRampToValueAtTime(0,o+e/1e3),s.start(o),s.stop(o+e/1e3)}catch(s){console.error("音声エラー:",s)}}startContinuousTone(){if(this.ensureAudioContext(),!!this.audioContext)try{this.stopContinuousTone();const t=this.audioContext.createOscillator(),e=this.audioContext.createGain();t.connect(e),e.connect(this.audioContext.destination),t.frequency.value=this.settings.frequency,t.type="sine";const s=this.audioContext.currentTime;e.gain.setValueAtTime(0,s),e.gain.linearRampToValueAtTime(this.settings.volume,s+.001),t.start(s),this.currentOscillator=t,this.currentGain=e}catch(t){console.error("連続音開始エラー:",t)}}stopContinuousTone(){if(this.audioContext)try{if(this.currentOscillator&&this.currentGain){const t=this.audioContext.currentTime;this.currentGain.gain.cancelScheduledValues(t),this.currentGain.gain.setValueAtTime(this.currentGain.gain.value,t),this.currentGain.gain.linearRampToValueAtTime(0,t+.001),this.currentOscillator.stop(t+.002),this.currentOscillator=null,this.currentGain=null}}catch(t){console.error("連続音停止エラー:",t)}}async playMorseString(t){if(this.isPlaying||!t||(this.ensureAudioContext(),!this.audioContext))return!1;this.isPlaying=!0;const s=1200/(this.settings.wpm||20),i=s,n=3*s,o=s,l=3*s,u=7*s;let r=this.audioContext.currentTime+.02;for(let d=0;d<t.length&&this.isPlaying;d++){const m=t[d];m==="."?(this.scheduleTone(r,i),r+=(i+o)/1e3):m==="-"?(this.scheduleTone(r,n),r+=(n+o)/1e3):m===" "?r+=(l-o)/1e3:m==="/"&&(r+=(u-o)/1e3)}const p=(r-this.audioContext.currentTime)*1e3;await new Promise(d=>setTimeout(d,p));const v=this.isPlaying;return this.isPlaying=!1,v}stopPlaying(){this.isPlaying=!1}getAudioContext(){return this.audioContext}}const g={A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----."," ":"/",".":".-.-.-",",":"--..--",":":"---...","?":"..--..",_:"..--.-","+":".-.-.","-":"-....-","×":"-..-","^":"......","/":"-..-.","@":".--.-.","(":"-.--.",")":"-.--.-",'"':".-..-.","'":".----.","=":"-...-"},y=Object.fromEntries(Object.entries(g).map(([c,t])=>[t,c]));class T{static textToMorse(t){const e=t.toUpperCase();return Array.from(e).map(s=>g[s]||s).join(" ")}static morseSequencesToText(t){let e="";for(const s of t)s==="/"?e+=" ":s&&s!==""&&(e+=y[s]||"?");return e}static getMorseMap(){return g}static charToMorse(t){return g[t.toUpperCase()]}}const h=class h{static get(t){return this.settings[t]}static set(t,e){this.settings[t]=e,this.save()}static load(){try{const t=localStorage.getItem("v4.settings");t&&(this.settings={...this.defaultSettings,...JSON.parse(t)})}catch(t){console.error("Failed to load settings:",t)}}static save(){try{localStorage.setItem("v4.settings",JSON.stringify(this.settings))}catch(t){console.error("Failed to save settings:",t)}}static getAll(){return{...this.settings}}};h.defaultSettings={volume:.7,frequency:750,wpm:20},h.settings={...h.defaultSettings};let a=h;class w{constructor(){this.buffer="",this.sequence="",this.charTimer=null,this.wordTimer=null,a.load();const t=a.getAll();this.audioSystem=new f({frequency:t.frequency,volume:t.volume,wpm:t.wpm}),this.render(),this.setupEventListeners(),this.setupSettingsModal()}getTimings(){const t=1200/a.get("wpm");return{dot:t,dash:t*3,charGap:t*4,wordGap:t*7}}clearTimers(){this.charTimer!==null&&(clearTimeout(this.charTimer),this.charTimer=null),this.wordTimer!==null&&(clearTimeout(this.wordTimer),this.wordTimer=null)}setTimers(){this.clearTimers();const t=this.getTimings();this.charTimer=window.setTimeout(()=>{this.sequence&&(this.buffer+=this.sequence+" ",this.sequence="",this.updateDisplay())},t.charGap),this.wordTimer=window.setTimeout(()=>{this.sequence&&(this.buffer+=this.sequence+" ",this.sequence=""),this.buffer.endsWith("/ ")||(this.buffer+="/ "),this.updateDisplay()},t.wordGap)}async sendDot(){this.clearTimers(),this.sequence+=".",this.updateDisplay(),this.getTimings(),await this.audioSystem.playMorseString("."),this.setTimers()}async sendDash(){this.clearTimers(),this.sequence+="-",this.updateDisplay(),this.getTimings(),await this.audioSystem.playMorseString("-"),this.setTimers()}updateDisplay(){let t="";this.buffer&&(t=this.buffer.trim()),this.sequence&&(t&&(t+=" "),t+=`[${this.sequence}]`);const e=document.getElementById("morseDisplay");e&&(e.textContent=t||"入力されたモールス信号"),this.updateDecoded()}updateDecoded(){const t=this.buffer.trim().split(/\s+/),e=T.morseSequencesToText(t),s=document.getElementById("decodedOutput");s&&(s.textContent=e||"解読された文字")}clear(){this.buffer="",this.sequence="",this.clearTimers(),this.updateDisplay()}setupEventListeners(){const t=document.getElementById("leftPaddle");t&&(t.addEventListener("click",()=>this.sendDot()),t.addEventListener("touchstart",n=>{n.preventDefault(),this.sendDot()}));const e=document.getElementById("rightPaddle");e&&(e.addEventListener("click",()=>this.sendDash()),e.addEventListener("touchstart",n=>{n.preventDefault(),this.sendDash()}));const s=document.getElementById("clearBtn");s&&s.addEventListener("click",()=>this.clear());const i=document.getElementById("backBtn");i&&i.addEventListener("click",()=>{window.location.href="./index.html"}),document.addEventListener("keydown",n=>{n.target.tagName==="INPUT"||n.target.tagName==="TEXTAREA"||(n.key==="ArrowLeft"||n.key==="z"||n.key==="Z"?(n.preventDefault(),this.sendDot()):(n.key==="ArrowRight"||n.key==="x"||n.key==="X")&&(n.preventDefault(),this.sendDash()))})}setupSettingsModal(){const t=document.getElementById("settingsIcon"),e=document.getElementById("settingsModal"),s=document.getElementById("settingsCancel"),i=document.getElementById("settingsOK");t&&e&&t.addEventListener("click",()=>{this.openSettingsModal()}),s&&e&&s.addEventListener("click",()=>{e.classList.remove("active")}),i&&e&&i.addEventListener("click",()=>{this.applySettings(),e.classList.remove("active")}),e&&e.addEventListener("click",n=>{n.target===e&&e.classList.remove("active")})}openSettingsModal(){const t=a.getAll(),e=document.getElementById("volumeRange"),s=document.getElementById("volumeInput"),i=document.getElementById("frequencyInput"),n=document.getElementById("wpmInput");e&&(e.value=String(t.volume*100)),s&&(s.value=String(Math.round(t.volume*100))),i&&(i.value=String(t.frequency)),n&&(n.value=String(t.wpm));const o=document.getElementById("settingsModal");o&&o.classList.add("active"),e&&s&&(e.oninput=l=>{const u=l.target.value;s.value=u},s.oninput=l=>{const u=l.target.value;e.value=u})}applySettings(){const t=document.getElementById("volumeInput"),e=document.getElementById("frequencyInput"),s=document.getElementById("wpmInput");t&&a.set("volume",parseInt(t.value)/100),e&&a.set("frequency",parseInt(e.value)),s&&a.set("wpm",parseInt(s.value));const i=a.getAll();this.audioSystem.updateSettings({volume:i.volume,frequency:i.frequency,wpm:i.wpm})}render(){const t=document.getElementById("app");if(!t)return;const e=a.getAll();t.innerHTML=`
      <div class="settings-icon" id="settingsIcon">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
      </div>

      <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
          <div class="settings-header">
            <h2>設定</h2>
          </div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>音量</label>
              <div class="setting-row">
                <input type="range" id="volumeRange" min="0" max="100" value="${e.volume*100}">
                <input type="number" id="volumeInput" min="0" max="100" value="${Math.round(e.volume*100)}">
                <span>%</span>
              </div>
            </div>
            <div class="setting-item">
              <label>周波数 (Hz)</label>
              <div class="setting-row">
                <input type="number" id="frequencyInput" min="100" max="2000" value="${e.frequency}" step="50">
              </div>
            </div>
            <div class="setting-item">
              <label>WPM (速度)</label>
              <div class="setting-row">
                <input type="number" id="wpmInput" min="1" max="999" value="${e.wpm}">
              </div>
            </div>
          </div>
          <div class="settings-buttons">
            <button id="settingsCancel" class="btn btn-secondary">キャンセル</button>
            <button id="settingsOK" class="btn">OK</button>
          </div>
        </div>
      </div>

      <div class="container">
        <header class="header">
          <button id="backBtn" class="back-btn">← 戻る</button>
          <h1>横振り電鍵練習</h1>
        </header>

        <div class="paddle-container">
          <div id="leftPaddle" class="paddle left">
            <div class="paddle-label">左<br>（短点）</div>
          </div>
          <div class="paddle-divider"></div>
          <div id="rightPaddle" class="paddle right">
            <div class="paddle-label">右<br>（長点）</div>
          </div>
        </div>

        <div class="output-container">
          <div class="output-section">
            <h2>モールス信号</h2>
            <div id="morseDisplay" class="output-display">入力されたモールス信号</div>
          </div>

          <div class="output-section">
            <h2>解読された文字</h2>
            <div id="decodedOutput" class="output-display">解読された文字</div>
          </div>
        </div>

        <div class="controls">
          <button id="clearBtn" class="btn">クリア</button>
        </div>

        <div class="instructions">
          <h3>使い方</h3>
          <ul>
            <li>左パドル（または←キー、Zキー）: 短点「・」</li>
            <li>右パドル（または→キー、Xキー）: 長点「−」</li>
            <li>自動的にタイミング調整されます</li>
            <li>画面右上の設定アイコンから音量・周波数・速度を調整できます</li>
          </ul>
        </div>
      </div>
    `}}document.addEventListener("DOMContentLoaded",()=>{new w});</script>
  <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}.container{max-width:800px;margin:0 auto}.header{display:flex;align-items:center;gap:20px;margin-bottom:30px;color:#fff}.back-btn{background:#fff3;border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:1rem;transition:background .3s}.back-btn:hover{background:#ffffff4d}.header h1{font-size:2rem}.paddle-container{display:flex;justify-content:center;align-items:center;margin-bottom:40px;gap:10px}.paddle{width:150px;height:200px;background:linear-gradient(145deg,#fff,#e6e6e6);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-user-select:none;user-select:none;box-shadow:0 10px 30px #0000004d;transition:transform .1s,box-shadow .1s;touch-action:none}.paddle.left{border-top-right-radius:4px;border-bottom-right-radius:4px}.paddle.right{border-top-left-radius:4px;border-bottom-left-radius:4px}.paddle:active{transform:scale(.95);box-shadow:0 5px 15px #0000004d;background:linear-gradient(145deg,#e6e6e6,#ccc)}.paddle-label{font-size:1.2rem;font-weight:700;color:#667eea;text-align:center}.paddle-divider{width:4px;height:180px;background:#ffffff4d;border-radius:2px}.output-container{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px}.output-section{margin-bottom:20px}.output-section:last-child{margin-bottom:0}.output-section h2{font-size:1.2rem;color:#667eea;margin-bottom:10px}.output-display{background:#f5f5f5;border-radius:8px;padding:15px;min-height:60px;font-family:Courier New,monospace;font-size:1.1rem;color:#333;word-wrap:break-word}.controls{display:flex;justify-content:center;gap:10px;margin-bottom:30px}.btn{background:#fff;border:none;color:#667eea;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;transition:background .3s,transform .1s}.btn:hover{background:#f0f0f0}.btn:active{transform:scale(.98)}.instructions{background:#ffffff1a;border-radius:12px;padding:20px;color:#fff}.instructions h3{margin-bottom:15px;font-size:1.2rem}.instructions ul{list-style:none;padding:0}.instructions li{margin-bottom:10px;padding-left:20px;position:relative}.instructions li:before{content:"•";position:absolute;left:0}@media (max-width: 768px){.header h1{font-size:1.5rem}.paddle{width:120px;height:160px}.paddle-label{font-size:1rem}.paddle-divider{height:140px}}z-index: 100; transition: all .3s ease; } .settings-icon:hover{transform:rotate(90deg) scale(1.1)}.settings-icon svg{width:28px;height:28px;fill:#667eea}.settings-modal{display:none;position:fixed;inset:0;background:#00000080;z-index:200;align-items:center;justify-content:center;padding:20px}.settings-modal.active{display:flex}.settings-content{background:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px #0000004d}.settings-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e0e0e0}.settings-header h2{font-size:1.5rem;color:#333}.settings-grid{display:grid;gap:20px}.setting-item{display:flex;flex-direction:column;gap:10px}.setting-item label{font-weight:600;color:#555;font-size:1rem}.setting-row{display:flex;align-items:center;gap:10px}.setting-row input[type=range]{flex:1}.setting-row input[type=number]{width:80px;padding:8px;border:2px solid #ddd;border-radius:6px;font-size:1rem;text-align:center}.setting-row input[type=number]:focus{outline:none;border-color:#667eea}.settings-buttons{display:flex;justify-content:center;gap:15px;margin-top:25px}.btn-secondary{background:linear-gradient(135deg,#888,#666);color:#fff}@media (max-width: 768px){.header h1{font-size:1.5rem}.morse-key{width:150px;height:150px}.key-label{font-size:1.2rem}}</style>
</head>
<body>
  <div id="app"></div>
</body>
</html>
