<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>縦振り電鍵練習 - モールス練習アプリ v4</title>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();class p{constructor(e={frequency:750,volume:.7,wpm:20}){this.audioContext=null,this.currentOscillator=null,this.currentGain=null,this.isPlaying=!1,this.settings=e,this.init()}ensureAudioContext(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioContext.state==="suspended"&&this.audioContext.resume()}init(){const e=()=>{this.ensureAudioContext()};document.addEventListener("click",e,{once:!0}),document.addEventListener("keydown",e,{once:!0}),document.addEventListener("touchstart",e,{once:!0})}updateSettings(e){this.settings={...this.settings,...e}}scheduleTone(e,s){if(this.ensureAudioContext(),!!this.audioContext)try{const i=this.audioContext.createOscillator(),t=this.audioContext.createGain();i.connect(t),t.connect(this.audioContext.destination),i.frequency.value=this.settings.frequency,i.type="sine";const n=this.audioContext.currentTime,o=Math.max(n,e);t.gain.setValueAtTime(0,o),t.gain.linearRampToValueAtTime(this.settings.volume,o+.001),t.gain.setValueAtTime(this.settings.volume,o+(s-1)/1e3),t.gain.linearRampToValueAtTime(0,o+s/1e3),i.start(o),i.stop(o+s/1e3)}catch(i){console.error("音声エラー:",i)}}startContinuousTone(){if(this.ensureAudioContext(),!!this.audioContext)try{this.stopContinuousTone();const e=this.audioContext.createOscillator(),s=this.audioContext.createGain();e.connect(s),s.connect(this.audioContext.destination),e.frequency.value=this.settings.frequency,e.type="sine";const i=this.audioContext.currentTime;s.gain.setValueAtTime(0,i),s.gain.linearRampToValueAtTime(this.settings.volume,i+.001),e.start(i),this.currentOscillator=e,this.currentGain=s}catch(e){console.error("連続音開始エラー:",e)}}stopContinuousTone(){if(this.audioContext)try{if(this.currentOscillator&&this.currentGain){const e=this.audioContext.currentTime;this.currentGain.gain.cancelScheduledValues(e),this.currentGain.gain.setValueAtTime(this.currentGain.gain.value,e),this.currentGain.gain.linearRampToValueAtTime(0,e+.001),this.currentOscillator.stop(e+.002),this.currentOscillator=null,this.currentGain=null}}catch(e){console.error("連続音停止エラー:",e)}}async playMorseString(e){if(this.isPlaying||!e||(this.ensureAudioContext(),!this.audioContext))return!1;this.isPlaying=!0;const i=1200/(this.settings.wpm||20),t=i,n=3*i,o=i,l=3*i,h=7*i;let r=this.audioContext.currentTime+.02;for(let u=0;u<e.length&&this.isPlaying;u++){const c=e[u];c==="."?(this.scheduleTone(r,t),r+=(t+o)/1e3):c==="-"?(this.scheduleTone(r,n),r+=(n+o)/1e3):c===" "?r+=(l-o)/1e3:c==="/"&&(r+=(h-o)/1e3)}const m=(r-this.audioContext.currentTime)*1e3;await new Promise(u=>setTimeout(u,m));const f=this.isPlaying;return this.isPlaying=!1,f}stopPlaying(){this.isPlaying=!1}getAudioContext(){return this.audioContext}}const d={A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----."," ":"/",".":".-.-.-",",":"--..--",":":"---...","?":"..--..",_:"..--.-","+":".-.-.","-":"-....-","×":"-..-","^":"......","/":"-..-.","@":".--.-.","(":"-.--.",")":"-.--.-",'"':".-..-.","'":".----.","=":"-...-"},y=Object.fromEntries(Object.entries(d).map(([a,e])=>[e,a]));class g{static textToMorse(e){const s=e.toUpperCase();return Array.from(s).map(i=>d[i]||i).join(" ")}static morseSequencesToText(e){let s="";for(const i of e)i==="/"?s+=" ":i&&i!==""&&(s+=y[i]||"?");return s}static getMorseMap(){return d}static charToMorse(e){return d[e.toUpperCase()]}}class T{constructor(){this.keyDown=!1,this.keyDownTime=0,this.buffer="",this.sequence="",this.charTimer=null,this.wordTimer=null,this.wpm=20,this.audioSystem=new p({frequency:750,volume:.7,wpm:this.wpm}),this.render(),this.setupEventListeners()}getTimings(){const e=1200/this.wpm;return{dot:e,dash:e*3,charGap:e*4,wordGap:e*7}}clearTimers(){this.charTimer!==null&&(clearTimeout(this.charTimer),this.charTimer=null),this.wordTimer!==null&&(clearTimeout(this.wordTimer),this.wordTimer=null)}setTimers(){this.clearTimers();const e=this.getTimings();this.charTimer=window.setTimeout(()=>{this.sequence&&(this.buffer+=this.sequence+" ",this.sequence="",this.updateDisplay())},e.charGap),this.wordTimer=window.setTimeout(()=>{this.sequence&&(this.buffer+=this.sequence+" ",this.sequence=""),this.buffer.endsWith("/ ")||(this.buffer+="/ "),this.updateDisplay()},e.wordGap)}onKeyDown(){if(this.keyDown)return;this.keyDown=!0,this.keyDownTime=Date.now(),this.clearTimers(),this.audioSystem.startContinuousTone();const e=document.getElementById("morseKey");e&&e.classList.add("pressed")}onKeyUp(){if(!this.keyDown)return;this.keyDown=!1;const e=Date.now()-this.keyDownTime;this.audioSystem.stopContinuousTone();const s=this.getTimings(),i=e<s.dash?".":"-";this.sequence+=i,this.updateDisplay(),this.setTimers();const t=document.getElementById("morseKey");t&&t.classList.remove("pressed")}updateDisplay(){let e="";this.buffer&&(e=this.buffer.trim()),this.sequence&&(e&&(e+=" "),e+=`[${this.sequence}]`);const s=document.getElementById("morseDisplay");s&&(s.textContent=e||"入力されたモールス信号"),this.updateDecoded()}updateDecoded(){const e=this.buffer.trim().split(/\s+/),s=g.morseSequencesToText(e),i=document.getElementById("decodedOutput");i&&(i.textContent=s||"解読された文字")}clear(){this.buffer="",this.sequence="",this.clearTimers(),this.updateDisplay()}setupEventListeners(){const e=document.getElementById("morseKey");e&&(e.addEventListener("mousedown",()=>this.onKeyDown()),e.addEventListener("mouseup",()=>this.onKeyUp()),e.addEventListener("mouseleave",()=>{this.keyDown&&this.onKeyUp()}),e.addEventListener("touchstart",t=>{t.preventDefault(),this.onKeyDown()}),e.addEventListener("touchend",t=>{t.preventDefault(),this.onKeyUp()}));const s=document.getElementById("clearBtn");s&&s.addEventListener("click",()=>this.clear());const i=document.getElementById("backBtn");i&&i.addEventListener("click",()=>{window.location.href="./index.html"}),document.addEventListener("keydown",t=>{t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"||t.repeat||t.code==="Space"&&(t.preventDefault(),this.onKeyDown())}),document.addEventListener("keyup",t=>{t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"||t.code==="Space"&&(t.preventDefault(),this.onKeyUp())})}render(){const e=document.getElementById("app");e&&(e.innerHTML=`
      <div class="container">
        <header class="header">
          <button id="backBtn" class="back-btn">← 戻る</button>
          <h1>縦振り電鍵練習</h1>
        </header>

        <div class="key-container">
          <div id="morseKey" class="morse-key">
            <div class="key-label">押す</div>
          </div>
        </div>

        <div class="output-container">
          <div class="output-section">
            <h2>モールス信号</h2>
            <div id="morseDisplay" class="output-display">入力されたモールス信号</div>
          </div>

          <div class="output-section">
            <h2>解読された文字</h2>
            <div id="decodedOutput" class="output-display">解読された文字</div>
          </div>
        </div>

        <div class="controls">
          <button id="clearBtn" class="btn">クリア</button>
        </div>

        <div class="instructions">
          <h3>使い方</h3>
          <ul>
            <li>電鍵ボタンをクリック/タッチ、またはスペースキーを押して信号を送信</li>
            <li>短く押すと「・」（短点）、長く押すと「−」（長点）</li>
            <li>文字間は自動的に判定されます</li>
          </ul>
        </div>
      </div>
    `)}}document.addEventListener("DOMContentLoaded",()=>{new T});</script>
  <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}.container{max-width:800px;margin:0 auto}.header{display:flex;align-items:center;gap:20px;margin-bottom:30px;color:#fff}.back-btn{background:#fff3;border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:1rem;transition:background .3s}.back-btn:hover{background:#ffffff4d}.header h1{font-size:2rem}.key-container{display:flex;justify-content:center;margin-bottom:40px}.morse-key{width:200px;height:200px;background:linear-gradient(145deg,#fff,#e6e6e6);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-user-select:none;user-select:none;box-shadow:0 10px 30px #0000004d;transition:transform .1s,box-shadow .1s;touch-action:none}.morse-key:active,.morse-key.pressed{transform:scale(.95);box-shadow:0 5px 15px #0000004d;background:linear-gradient(145deg,#e6e6e6,#ccc)}.key-label{font-size:1.5rem;font-weight:700;color:#667eea}.output-container{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px}.output-section{margin-bottom:20px}.output-section:last-child{margin-bottom:0}.output-section h2{font-size:1.2rem;color:#667eea;margin-bottom:10px}.output-display{background:#f5f5f5;border-radius:8px;padding:15px;min-height:60px;font-family:Courier New,monospace;font-size:1.1rem;color:#333;word-wrap:break-word}.controls{display:flex;justify-content:center;gap:10px;margin-bottom:30px}.btn{background:#fff;border:none;color:#667eea;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;transition:background .3s,transform .1s}.btn:hover{background:#f0f0f0}.btn:active{transform:scale(.98)}.instructions{background:#ffffff1a;border-radius:12px;padding:20px;color:#fff}.instructions h3{margin-bottom:15px;font-size:1.2rem}.instructions ul{list-style:none;padding:0}.instructions li{margin-bottom:10px;padding-left:20px;position:relative}.instructions li:before{content:"•";position:absolute;left:0}@media (max-width: 768px){.header h1{font-size:1.5rem}.morse-key{width:150px;height:150px}.key-label{font-size:1.2rem}}</style>
</head>
<body>
  <div id="app"></div>
</body>
</html>
