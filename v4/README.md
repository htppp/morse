# モールス練習アプリ v4

v2・v3の機能を統合し、コッホ法学習を追加した統合版モールス練習アプリケーション

## 🎯 特徴

- **4つの練習機能を統合**:
  - 縦振り電鍵練習（v2から移植）
  - 横振り電鍵練習（v2から移植）
  - CW略語・Q符号学習（v3から移植）
  - コッホ法トレーニング（lcwo.net移植・NEW）
- **独立したページ構成**: 各機能が独立したHTMLファイルとして動作
- **スマホ最適化**: 全機能でタッチ操作に最適化
- **オフライン動作**: 各ページが単一HTMLファイル、PWA対応予定
- **共通技術基盤**: TypeScript + Vite + Web Audio API
- **進捗管理**: 各機能で独立したLocalStorage管理

## 🏗️ サイト全体の構成

v4は複数の練習機能を統合したページとして、4つの独立した機能を提供します。

### ページ構成

```
morse/
├── index.html              # トップページ（既存・変更なし）
├── v1/index.html           # v1: 旧版（非推奨）
├── v2/index.html           # v2: 旧版（非推奨）
├── v3/index.html           # v3: 旧版（非推奨）
└── v4/                     # v4: 統合版（4機能）
    ├── index.html          # v4メニューページ（4機能へのリンク）
    ├── vertical.html       # 縦振り電鍵練習
    ├── horizontal.html     # 横振り電鍵練習
    ├── flashcard.html      # CW略語・Q符号学習（フラッシュカード）
    └── koch.html           # コッホ法トレーニング（40文字学習）
```

### v4メニューページ（v4/index.html）のイメージ

```
┌─────────────────────────────┐
│ モールス練習アプリ v4       │
│                             │
│ 練習メニューを選択          │
├─────────────────────────────┤
│ [1] 縦振り電鍵練習          │
│ 縦振り電鍵の操作を練習      │
│ (v2の機能を移植)            │
├─────────────────────────────┤
│ [2] 横振り電鍵練習          │
│ 横振り電鍵の操作を練習      │
│ (v2の機能を移植)            │
├─────────────────────────────┤
│ [3] CW略語・Q符号学習       │
│ フラッシュカード・試験      │
│ (v3の機能を移植)            │
├─────────────────────────────┤
│ [4] コッホ法トレーニング     │
│ 40文字を段階的に習得        │
│ (lcwo.net移植・NEW)         │
└─────────────────────────────┘
```

## 📋 コッホ法とは

### 学習原理

コッホ法は、1930年代にドイツの心理学者Ludwig Kochが開発したCW学習法です。

**従来の方法の問題点:**
- 遅い速度から始めると、速度を上げる際に再学習が必要
- 遅い符号のリズムに慣れてしまう

**コッホ法の解決策:**
1. **最初から実用速度**: 文字速度は20-25 WPMで開始
2. **段階的な文字追加**: 2文字から始め、90%以上の正答率で次の文字を追加
3. **Farnsworth法併用**: 文字間隔を広げて実効速度を調整

### 40文字の学習順序

lcwo.netと同じ順序で学習します：

```
K M U R E S N A P T L W I . J Z = F O Y , V G 5 / Q 9 2 H 3 8 B ? 4 7 C 1 D 6 0 X
```

**学習順序の理由:**
- 最初の文字は音的に区別しやすい（K, M, U, R, E, S, N, A）
- 使用頻度の高い文字を先に学習
- 紛らわしい文字は分散配置（BとD、5と6など）

**文字の内訳:**
- アルファベット (26文字): `K M U R E S N A P T L W I J Z F O Y V G H B C D X`
- 数字 (10文字): `5 9 2 3 8 4 7 1 6 0`
- 記号 (4文字): `. = , / ?`

### レッスン構成

| レッスン | 文字数 | 新規追加文字 | 難易度 |
|---------|-------|------------|--------|
| 1 | 2 | K M | 入門 |
| 2 | 3 | U | 入門 |
| 3 | 4 | R | 入門 |
| 4-8 | 5-9 | E S N A P | 基礎 |
| 9-16 | 10-17 | T L W I . J Z = | 中級 |
| 17-26 | 18-27 | F O Y , V G 5 / Q 9 | 応用 |
| 27-40 | 28-41 | 2 H 3 8 B ? 4 7 C 1 D 6 0 X | 完成 |

## 🚀 使用方法

### 1. 縦振り電鍵練習（vertical.html）

**基本操作:**
1. 画面上の電鍵ボタンをマウス/タップで押す
2. 押している間、モールス信号音が鳴る
3. 入力した符号が画面に表示され、文字に変換される

**練習のコツ:**
- 短点（dit）は素早く、長点（dash）は3倍の長さで
- 文字間は短点3つ分の間隔を空ける
- リズムを意識して一定の速度で送信

### 2. 横振り電鍵練習（horizontal.html）

**基本操作:**
1. 画面上の横振り電鍵を左右にドラッグ/スワイプ
2. 左: 短点（dit）、右: 長点（dash）
3. 入力した符号が画面に表示され、文字に変換される

**練習のコツ:**
- 横振り電鍵は自動的に符号間隔を作る
- 素早く左右に振ることで連続送信
- 縦振りより高速送信に適している

### 3. CW略語・Q符号学習（flashcard.html）

**学習モード:**
1. タグでフィルタリング（例: 「送受,制御」「交信,Q符号」）
2. カードをめくって略語と意味を確認
3. 覚えたカードをチェックして進捗管理

**試験モード:**
1. ランダムに出題される略語に回答
2. 正答率を記録・統計表示
3. 誤答した略語を復習

### 4. コッホ法トレーニング（koch.html）

**練習の流れ:**
1. **レッスン選択**: 現在のレベルに応じたレッスンを選択
2. **設定確認**: 速度・音響設定を調整
3. **練習開始**:
   - モールス信号を聞く
   - 聞こえた文字を入力
   - Enter で送信
4. **結果確認**: 正答率・誤答文字を確認
5. **次のアクション**:
   - 90%以上 → 次のレッスンへ
   - 90%未満 → 再挑戦

**練習モード:**

- **標準モード（レッスン1-40）**
  - 文字グループ: 5文字のランダムグループ（例: `KMUKR MKMRU UKMRK`）
  - 練習時間: 1分単位で設定可能（デフォルト1分）
  - 合格基準: 90%以上の正答率
  - 表示: 入力後に正答を表示、間違いはハイライト

- **カスタム練習モード**
  - 文字選択: 任意の文字を選択して練習
  - 時間制限なし: 自分のペースで学習
  - 復習モード: 間違えやすい文字を集中練習

## ⚙️ 設定項目（コッホ法）

以下はコッホ法トレーニング（koch.html）専用の設定項目です。

### 速度設定

#### 文字速度（Character Speed）

**定義**: 1文字あたりの送信速度（WPM: Words Per Minute）

- **範囲**: 5-40 WPM
- **推奨**: 20-25 WPM（初心者）、30-35 WPM（上級者）
- **デフォルト**: 25 WPM

**計算式:**
```
1単位時間(u) = 1200 / WPM [ms]
dit = 1u
dash = 3u
要素間ギャップ = 1u
```

#### 実効速度（Effective Speed）

**定義**: 文字間隔を含めた実際の受信速度（WPM）

- **範囲**: 5-40 WPM
- **推奨開始値**: 8-12 WPM
- **デフォルト**: 10 WPM

**Farnsworth法:**
- 文字速度 > 実効速度の場合に有効
- 文字間隔を広げて実効速度を調整
- 文字内のリズムは保持（聞き取りやすい）

**計算式:**
```
文字間ギャップ = (文字速度 - 実効速度) により自動調整
単語間ギャップ = 文字間ギャップ × 2.33
```

### 音響設定

#### 周波数（Tone Frequency）

- **範囲**: 400-1000 Hz
- **推奨**: 600-800 Hz（聞き取りやすい）
- **デフォルト**: 750 Hz

#### 音量（Volume）

- **範囲**: 0-100%
- **デフォルト**: 70%

#### 開始遅延（Start Delay）

- **範囲**: 0-10秒
- **デフォルト**: 2秒
- **用途**: 準備時間の確保

### 表示設定

#### 入力モード

- **非表示モード**: モールス信号のみで学習（上級者向け）
- **表示モード**: 入力文字を表示しながら学習（初心者向け）

#### テーマ

- **ライトモード**: 明るい環境向け
- **ダークモード**: 暗い環境・夜間練習向け

## 📊 進捗管理（コッホ法）

以下はコッホ法トレーニング（koch.html）の進捗管理機能です。

### レッスン進捗

- **現在レッスン**: 最後に合格したレッスン
- **累計練習時間**: 全レッスンの合計時間
- **平均正答率**: 全レッスンの平均スコア

### 統計情報

#### 全体統計

- **総練習回数**: セッション数
- **総練習時間**: 累計時間
- **現在の習得文字数**: /40
- **完全習得率**: 全文字の平均正答率

#### 文字別統計

各文字ごとに記録:
- **正答回数**: 正解した回数
- **誤答回数**: 間違えた回数
- **正答率**: パーセンテージ
- **最終練習日**: タイムスタンプ

#### 履歴表示

- **カレンダービュー**: 日別の練習状況
- **グラフ**: 正答率の推移
- **ヒートマップ**: 文字別の正答率マトリックス

### 目標設定

- **日次目標**: 1日の練習時間/レッスン数
- **週次目標**: 1週間の目標レッスン
- **リマインダー**: 練習時間の通知（PWA）

## 🎨 UI/UX設計（コッホ法）

以下はコッホ法トレーニング（koch.html）のUI/UX設計です。

### グループベースキーボードの設計思想

**背景:**

lcwo.netをスマホで使う際、標準的なソフトキーボードでは以下の問題があります：

1. **40文字の表示困難**: 一般的なスマホキーボードは最大30文字程度
2. **文字位置の記憶**: ユーザーは物理キーボードの配置を記憶している
3. **学習段階の混乱**: 未学習の文字まで表示すると入力ミスを誘発

**解決策:**

グループベースキーボードは、これらの問題を以下の方法で解決します：

1. **固定位置の保証**
   - 40文字全てが常に同じ位置に配置
   - 学習進度に関わらず、文字の位置は変わらない
   - ユーザーは一度位置を覚えれば、最後まで同じ感覚で入力可能

2. **段階的な表示**
   - 未学習の文字はグレーアウト（50%不透明度 + タップ無効）
   - 学習済みの文字は通常表示（タップ可能）
   - 視覚的に「使用可能な文字」が明確

3. **柔軟な表示方式**
   - **4グループ固定**: 初心者向け、シンプル
   - **横スクロール**: 上級者向け、全体を俯瞰

4. **カスタマイズ性**
   - グループサイズを画面サイズに応じて調整（3-10文字）
   - 小画面でも大きなボタンサイズを確保

**利点:**

- ✅ **学習効率**: 文字位置を覚える手間が一度だけ
- ✅ **入力速度**: 筋肉記憶により高速入力が可能
- ✅ **視認性**: 使用可能な文字が一目で分かる
- ✅ **スケーラビリティ**: 画面サイズに応じて最適化

### 画面構成

#### 1. ホーム画面

**要素:**
- **現在のレッスン**: 大きく表示、タップで開始
- **進捗サマリー**: 習得文字数、平均正答率
- **今日の目標**: 残り時間/レッスン
- **クイックアクション**:
  - 「続きから始める」
  - 「カスタム練習」
  - 「復習モード」

**レイアウト:**
```
┌─────────────────────┐
│  レッスン 15/40     │
│  ◀ Lesson 15: F ▶  │  ← スワイプで変更
│  [練習開始]          │
├─────────────────────┤
│ 進捗: ■■■■■□□□ 37% │
│ 今日: 2/3レッスン    │
│ 平均: 92%           │
└─────────────────────┘
```

#### 2. レッスン画面

**フェーズ1: 待機中**
```
┌─────────────────────┐
│ Lesson 15: F        │
│ K M U R E S ... F   │ ← 学習済み文字
├─────────────────────┤
│                     │
│   準備中... 2秒     │ ← カウントダウン
│                     │
└─────────────────────┘
```

**フェーズ2: 練習中**
```
┌─────────────────────────────┐
│ 残り: 0:45        [停止]    │
├─────────────────────────────┤
│                             │
│  ・ーー・ ーー                │ ← モールス信号表示
│                             │
│  入力: K M__                │ ← ユーザー入力
│                             │
├─────────────────────────────┤
│ グループベースキーボード     │
│  G1   G2   G3   G4         │
│  [K]  [S]  [L]  [Z]        │
│  [M]  [N]  [W]  [=]        │
│  [U]  [A]  [I]  [F]        │
│  [R]  [P]  [.]  [O]        │
│  [E]  [T]  [J]  [Y]        │
├─────────────────────────────┤
│  [Space] [Backspace] [Enter]│
└─────────────────────────────┘

※ G5-G8はグレーアウト（未学習）
※ 横スクロールで全グループ表示
```

**フェーズ3: 結果表示**
```
┌─────────────────────┐
│ Lesson 15 完了      │
│ ✓ 正答率: 94%       │ ← 合格/不合格表示
├─────────────────────┤
│ 送信: KMUKR MFEMK   │
│ 正答: KMUKR MFEMK   │ ← 一致
│                     │
│ 送信: FKMER         │
│ 正答: FKNER         │ ← N を M と誤答
│       ^^^           │
├─────────────────────┤
│ [次のレッスンへ]     │
│ [もう一度]          │
│ [統計を見る]        │
└─────────────────────┘
```

#### 3. 設定画面

```
┌─────────────────────┐
│ 設定                │
├─────────────────────┤
│ 速度設定            │
│ 文字速度: 25 WPM    │ ← スライダー
│ 実効速度: 10 WPM    │ ← スライダー
├─────────────────────┤
│ 音響設定            │
│ 周波数: 750 Hz      │
│ 音量: 70%           │
│ 開始遅延: 2秒       │
├─────────────────────┤
│ キーボード設定      │
│ グループサイズ: 5   │ ← 3-10文字
│ 表示方式:           │
│ ○ 4グループ固定    │
│ ○ 横スクロール      │
├─────────────────────┤
│ 表示設定            │
│ ○ ダークモード      │
│ □ 入力非表示        │
└─────────────────────┘
```

#### 4. 統計画面

```
┌─────────────────────┐
│ 統計                │
├─────────────────────┤
│ 全体進捗            │
│ ■■■■■■□□□□ 15/40 │
│ 平均正答率: 92%     │
│ 総練習時間: 12h 30m │
├─────────────────────┤
│ カレンダー 2025/10  │
│ 月 火 水 木 金 土 日 │
│  1  2  3  4  5  6  7 │
│ ■  ■     ■  ■      │ ← 練習日
├─────────────────────┤
│ 文字別正答率        │
│ K: 98% ████████░░   │
│ M: 95% ████████░░   │
│ F: 87% ███████░░░   │ ← 弱点
└─────────────────────┘
```

### スマホ最適化

#### タッチ操作

- **大きなボタン**: 最小44x44px（Appleガイドライン）
- **スワイプジェスチャー**:
  - 左右スワイプ: レッスン切り替え
  - 下スワイプ: 設定を開く
- **長押し**: 詳細情報表示

#### キーボード

**物理キーボード対応:**
- アルファベット: 直接入力
- Space: 単語区切り
- Enter: 送信
- Backspace: 削除

**ソフトキーボードUI設計:**

lcwo.netをスマホで使う際の主な問題点を解決するための専用UI設計：

**問題点:**
- 一般的なスマホキーボードでは40文字全てを一度に表示できない
- 文字配置が変わると、ユーザーが位置を覚えられず入力しにくい
- 未学習の文字まで表示すると混乱する

**解決策: グループベースキーボード**

1. **文字のグループ化**
   - コッホ法の40文字を等分してグループ化（デフォルト5文字/グループ）
   - G1: K M U R E
   - G2: S N A P T
   - G3: L W I . J
   - G4: Z = F O Y
   - G5: , V G 5 /
   - G6: Q 9 2 H 3
   - G7: 8 B ? 4 7
   - G8: C 1 D 6 0 X

2. **グリッドレイアウト**
   - 縦方向: 各グループの文字（5行）
   - 横方向: グループ（8列）
   - 合計: 5x8 グリッド（40ボタン）

3. **表示制御**

   **方式A: 学習中心の4グループ表示**
   - 現在学習中のグループをnとする
   - 表示グループ: G(n-3), G(n-2), G(n-1), G(n)
   - 例: Lesson 18（G4のF学習中）
     ```
     表示: G1 G2 G3 G4
           K  S  L  Z
           M  N  W  =
           U  A  I  F
           R  P  .  O
           E  T  J  Y
     ```

   **方式B: 横スクロール式**
   - 全8グループを横スクロールで表示
   - 学習中のグループを自動的に中央に配置
   - スワイプで前後のグループにアクセス

4. **ボタンの状態**
   - **学習済み**: 通常表示（100%不透明度）
   - **未学習**: グレーアウト（50%不透明度 + タップ無効）

5. **グループサイズ設定**
   - ユーザーが設定で変更可能（3-10文字/グループ）
   - 画面サイズに応じた自動推奨
     - 小画面（< 360px幅）: 4文字/グループ
     - 中画面（360-414px幅）: 5文字/グループ（デフォルト）
     - 大画面（> 414px幅）: 6-8文字/グループ
   - グループ数は自動調整（40 / グループサイズ）

6. **ボタンサイズ**
   - 最小44x44px（Appleヒューマンインターフェイスガイドライン）
   - 推奨: 60x60px（タップしやすさ優先）
   - レスポンシブ: 画面幅に応じて自動調整

#### レスポンシブ

- **スマートフォン (< 768px)**: 縦向き最適、片手操作
- **タブレット (768-1024px)**: 横向き対応、2カラムレイアウト
- **デスクトップ (> 1024px)**: キーボード中心、3カラムレイアウト

### 📱 画面遷移フロー

#### v4全体の構成

v4は4つの独立したページで構成され、メニューページから各機能にアクセスします。

```
v4/index.html (メニュー)
    │
    ├─→ vertical.html      (縦振り電鍵練習)
    ├─→ horizontal.html    (横振り電鍵練習)
    ├─→ flashcard.html     (CW略語・Q符号学習)
    └─→ koch.html          (コッホ法トレーニング)
```

**各ページの戻る動作:**
- 各機能ページから「戻る」→ v4/index.html（メニュー）に戻る

---

#### コッホ法トレーニング（koch.html）の画面遷移

koch.htmlは独立したSPAとして、以下の5つの主要画面で構成されます。

#### 画面一覧

| 画面名 | 役割 | 主要アクション |
|-------|------|-------------|
| **ホーム** | レッスン選択・進捗確認 | 練習開始、カスタム練習、復習モード |
| **練習** | モールス受信練習 | 文字入力、送信、停止 |
| **結果** | 練習結果・正答率表示 | 次のレッスン、再挑戦、統計表示 |
| **設定** | 速度・音響・UI設定 | 設定変更、保存 |
| **統計** | 進捗・履歴・文字別統計 | 詳細表示、復習開始 |

#### 遷移図

```
                    ┌──────────┐
                    │  ホーム  │ ← アプリ起動時
                    └─────┬────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
   ┌────────┐        ┌────────┐        ┌────────┐
   │  設定  │◄──────►│  練習  │        │  統計  │
   └────────┘        └───┬────┘        └───┬────┘
        ▲                 │                 │
        │                 ▼                 │
        │            ┌────────┐             │
        └────────────┤  結果  │─────────────┘
                     └────────┘
                          │
                          ▼
                     ┌──────────┐
                     │  ホーム  │ ← ループ
                     └──────────┘
```

#### 詳細な遷移パターン

**1. ホーム画面から**

| アクション | 遷移先 | 補足 |
|----------|--------|------|
| 「練習開始」ボタン | 練習画面 | 現在のレッスンで開始 |
| レッスン番号変更（◀▶） | - | ホーム内でレッスン切り替え |
| 「カスタム練習」ボタン | 練習画面 | カスタムモードで開始 |
| 「復習モード」ボタン | 練習画面 | 誤答文字のみで開始 |
| 統計カードタップ | 統計画面 | 詳細統計を表示 |
| 下スワイプ | 設定画面 | クイック設定 |
| 設定アイコン | 設定画面 | - |

**2. 練習画面から**

| アクション | 遷移先 | 補足 |
|----------|--------|------|
| 練習完了（時間終了） | 結果画面 | 自動遷移 |
| 「停止」ボタン | 結果画面 | 途中結果を表示 |
| 「戻る」ボタン | ホーム画面 | 確認ダイアログ表示 |
| 設定アイコン | 設定画面 | 練習中断 → 設定 |

**3. 結果画面から**

| アクション | 遷移先 | 補足 |
|----------|--------|------|
| 「次のレッスンへ」ボタン | ホーム画面 | レッスン自動進行 |
| 「もう一度」ボタン | 練習画面 | 同じレッスンを再開 |
| 「統計を見る」ボタン | 統計画面 | 今回の結果を含む統計 |
| 「ホームへ戻る」ボタン | ホーム画面 | - |
| 誤答文字タップ | 練習画面 | その文字の復習モード |

**4. 設定画面から**

| アクション | 遷移先 | 補足 |
|----------|--------|------|
| 「戻る」ボタン | 前の画面 | ホーム or 練習 |
| 「保存して閉じる」ボタン | 前の画面 | 設定を保存 |
| 上スワイプ | 前の画面 | - |

**5. 統計画面から**

| アクション | 遷移先 | 補足 |
|----------|--------|------|
| 「戻る」ボタン | ホーム画面 | - |
| 文字タップ（弱点） | 練習画面 | その文字の復習モード |
| 日付タップ | - | その日の詳細を表示（モーダル） |
| 「復習開始」ボタン | 練習画面 | 弱点文字で練習 |

#### ナビゲーション実装

**1. URLベースルーティング**

```
# v4メニュー
/v4/index.html        → メニューページ

# 各機能ページ
/v4/vertical.html     → 縦振り電鍵練習
/v4/horizontal.html   → 横振り電鍵練習
/v4/flashcard.html    → フラッシュカード
/v4/koch.html         → コッホ法（以下SPA内ルーティング）

# koch.html内のルーティング（SPA）
/v4/koch.html#home             → ホーム画面
/v4/koch.html#lesson/15        → レッスン15の練習画面
/v4/koch.html#result           → 結果画面
/v4/koch.html#settings         → 設定画面
/v4/koch.html#stats            → 統計画面
```

**2. 戻るボタンの動作**

- **ブラウザバック**: history APIで前の画面に戻る
- **画面内「戻る」ボタン**: 論理的な前画面に遷移
  - 練習 → ホーム
  - 結果 → ホーム
  - 設定 → 呼び出し元（ホーム or 練習）
  - 統計 → ホーム

**3. 状態管理**

```typescript
interface AppState {
  currentScreen: 'home' | 'lesson' | 'result' | 'settings' | 'stats';
  previousScreen: string | null;
  currentLesson: number;
  practiceMode: 'standard' | 'custom' | 'review';
  selectedChars?: string[];  // カスタム/復習モード用
}
```

**4. 遷移アニメーション**

- **スライド**: 前進時は右から左、後退時は左から右
- **フェード**: 設定・統計画面はフェードイン/アウト
- **所要時間**: 300ms（スムーズかつ高速）

```typescript
// 遷移例
function navigateToLesson(lessonNum: number) {
  history.pushState({ screen: 'lesson', lesson: lessonNum }, '', '#lesson/' + lessonNum);
  slideTransition('left'); // 右から左にスライド
  renderLessonScreen(lessonNum);
}

function navigateBack() {
  history.back();
  slideTransition('right'); // 左から右にスライド
}
```

**5. 確認ダイアログ**

練習中に戻るボタンを押した場合、進捗が失われる可能性があるため確認:

```
┌─────────────────────┐
│ 練習を中断しますか？  │
├─────────────────────┤
│ 進行中の練習は      │
│ 記録されません。     │
├─────────────────────┤
│ [キャンセル] [中断]  │
└─────────────────────┘
```

#### ショートカット・ジェスチャー

| 操作 | 画面 | 動作 |
|-----|------|------|
| **下スワイプ** | ホーム | 設定を開く |
| **上スワイプ** | 設定 | 設定を閉じる |
| **左右スワイプ** | ホーム | レッスン切り替え |
| **ESCキー** | 全画面 | 前の画面に戻る |
| **Spaceキー** | ホーム | 練習開始 |
| **Enterキー** | 練習 | 送信 |

## 📁 ファイル構成

```
v4/
├── README.md                   # このファイル
│
├── index.html                  # メニューページ (本番用・ビルド済み)
├── vertical.html               # 縦振り電鍵 (本番用・ビルド済み)
├── horizontal.html             # 横振り電鍵 (本番用・ビルド済み)
├── flashcard.html              # フラッシュカード (本番用・ビルド済み)
├── koch.html                   # コッホ法 (本番用・ビルド済み)
│
└── src/                        # 開発環境
    ├── menu/                   # メニューページ
    │   ├── index.html
    │   ├── main.ts
    │   └── style.css
    │
    ├── vertical/               # 縦振り電鍵
    │   ├── index.html
    │   ├── main.ts
    │   ├── key-simulator.ts    # 縦振り電鍵シミュレーション
    │   ├── audio-system.ts     # v2から継承
    │   ├── morse-code.ts       # v2から継承
    │   └── style.css
    │
    ├── horizontal/             # 横振り電鍵
    │   ├── index.html
    │   ├── main.ts
    │   ├── key-simulator.ts    # 横振り電鍵シミュレーション
    │   ├── audio-system.ts     # v2から継承
    │   ├── morse-code.ts       # v2から継承
    │   └── style.css
    │
    ├── flashcard/              # フラッシュカード
    │   ├── index.html
    │   ├── main.ts
    │   ├── flashcard-system.ts # v3から移植
    │   ├── tag-filter.ts       # v3から移植
    │   ├── exam-mode.ts        # v3から移植
    │   └── style.css
    │
    ├── koch/                   # コッホ法トレーニング
    │   ├── index.html
    │   ├── main.ts             # エントリーポイント
    │   ├── koch-lesson.ts      # レッスン管理・文字生成
    │   ├── audio-system.ts     # v2から継承
    │   ├── morse-code.ts       # v2から継承
    │   ├── input-handler.ts    # ユーザー入力処理
    │   ├── keyboard-ui.ts      # グループベースキーボードUI
    │   ├── result-analyzer.ts  # 正答率計算・誤答分析
    │   ├── statistics.ts       # 統計データ管理
    │   ├── settings.ts         # 設定管理・LocalStorage
    │   ├── ui-controls.ts      # UI制御・画面遷移
    │   ├── koch-sequence.ts    # 40文字の学習順序定義
    │   └── style.css
    │
    ├── shared/                 # 共通モジュール
    │   ├── audio-system.ts     # モールス音声生成（共通）
    │   ├── morse-code.ts       # モールス符号変換（共通）
    │   └── utils.ts            # ユーティリティ
    │
    ├── package.json            # 依存関係定義
    ├── tsconfig.json           # TypeScript設定
    └── vite.config.ts          # Viteビルド設定（マルチページ対応）
```

## 🛠️ 開発予定

### Phase 1: MVP（基本機能）

#### 1. メニューページ（v4/index.html）
- [ ] 4つの機能へのリンク
- [ ] シンプルなカード型UI
- [ ] 各機能の簡単な説明

#### 2. 縦振り電鍵練習（vertical.html）
- [ ] v2からの機能移植
  - [ ] 縦振り電鍵シミュレーション（マウス/タッチ操作）
  - [ ] リアルタイムモールス音声再生
  - [ ] 入力した符号の表示・変換
- [ ] UI改善
  - [ ] スマホ最適化（タッチ操作）
  - [ ] レスポンシブデザイン

#### 3. 横振り電鍵練習（horizontal.html）
- [ ] v2からの機能移植
  - [ ] 横振り電鍵シミュレーション（左右操作）
  - [ ] リアルタイムモールス音声再生
  - [ ] 入力した符号の表示・変換
- [ ] UI改善
  - [ ] スマホ最適化（タッチ操作）
  - [ ] レスポンシブデザイン

#### 4. CW略語・Q符号学習（flashcard.html）
- [ ] v3からの機能移植
  - [ ] flashcard.tsvデータ読み込み
  - [ ] タグベースフィルタリング
  - [ ] フラッシュカード学習モード
  - [ ] 試験モード（ランダム出題）
  - [ ] 正答率記録・統計表示
- [ ] LocalStorage統合
  - [ ] 学習進捗の保存
  - [ ] 誤答履歴の記録

#### 5. コッホ法トレーニング（koch.html）
- [ ] レッスン1-40の実装
  - [ ] 40文字の学習順序定義
  - [ ] ランダム文字グループ生成（5文字単位）
  - [ ] レッスン選択UI
- [ ] 音声再生システム
  - [ ] v2のAudioSystemクラスを継承
  - [ ] 文字速度・実効速度の計算
  - [ ] Farnsworth法の実装
- [ ] 入力システム
  - [ ] 物理キーボード入力ハンドリング
  - [ ] グループベースソフトキーボードUI
    - [ ] 文字のグループ化ロジック（設定可能なサイズ）
    - [ ] 5xNグリッドレイアウト
    - [ ] 4グループ固定表示モード
    - [ ] 横スクロールモード
    - [ ] 学習状態に応じたボタン状態管理（学習済み/未学習）
  - [ ] バックスペース・確定機能
- [ ] 正誤判定
  - [ ] リアルタイム判定
  - [ ] 正答率計算
  - [ ] 誤答ハイライト表示
- [ ] 進捗管理
  - [ ] LocalStorageによる保存
  - [ ] レッスン別正答率記録
  - [ ] 文字別統計

### Phase 2: 拡張機能

#### コッホ法（koch.html）の機能拡張
- [ ] 統計・可視化
  - [ ] 練習履歴グラフ
  - [ ] カレンダービュー
  - [ ] 文字別正答率ヒートマップ
- [ ] カスタム練習
  - [ ] 任意の文字選択
  - [ ] 復習モード（誤答文字のみ）
  - [ ] 時間制限なし練習
- [ ] 目標設定
  - [ ] 日次/週次目標
  - [ ] 達成度表示
- [ ] UI改善
  - [ ] ダークモード
  - [ ] アニメーション効果
  - [ ] サウンドフィードバック
  - [ ] キーボードUI拡張
    - [ ] グループサイズの自動推奨（画面サイズ検出）
    - [ ] ボタンのハプティックフィードバック（モバイル）
    - [ ] カスタマイズ可能なキー配置

#### フラッシュカード（flashcard.html）の機能拡張
- [ ] モールス音声再生機能
  - [ ] 略語・Q符号をモールス信号で出題
  - [ ] 聴き取り練習モード
- [ ] SRS（間隔反復学習）実装
  - [ ] 忘却曲線に基づく出題タイミング
  - [ ] 習熟度別管理

#### 電鍵練習（vertical.html / horizontal.html）の機能拡張
- [ ] 練習モード追加
  - [ ] 文字列の追従練習（見本に合わせて送信）
  - [ ] 速度測定・評価
- [ ] 統計機能
  - [ ] 送信精度の記録
  - [ ] タイミング分析

### Phase 3: PWA化（全ページ共通）

- [ ] オフライン対応
  - [ ] Service Worker実装
  - [ ] キャッシュ戦略（各HTMLファイル個別）
- [ ] インストール可能
  - [ ] manifest.json作成
  - [ ] アイコン生成（各機能別）
- [ ] 通知機能
  - [ ] 練習リマインダー
  - [ ] 目標達成通知

### Phase 4: 追加コンテンツ

#### コッホ法の追加モード
- [ ] 単語練習モード
  - [ ] 一般的な英単語
  - [ ] アマチュア無線用語
- [ ] 平文練習モード
  - [ ] ニュース記事
  - [ ] 短編テキスト
- [ ] コールサイン練習
  - [ ] 実在のコールサインパターン

#### フラッシュカードの追加コンテンツ
- [ ] QSO会話モード
  - [ ] 実践的な交信シミュレーション
  - [ ] シナリオベース学習

## 📊 データフォーマット

### フラッシュカード用データ (flashcard.tsv)

v3で使用しているflashcard.tsvをそのまま利用します。

```tsv
タグ	使用頻度	略語	英文	和訳
送受,制御	5	[BK]	Break	送受交代せよ
確認,返答,疑問	4	QSL?	Can you acknowledge receipt?	受信確認できますか？
```

**フォーマット:**
- タブ区切り（TSV形式）
- タグ: カンマ区切り（複数タグ対応）
- 使用頻度: 1-5（学習優先度）

### コッホ法: 学習順序定義 (koch-sequence.ts)

```typescript
export const KOCH_SEQUENCE = [
  { lesson: 1, char: 'K', type: 'alpha', morse: '-·-' },
  { lesson: 1, char: 'M', type: 'alpha', morse: '--' },
  { lesson: 2, char: 'U', type: 'alpha', morse: '··-' },
  { lesson: 3, char: 'R', type: 'alpha', morse: '·-·' },
  // ... 40文字分
  { lesson: 40, char: 'X', type: 'alpha', morse: '-··-' },
];

export const LESSON_CHARS = {
  1: ['K', 'M'],
  2: ['K', 'M', 'U'],
  3: ['K', 'M', 'U', 'R'],
  // ... 40レッスン分
};
```

### コッホ法: 統計データ (LocalStorage)

```typescript
interface Statistics {
  lessons: {
    [lessonNum: number]: {
      attempts: number;        // 試行回数
      bestAccuracy: number;    // 最高正答率
      lastAttempt: number;     // 最終練習日（Unix timestamp）
      totalTime: number;       // 累計時間（秒）
    };
  };
  characters: {
    [char: string]: {
      correct: number;         // 正答回数
      incorrect: number;       // 誤答回数
      accuracy: number;        // 正答率
      lastPracticed: number;   // 最終練習日
    };
  };
  overall: {
    totalSessions: number;     // 総セッション数
    totalTime: number;         // 総練習時間（秒）
    currentLesson: number;     // 現在のレッスン
    completedLessons: number;  // 完了レッスン数
  };
}
```

### コッホ法: 設定データ (LocalStorage)

```typescript
interface Settings {
  speed: {
    characterSpeed: number;    // 文字速度 (WPM)
    effectiveSpeed: number;    // 実効速度 (WPM)
  };
  audio: {
    frequency: number;         // 周波数 (Hz)
    volume: number;            // 音量 (0-1)
    startDelay: number;        // 開始遅延（秒）
  };
  keyboard: {
    groupSize: number;         // グループサイズ (3-10文字)
    displayMode: 'fixed' | 'scroll';  // 表示方式
    // fixed: 4グループ固定表示
    // scroll: 横スクロール式
  };
  display: {
    theme: 'light' | 'dark';   // テーマ
    showInput: boolean;        // 入力表示
  };
  goals: {
    dailyMinutes: number;      // 日次目標（分）
    dailyLessons: number;      // 日次目標（レッスン数）
  };
}
```

## 📋 技術スタック

| 技術 | バージョン | 用途 |
|------|-----------|------|
| TypeScript | 5.9.3 | 型安全な開発 |
| Vite | 7.1.9 | ビルドツール |
| vite-plugin-singlefile | - | 単一HTMLファイル化 |
| Web Audio API | - | モールス信号音声生成 |
| LocalStorage API | - | 進捗・設定の永続化 |
| Service Worker API | - | PWA・オフライン対応 |

## 📚 v2/v3との違い

| 項目 | v2 | v3 | v4 |
|------|----|----|-----|
| **構成** | 単一ページ | 単一ページ | 4機能の統合版 |
| **電鍵練習** | 縦振り・横振り統合 | なし | 機能別に分離（vertical.html / horizontal.html） |
| **略語学習** | なし | フラッシュカード | v3機能を移植（flashcard.html） |
| **体系的学習** | なし | なし | コッホ法40文字（koch.html） |
| **進捗管理** | なし | あり（略語のみ） | 各機能で独立管理 |
| **ページ構成** | 1ファイル | 1ファイル | 5ファイル（メニュー + 4機能） |
| **技術スタック** | TypeScript + Vite | TypeScript + Vite | TypeScript + Vite（マルチページ） |
| **対象者** | 練習者 | 略語学習者 | 初心者〜上級者（全段階） |

### v4の特徴

- **統合**: v2とv3の機能を全て統合し、さらにコッホ法を追加
- **独立性**: 各機能が独立したページとして動作
- **スケーラビリティ**: 将来的な機能追加が容易
- **再利用性**: 共通モジュール（audio-system, morse-code）を全機能で共有

## 🌐 ブラウザ互換性

- Chrome/Edge: ✅ 完全対応
- Firefox: ✅ 完全対応
- Safari: ✅ 対応 (一部制限あり)
- Mobile Safari (iOS): ✅ PWA対応
- Chrome Mobile (Android): ✅ PWA対応

## 🎓 学習のヒント（コッホ法）

以下はコッホ法トレーニングの効果的な学習方法です。

### 効果的な練習方法

1. **毎日継続**: 短時間でも毎日練習（15-30分推奨）
2. **速度は維持**: 文字速度は20-25 WPMを保つ
3. **実効速度を徐々に上げる**: 慣れてきたら1-2 WPMずつ上げる
4. **90%を目標**: 急がず確実に習得
5. **弱点克服**: 統計で誤答の多い文字を集中練習

### 挫折しないために

- **焦らない**: 個人差があるので自分のペースで
- **休憩を取る**: 疲れたら無理せず休憩
- **目標設定**: 小さな目標を立てて達成感を得る
- **復習**: 時々前のレッスンに戻って復習

### 上達の目安

- **Lesson 10 (10文字)**: 1-2週間
- **Lesson 20 (20文字)**: 1-2ヶ月
- **Lesson 30 (30文字)**: 2-3ヶ月
- **Lesson 40 (40文字完全習得)**: 3-6ヶ月

※個人差があります。焦らず継続することが重要です。

## 📖 参考資料

### コッホ法関連
- [lcwo.net - Learn CW Online](https://lcwo.net/)
- [Koch Method - Wikipedia](https://en.wikipedia.org/wiki/Koch_method)
- [Farnsworth spacing - Wikipedia](https://en.wikipedia.org/wiki/Morse_code#Farnsworth_timing)
- [ARRL - Learning Morse Code](http://www.arrl.org/learning-morse-code)

### モールス符号一般
- [International Morse Code - Wikipedia](https://en.wikipedia.org/wiki/Morse_code)
- [JARL - モールス符号について](http://www.jarl.org/)（日本アマチュア無線連盟）
