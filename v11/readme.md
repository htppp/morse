# v11 - タイミング評価機能追加版

**作成日**: 2025-10-15
**更新日**: 2025-10-22
**基盤**: v10（GUI/エンジン分離版）
**目的**: モールス信号の練習において、タイミング精度を可視化・評価する機能を追加

---

## 概要

v11は、v10の全機能を維持しつつ、以下の評価機能を追加します。

### v10からの主な追加機能

1. **縦振り電鍵のタイミング評価**
   - 短点(dot)入力の押下時間精度評価
   - 長点(dash)入力の押下時間精度評価
   - リアルタイムフィードバック表示
   - 統計情報の表示

2. **横振り電鍵のタイミング評価**
   - 文字間区切り(character gap)の無入力時間精度評価
   - 単語間区切り(word gap)の無入力時間精度評価
   - リアルタイムフィードバック表示
   - 統計情報の表示
   - **タイミング図（PlantUML風）**: パドル入力状態と出力信号の可視化
   - **スクイーズ区間の表示**: Iambic動作時のスクイーズ操作を視覚的に確認
   - **無入力期間の表示**: 文字間・単語間のギャップを視覚的に確認
   - **自動リセット機能**: 長時間無入力後のタイミング図自動クリア

---

## 機能仕様

### 1. 縦振り電鍵のタイミング評価機能

#### 1.1 押下時間の記録

**対象**:
- 短点(dot)の押下時間
- 長点(dash)の押下時間

**記録内容**:
- 要素タイプ（dot/dash）
- 実際の押下時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）：正の値は長すぎる、負の値は短すぎる
- タイムスタンプ

#### 1.2 精度計算方法

**精度の計算**:
- 理論値との誤差の割合から計算
- 100% = 完璧、0% = 理論値から大きく離れている

**評価基準**:
- **90%以上**: 優秀（緑色表示）
- **70-89%**: 良好（黄色表示）
- **50-69%**: 要改善（オレンジ色表示）
- **50%未満**: 要練習（赤色表示）

#### 1.3 リアルタイムフィードバック

**表示内容**（各キー入力後に表示）:
```
最新の入力:
  要素: "." (dot)
  押下時間: 62ms (理論値: 60ms)
  精度: 97%
  誤差: +2ms (やや長い)
```

**視覚的フィードバック**:
- 精度に応じた色分け（緑/黄/オレンジ/赤）
- プログレスバー表示
- アニメーション効果（精度が高い場合は良いフィードバック）

#### 1.4 統計情報

**表示内容**（セッション全体の統計）:
```
=== タイミング統計 ===
総入力数: 45回

■ 短点(dot) - 30回
  平均精度: 87%
  平均誤差: +8ms (やや長い)
  標準偏差: 12ms
  最高精度: 98% / 最低精度: 65%

■ 長点(dash) - 15回
  平均精度: 82%
  平均誤差: +15ms (やや長い)
  標準偏差: 18ms
  最高精度: 95% / 最低精度: 58%

■ 全体
  平均精度: 85%
```

**統計項目**:
- 入力回数
- 平均精度（%）
- 平均誤差（ms）
- 標準偏差（ms）
- 最高精度 / 最低精度（%）

#### 1.5 UI設計

**レイアウト**:
```
┌─────────────────────────────────────┐
│ 縦振り電鍵練習（タイミング評価付き） │
├─────────────────────────────────────┤
│                                     │
│   ┌─────────────────────────┐      │
│   │   モールス信号表示       │      │
│   │   [.-] E                │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   最新の入力評価         │      │
│   │   要素: "." (dot)        │      │
│   │   押下時間: 62ms         │      │
│   │   理論値: 60ms           │      │
│   │   精度: 97% ████████░░  │      │
│   │   誤差: +2ms (やや長い)  │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   統計情報               │      │
│   │   [詳細を表示/非表示]    │      │
│   └─────────────────────────┘      │
│                                     │
│   [電鍵ボタン]                      │
│   [クリア] [統計リセット] [戻る]    │
└─────────────────────────────────────┘
```

**新規追加UI要素**:
1. **最新の入力評価パネル**: 直前の入力の詳細情報を表示
2. **統計情報パネル**: セッション全体の統計を表示
3. **統計リセットボタン**: 統計データをクリア
4. **評価グラフ（オプション）**: 時系列での精度推移をグラフ表示

---

### 2. 横振り電鍵のタイミング評価機能

#### 2.1 無入力時間の記録

**対象**:
- 文字間区切り(character gap)の無入力時間
- 単語間区切り(word gap)の無入力時間

**記録内容**:
- ギャップタイプ（文字間/単語間）
- 実際のギャップ時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）
- タイムスタンプ

#### 2.2 ギャップ検出方法

**文字間ギャップ（character gap）の検出**:
- 最後の要素（dot/dash）送信終了時刻を記録
- 次の要素送信開始時刻との差分を計算
- 差分が `charGap * 0.8` 以上 `wordGap * 0.8` 未満の場合、文字間ギャップとして記録

**語間ギャップ（word gap）の検出**:
- 最後の要素送信終了時刻を記録
- 次の要素送信開始時刻との差分を計算
- 差分が `wordGap * 0.8` 以上の場合、語間ギャップとして記録

#### 2.3 リアルタイムフィードバック

**表示内容**（各ギャップ検出後に表示）:
```
最新のギャップ評価:
  タイプ: 文字間区切り (character gap)
  無入力時間: 242ms (理論値: 240ms)
  精度: 99%
  誤差: +2ms (ほぼ完璧)
```

#### 2.4 統計情報

**表示内容**:
```
=== ギャップタイミング統計 ===

■ 文字間区切り - 25回
  平均精度: 88%
  平均誤差: +12ms (やや長い)
  標準偏差: 18ms
  最高精度: 99% / 最低精度: 72%

■ 単語間区切り - 8回
  平均精度: 85%
  平均誤差: +25ms (やや長い)
  標準偏差: 30ms
  最高精度: 96% / 最低精度: 68%

■ 全体
  平均精度: 87%
```

**統計項目**:
- 検出回数
- 平均精度（%）
- 平均誤差（ms）
- 標準偏差（ms）
- 最高精度 / 最低精度（%）

#### 2.5 タイミング図機能

**タイミングチャート（PlantUML風）**:
直前の1文字について、以下の情報を可視化します。

**表示内容**:
1. **Dit入力ライン**: 左パドル（Dit）の押下状態（High/Low）
2. **Dash入力ライン**: 右パドル（Dash）の押下状態（High/Low）
3. **出力ライン**: 実際に送信されたモールス信号要素（・/-）
4. **スクイーズ区間**: 両方のパドルが同時押しされている期間（オレンジ色）
5. **無入力期間（Gap）**: 両方のパドルが解放されている期間（青色）
6. **時間軸**: 相対時刻の目盛り表示

**デバッグ情報**:
- パドル入力イベント（相対時刻）: すべてのパドル押下/解放イベント
- スクイーズ区間: スクイーズのON/OFF時刻と継続時間
- 無入力期間: 無入力のON/OFF時刻と継続時間

**自動リセット機能**:
- 単語区切りの理論値の2倍以上の無入力期間後、タイミング図を自動クリア
- これにより、長時間の休憩後も見やすいタイミング図を維持

#### 2.6 UI設計

**レイアウト**:
```
┌─────────────────────────────────────┐
│ 横振り電鍵練習（タイミング評価付き） │
├─────────────────────────────────────┤
│                                     │
│   ┌─────────────────────────┐      │
│   │   モールス信号表示       │      │
│   │   .- / -.-              │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   タイミング図（直前の1文字） │  │
│   │   ┌─────────────────┐   │      │
│   │   │ Dit入力  ▔▔▁▁▔▁  │   │      │
│   │   │ Dash入力 ▁▁▔▔▁▁  │   │      │
│   │   │ 出力     ▁▔▁▔▁▁  │   │      │
│   │   │ [Squeeze][Gap]   │   │      │
│   │   │ 0ms  100ms  200ms│   │      │
│   │   └─────────────────┘   │      │
│   │   デバッグ情報:          │      │
│   │   - パドル入力イベント   │      │
│   │   - スクイーズ区間       │      │
│   │   - 無入力期間           │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   スペーシング評価       │      │
│   │   平均精度: 88%          │      │
│   │   平均誤差: +12ms        │      │
│   │   評価数: 25             │      │
│   │   ┌───────────────┐     │      │
│   │   │ 文字間 / 単語間 │     │      │
│   │   └───────────────┘     │      │
│   └─────────────────────────┘      │
│                                     │
│   [左パドル] [右パドル]             │
│   [クリア] [統計リセット] [戻る]    │
└─────────────────────────────────────┘
```

---

## 実装計画

### Phase 1: タイミング評価エンジンの実装（Week 1）

#### 1.1 morse-engineライブラリへの統合準備
- [ ] v10のmorse-engineライブラリ構造の確認
- [ ] タイミング評価モジュールの設計
  - lib/src/trainers/ 配下に統合
  - 既存のvertical-key.ts、horizontal-key.tsとの連携

#### 1.2 共通モジュール作成（lib/src/core/）
- [ ] timing-evaluator.ts: タイミング評価の共通ロジック
  - 精度計算
  - 誤差計算
  - 記録データの型定義
  - 統計情報の型定義

#### 1.3 統計計算モジュール（lib/src/core/）
- [ ] statistics.ts: 統計計算ロジック
  - 平均値計算
  - 標準偏差計算
  - 最高/最低値検索
  - 統計情報生成

#### 1.4 テスト作成（lib/test/）
- [ ] タイミング評価機能のテスト
- [ ] 統計計算機能のテスト
- 目標カバレッジ: 90%以上（v10の98.94%を維持）

### Phase 2: 縦振り電鍵への統合（Week 2）

#### 2.1 morse-engineライブラリの拡張（lib/src/trainers/）
- [ ] vertical-key.tsの拡張
  - タイミング評価機能の統合
  - キー入力記録機能
  - 最新記録取得API
  - 統計情報取得API
  - イベントコールバックの追加（onTimingEvaluated）

#### 2.2 GUIアプリケーションの修正（app/src/ui/views/）
- [ ] VerticalKeyView.tsの修正
  - morse-engineの新APIを利用
  - 最新の評価結果を表示に反映
  - 統計情報の更新

#### 2.3 UI実装（app/src/ui/views/）
- [ ] 評価パネルのスタイル追加
- [ ] リアルタイムフィードバック表示
- [ ] 統計情報パネル
- [ ] 統計リセットボタン

#### 2.4 テスト作成
- [ ] morse-engineライブラリ側のテスト（lib/test/）
  - 縦振り電鍵評価機能のユニットテスト
  - 目標カバレッジ: 90%以上
- [ ] GUIアプリケーション側のテスト（app/e2e/）
  - E2Eテスト追加（タイミング評価機能の動作確認）

### Phase 3: 横振り電鍵への統合（Week 3）

#### 3.1 morse-engineライブラリの拡張（lib/src/trainers/）
- [ ] horizontal-key.tsの拡張
  - タイミング評価機能の統合（ギャップ検出）
  - 要素送信完了時の処理
  - 次要素開始時の処理
  - ギャップ記録機能
  - 最新記録取得API
  - 統計情報取得API
  - イベントコールバックの追加（onGapEvaluated）

#### 3.2 GUIアプリケーションの修正（app/src/ui/views/）
- [ ] HorizontalKeyView.tsの修正
  - morse-engineの新APIを利用
  - 最新の評価結果を表示に反映
  - 統計情報の更新

#### 3.3 UI実装（app/src/ui/views/）
- [ ] 評価パネルのスタイル追加
- [ ] リアルタイムフィードバック表示
- [ ] 統計情報パネル
- [ ] 統計リセットボタン

#### 3.4 テスト作成
- [ ] morse-engineライブラリ側のテスト（lib/test/）
  - 横振り電鍵評価機能のユニットテスト
  - 目標カバレッジ: 90%以上
- [ ] GUIアプリケーション側のテスト（app/e2e/）
  - E2Eテスト追加（タイミング評価機能の動作確認）

### Phase 4: 統合テストとドキュメント（Week 4）

#### 4.1 統合テスト
- [ ] v10との互換性確認（全機能が正常動作するか）
- [ ] タイミング評価機能の精度検証
- [ ] パフォーマンステスト
- [ ] E2Eテストの追加（タイミング評価機能のテスト）

#### 4.2 ドキュメント作成
- [ ] ユーザーマニュアル（タイミング評価機能の使い方）
- [ ] 開発者ドキュメント（拡張方法）
- [ ] API.mdの更新（morse-engineライブラリの新機能）

#### 4.3 品質保証
- [ ] v10との動作比較
- [ ] 全テスト成功確認（目標: 100%）
- [ ] カバレッジ確認（目標: 90%以上、v10の98.94%を維持）
- [ ] E2Eテスト成功確認（v10の39/39を維持 + タイミング評価機能のテスト）

---

## 技術仕様

### データ構造

#### キー押下記録（縦振り電鍵用）
- 要素タイプ（dot/dash）
- 実際の押下時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）
- タイムスタンプ

#### ギャップ記録（横振り電鍵用）
- ギャップタイプ（文字間/単語間）
- 実際のギャップ時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）
- タイムスタンプ

#### タイミング統計情報
- 総記録数
- 平均精度（%）
- 平均誤差（ms）
- 標準偏差（ms）
- 最高精度（%）
- 最低精度（%）

### ストレージ仕様

**LocalStorageキー**:
- `v11.vertical.timingRecords`: 縦振り電鍵のタイミング記録（最新100件）
- `v11.horizontal.gapRecords`: 横振り電鍵のギャップ記録（最新100件）
- `v11.settings.showTimingEvaluation`: タイミング評価表示の有効/無効

**v10との互換性**:
- v10の設定キー（`v8.*`）との互換性を維持
- v11独自の設定は`v11.*`プレフィックスを使用

**記録数の制限**:
- 最新100件のみ保存（古いデータは自動削除）
- メモリ使用量を抑制

---

## 品質目標

| 項目 | 目標 |
|------|------|
| テストカバレッジ（新規コード） | 85%以上 |
| テストカバレッジ（全体） | 90%以上（v10: 98.94%を維持） |
| 全テスト成功率 | 100% |
| v10との機能互換性 | 100% |
| E2Eテスト成功率 | 100%（v10: 39/39を維持） |
| パフォーマンス影響 | 5%以内 |

---

## v10との互換性

### 保持される機能
- ✅ v10の全機能を完全維持
- ✅ GUI/エンジン分離アーキテクチャ
- ✅ morse-engineライブラリの活用
- ✅ 設定の互換性（LocalStorageキーはv8/v9/v10と共通）
- ✅ 高品質テスト基盤（ユニットテスト344件、E2Eテスト39件）

### 追加される機能
- ✨ タイミング評価機能（ON/OFF切り替え可能）
- ✨ 統計情報表示
- ✨ リアルタイムフィードバック
- ✨ タイミング評価モジュール（morse-engineライブラリに統合）

### 変更されない機能
- morse-engineライブラリのコアロジック
- モールス符号変換ロジック
- 音声生成ロジック
- 基本的なUI/UX

---

## 利用例

### 縦振り電鍵での練習

1. 縦振り電鍵練習画面を開く
2. スペースキーまたは画面タップで入力
3. 各入力後、リアルタイムで精度が表示される
4. セッション終了後、統計情報で自分の傾向を確認

**期待される効果**:
- 短点と長点のタイミングが正確になる
- 理論値との差を意識した練習ができる
- 統計情報で弱点を把握できる

### 横振り電鍵での練習

1. 横振り電鍵練習画面を開く
2. パドルを操作してモールス信号を送信
3. 文字間・語間のギャップが適切かリアルタイムで確認
4. セッション終了後、統計情報で自分の傾向を確認

**期待される効果**:
- 文字間・語間の区切りが正確になる
- 理論値との差を意識した練習ができる
- リズム感が向上する

---

## 今後の拡張可能性

### Phase 5: 高度な分析機能（将来実装）

- [ ] **時系列グラフ**: 精度の推移をグラフ表示
- [ ] **ヒートマップ**: 時間帯別の精度分布
- [ ] **学習曲線**: セッション回数と精度の相関
- [ ] **エクスポート機能**: 統計データをCSVでエクスポート

### Phase 6: AI支援機能（将来実装）

- [ ] **パターン認識**: 苦手なタイミングパターンを自動検出
- [ ] **パーソナライズ**: ユーザーごとの最適な練習メニュー提案
- [ ] **リアルタイムコーチング**: 入力中のガイド表示

---

**作成日**: 2025-10-15
**最終更新**: 2025-10-22
**ベース**: v10（GUI/エンジン分離版）
**目標**: タイミング評価機能の実装、練習効率の向上

## v10からの主な変更点

### アーキテクチャ
- v10のGUI/エンジン分離アーキテクチャを継承
- タイミング評価モジュールをmorse-engineライブラリに統合
- 既存のトレーナーモジュール（vertical-key、horizontal-key）を拡張

### 技術スタック
- **ベースライブラリ**: morse-engine（v10のmorse-engineライブラリを拡張）
- **フロントエンド**: TypeScript + Vite 7.1.10（v10と同じ）
- **テスト**:
  - ユニットテスト: Vitest（v10: 344テスト、98.94%カバレッジ → v11: 維持・拡張）
  - E2Eテスト: Playwright 1.56.1（v10: 39テスト → v11: タイミング評価機能のテスト追加）

### 品質基準
- v10の高品質を維持（98.94%カバレッジ、E2E 39/39成功）
- タイミング評価機能の追加により、さらなる品質向上を目指す
