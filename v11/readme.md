# v11 - タイミング評価機能追加版

**作成日**: 2025-10-15
**基盤**: v9（リファクタリング版）
**目的**: モールス信号の練習において、タイミング精度を可視化・評価する機能を追加

---

## 概要

v11は、v9の全機能を維持しつつ、以下の評価機能を追加します。

### v9からの主な追加機能

1. **縦振り電鍵のタイミング評価**
   - 短点(dot)入力の押下時間精度評価
   - 長点(dash)入力の押下時間精度評価
   - リアルタイムフィードバック表示
   - 統計情報の表示

2. **横振り電鍵のタイミング評価**
   - 文字間区切り(character gap)の無入力時間精度評価
   - 単語間区切り(word gap)の無入力時間精度評価
   - リアルタイムフィードバック表示
   - 統計情報の表示

---

## 機能仕様

### 1. 縦振り電鍵のタイミング評価機能

#### 1.1 押下時間の記録

**対象**:
- 短点(dot)の押下時間
- 長点(dash)の押下時間

**記録内容**:
- 要素タイプ（dot/dash）
- 実際の押下時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）：正の値は長すぎる、負の値は短すぎる
- タイムスタンプ

#### 1.2 精度計算方法

**精度の計算**:
- 理論値との誤差の割合から計算
- 100% = 完璧、0% = 理論値から大きく離れている

**評価基準**:
- **90%以上**: 優秀（緑色表示）
- **70-89%**: 良好（黄色表示）
- **50-69%**: 要改善（オレンジ色表示）
- **50%未満**: 要練習（赤色表示）

#### 1.3 リアルタイムフィードバック

**表示内容**（各キー入力後に表示）:
```
最新の入力:
  要素: "." (dot)
  押下時間: 62ms (理論値: 60ms)
  精度: 97%
  誤差: +2ms (やや長い)
```

**視覚的フィードバック**:
- 精度に応じた色分け（緑/黄/オレンジ/赤）
- プログレスバー表示
- アニメーション効果（精度が高い場合は良いフィードバック）

#### 1.4 統計情報

**表示内容**（セッション全体の統計）:
```
=== タイミング統計 ===
総入力数: 45回

■ 短点(dot) - 30回
  平均精度: 87%
  平均誤差: +8ms (やや長い)
  標準偏差: 12ms
  最高精度: 98% / 最低精度: 65%

■ 長点(dash) - 15回
  平均精度: 82%
  平均誤差: +15ms (やや長い)
  標準偏差: 18ms
  最高精度: 95% / 最低精度: 58%

■ 全体
  平均精度: 85%
```

**統計項目**:
- 入力回数
- 平均精度（%）
- 平均誤差（ms）
- 標準偏差（ms）
- 最高精度 / 最低精度（%）

#### 1.5 UI設計

**レイアウト**:
```
┌─────────────────────────────────────┐
│ 縦振り電鍵練習（タイミング評価付き） │
├─────────────────────────────────────┤
│                                     │
│   ┌─────────────────────────┐      │
│   │   モールス信号表示       │      │
│   │   [.-] E                │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   最新の入力評価         │      │
│   │   要素: "." (dot)        │      │
│   │   押下時間: 62ms         │      │
│   │   理論値: 60ms           │      │
│   │   精度: 97% ████████░░  │      │
│   │   誤差: +2ms (やや長い)  │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   統計情報               │      │
│   │   [詳細を表示/非表示]    │      │
│   └─────────────────────────┘      │
│                                     │
│   [電鍵ボタン]                      │
│   [クリア] [統計リセット] [戻る]    │
└─────────────────────────────────────┘
```

**新規追加UI要素**:
1. **最新の入力評価パネル**: 直前の入力の詳細情報を表示
2. **統計情報パネル**: セッション全体の統計を表示
3. **統計リセットボタン**: 統計データをクリア
4. **評価グラフ（オプション）**: 時系列での精度推移をグラフ表示

---

### 2. 横振り電鍵のタイミング評価機能

#### 2.1 無入力時間の記録

**対象**:
- 文字間区切り(character gap)の無入力時間
- 単語間区切り(word gap)の無入力時間

**記録内容**:
- ギャップタイプ（文字間/単語間）
- 実際のギャップ時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）
- タイムスタンプ

#### 2.2 ギャップ検出方法

**文字間ギャップ（character gap）の検出**:
- 最後の要素（dot/dash）送信終了時刻を記録
- 次の要素送信開始時刻との差分を計算
- 差分が `charGap * 0.8` 以上 `wordGap * 0.8` 未満の場合、文字間ギャップとして記録

**語間ギャップ（word gap）の検出**:
- 最後の要素送信終了時刻を記録
- 次の要素送信開始時刻との差分を計算
- 差分が `wordGap * 0.8` 以上の場合、語間ギャップとして記録

#### 2.3 リアルタイムフィードバック

**表示内容**（各ギャップ検出後に表示）:
```
最新のギャップ評価:
  タイプ: 文字間区切り (character gap)
  無入力時間: 242ms (理論値: 240ms)
  精度: 99%
  誤差: +2ms (ほぼ完璧)
```

#### 2.4 統計情報

**表示内容**:
```
=== ギャップタイミング統計 ===

■ 文字間区切り - 25回
  平均精度: 88%
  平均誤差: +12ms (やや長い)
  標準偏差: 18ms
  最高精度: 99% / 最低精度: 72%

■ 単語間区切り - 8回
  平均精度: 85%
  平均誤差: +25ms (やや長い)
  標準偏差: 30ms
  最高精度: 96% / 最低精度: 68%

■ 全体
  平均精度: 87%
```

**統計項目**:
- 検出回数
- 平均精度（%）
- 平均誤差（ms）
- 標準偏差（ms）
- 最高精度 / 最低精度（%）

#### 2.5 UI設計

**レイアウト**:
```
┌─────────────────────────────────────┐
│ 横振り電鍵練習（タイミング評価付き） │
├─────────────────────────────────────┤
│                                     │
│   ┌─────────────────────────┐      │
│   │   モールス信号表示       │      │
│   │   .- / -.-              │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   最新のギャップ評価     │      │
│   │   タイプ: 文字間区切り   │      │
│   │   無入力時間: 242ms      │      │
│   │   理論値: 240ms          │      │
│   │   精度: 99% █████████░  │      │
│   │   誤差: +2ms (良好)      │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │   統計情報               │      │
│   │   [詳細を表示/非表示]    │      │
│   └─────────────────────────┘      │
│                                     │
│   [左パドル] [右パドル]             │
│   [クリア] [統計リセット] [戻る]    │
└─────────────────────────────────────┘
```

---

## 実装計画

### Phase 1: タイミング評価エンジンの実装（Week 1）

#### 1.1 共通モジュール作成
- [ ] タイミング評価の共通ロジック
  - 精度計算
  - 誤差計算
  - 記録データの型定義
  - 統計情報の型定義

#### 1.2 統計計算モジュール
- [ ] 統計計算ロジック
  - 平均値計算
  - 標準偏差計算
  - 最高/最低値検索
  - 統計情報生成

#### 1.3 テスト作成
- [ ] タイミング評価機能のテスト
- [ ] 統計計算機能のテスト
- 目標カバレッジ: 90%以上

### Phase 2: 縦振り電鍵への統合（Week 2）

#### 2.1 縦振り電鍵の拡張
- [ ] 縦振り電鍵用評価機能の実装
  - キー入力記録
  - 最新記録取得
  - 統計情報取得

#### 2.2 メイン処理の修正
- [ ] キー解放時に押下時間を評価機能に渡す
- [ ] 最新の評価結果を表示に反映
- [ ] 統計情報の更新

#### 2.3 UI実装
- [ ] 評価パネルのスタイル追加
- [ ] リアルタイムフィードバック表示
- [ ] 統計情報パネル
- [ ] 統計リセットボタン

#### 2.4 テスト作成
- [ ] 縦振り電鍵評価機能のテスト
- 目標カバレッジ: 85%以上

### Phase 3: 横振り電鍵への統合（Week 3）

#### 3.1 横振り電鍵の拡張
- [ ] 横振り電鍵用評価機能の実装
  - 要素送信完了時の処理
  - 次要素開始時の処理
  - ギャップ記録
  - 最新記録取得
  - 統計情報取得

#### 3.2 メイン処理の修正
- [ ] パドル要素送信時にギャップ評価機能を統合
- [ ] 最新の評価結果を表示に反映
- [ ] 統計情報の更新

#### 3.3 UI実装
- [ ] 評価パネルのスタイル追加
- [ ] リアルタイムフィードバック表示
- [ ] 統計情報パネル
- [ ] 統計リセットボタン

#### 3.4 テスト作成
- [ ] 横振り電鍵評価機能のテスト
- 目標カバレッジ: 85%以上

### Phase 4: 統合テストとドキュメント（Week 4）

#### 4.1 統合テスト
- [ ] v9との互換性確認（全機能が正常動作するか）
- [ ] タイミング評価機能の精度検証
- [ ] パフォーマンステスト

#### 4.2 ドキュメント作成
- [ ] ユーザーマニュアル（タイミング評価機能の使い方）
- [ ] 開発者ドキュメント（拡張方法）

#### 4.3 品質保証
- [ ] v9との動作比較
- [ ] 全テスト成功確認（目標: 100%）
- [ ] カバレッジ確認（目標: 70%以上）

---

## 技術仕様

### データ構造

#### キー押下記録（縦振り電鍵用）
- 要素タイプ（dot/dash）
- 実際の押下時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）
- タイムスタンプ

#### ギャップ記録（横振り電鍵用）
- ギャップタイプ（文字間/単語間）
- 実際のギャップ時間（ミリ秒）
- 理論値（ミリ秒）
- 精度（0-100%）
- 誤差（ミリ秒）
- タイムスタンプ

#### タイミング統計情報
- 総記録数
- 平均精度（%）
- 平均誤差（ms）
- 標準偏差（ms）
- 最高精度（%）
- 最低精度（%）

### ストレージ仕様

**LocalStorageキー**:
- `v11.vertical.timingRecords`: 縦振り電鍵のタイミング記録（最新100件）
- `v11.horizontal.gapRecords`: 横振り電鍵のギャップ記録（最新100件）
- `v11.settings.showTimingEvaluation`: タイミング評価表示の有効/無効

**記録数の制限**:
- 最新100件のみ保存（古いデータは自動削除）
- メモリ使用量を抑制

---

## 品質目標

| 項目 | 目標 |
|------|------|
| テストカバレッジ（新規コード） | 85%以上 |
| テストカバレッジ（全体） | 70%以上 |
| 全テスト成功率 | 100% |
| v9との機能互換性 | 100% |
| パフォーマンス影響 | 5%以内 |

---

## v9との互換性

### 保持される機能
- ✅ v9の全機能を完全維持
- ✅ 設定の互換性（LocalStorageキーはv8/v9と共通）
- ✅ PWA対応
- ✅ オフライン動作

### 追加される機能
- ✨ タイミング評価機能（ON/OFF切り替え可能）
- ✨ 統計情報表示
- ✨ リアルタイムフィードバック

### 変更されない機能
- モールス符号変換ロジック
- 音声生成ロジック
- 基本的なUI/UX

---

## 利用例

### 縦振り電鍵での練習

1. 縦振り電鍵練習画面を開く
2. スペースキーまたは画面タップで入力
3. 各入力後、リアルタイムで精度が表示される
4. セッション終了後、統計情報で自分の傾向を確認

**期待される効果**:
- 短点と長点のタイミングが正確になる
- 理論値との差を意識した練習ができる
- 統計情報で弱点を把握できる

### 横振り電鍵での練習

1. 横振り電鍵練習画面を開く
2. パドルを操作してモールス信号を送信
3. 文字間・語間のギャップが適切かリアルタイムで確認
4. セッション終了後、統計情報で自分の傾向を確認

**期待される効果**:
- 文字間・語間の区切りが正確になる
- 理論値との差を意識した練習ができる
- リズム感が向上する

---

## 今後の拡張可能性

### Phase 5: 高度な分析機能（将来実装）

- [ ] **時系列グラフ**: 精度の推移をグラフ表示
- [ ] **ヒートマップ**: 時間帯別の精度分布
- [ ] **学習曲線**: セッション回数と精度の相関
- [ ] **エクスポート機能**: 統計データをCSVでエクスポート

### Phase 6: AI支援機能（将来実装）

- [ ] **パターン認識**: 苦手なタイミングパターンを自動検出
- [ ] **パーソナライズ**: ユーザーごとの最適な練習メニュー提案
- [ ] **リアルタイムコーチング**: 入力中のガイド表示

---

**作成日**: 2025-10-15
**最終更新**: 2025-10-15
**ベース**: v9（リファクタリング版）
**目標**: タイミング評価機能の実装、練習効率の向上
